@using OSHManagement.Extensions
@model OSHManagement.Models.ViewModels.EmployeeViewModel
@{
    ViewData["Title"] = "Create Employee";

    // Build OrgCategory options
    var categoryOptions = new List<OSHManagement.Models.ViewModels.FormSelectOption>
    {
        new OSHManagement.Models.ViewModels.FormSelectOption { Text = "-- Select Category --", Value = "", Selected = true }
    };

    if (ViewBag.OrgCategories != null)
    {
        foreach (var category in (IEnumerable<dynamic>)ViewBag.OrgCategories)
        {
            categoryOptions.Add(new OSHManagement.Models.ViewModels.FormSelectOption
            {
                Text = category.CategoryName,
                Value = category.OrgCategoryId.ToString()
            });
        }
    }

    // Build station options
    var stationOptions = new List<OSHManagement.Models.ViewModels.FormSelectOption>
    {
        new OSHManagement.Models.ViewModels.FormSelectOption { Text = "-- Select Station --", Value = "", Selected = true }
    };

    if (ViewBag.Stations != null)
    {
        foreach (var station in (IEnumerable<dynamic>)ViewBag.Stations)
        {
            stationOptions.Add(new OSHManagement.Models.ViewModels.FormSelectOption
            {
                Text = station.StationName,
                Value = station.StationId.ToString()
            });
        }
    }

    // Build department options
    var departmentOptions = new List<OSHManagement.Models.ViewModels.FormSelectOption>
    {
        new OSHManagement.Models.ViewModels.FormSelectOption { Text = "-- Select Department --", Value = "", Selected = true }
    };

    if (ViewBag.Departments != null)
    {
        foreach (var department in (IEnumerable<dynamic>)ViewBag.Departments)
        {
            departmentOptions.Add(new OSHManagement.Models.ViewModels.FormSelectOption
            {
                Text = department.DepartmentName,
                Value = department.DepartmentId.ToString()
            });
        }
    }

    // Build employee options for HOD and Supervisor
    var employeeOptions = new List<OSHManagement.Models.ViewModels.FormSelectOption>
    {
        new OSHManagement.Models.ViewModels.FormSelectOption { Text = "-- None --", Value = "", Selected = true }
    };

    if (ViewBag.Employees != null)
    {
        foreach (var emp in (IEnumerable<dynamic>)ViewBag.Employees)
        {
            employeeOptions.Add(new OSHManagement.Models.ViewModels.FormSelectOption
            {
                Text = $"{emp.FullName} ({emp.PayrollNo})",
                Value = emp.PayrollNo
            });
        }
    }

    // Configure Form Wizard with 3 Steps (Employment Details removed)
    var wizardConfig = new OSHManagement.Models.ViewModels.FormWizardConfig
    {
        WizardId = "createEmployeeWizard",
        ActionUrl = "/Employee/Create",
        Method = "POST",
        Type = OSHManagement.Models.ViewModels.WizardType.Horizontal,
        CardTitle = "Create New Employee",
        CardSubtitle = "Complete all steps to add a new employee to the system",
        ValidateOnStepChange = true,
        ShowStepNumbers = true,
        ShowProgressBar = true,
        CancelButtonText = "Cancel",
        CancelUrl = "/Employee/Index",

        Steps = new List<OSHManagement.Models.ViewModels.WizardStepConfig>
        {
            // ========== STEP 1: Personal Information ==========
            new OSHManagement.Models.ViewModels.WizardStepConfig
            {
                StepId = "personalInfo",
                Title = "Personal Information",
                Icon = "ri-user-line",
                Description = "Enter employee's personal details and contact information",
                FieldsPerRow = 2,
                FieldColumnClass = "col-md-6",
                Fields = new List<OSHManagement.Models.ViewModels.FormFieldConfig>
                {
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "PayrollNo",
                        PropertyName = nameof(EmployeeViewModel.PayrollNo),
                        Label = "Payroll Number",
                        Type = OSHManagement.Models.ViewModels.FieldType.Text,
                        Required = true,
                        Placeholder = "Enter payroll number",
                        MaxLength = 20,
                        ValidationMessage = "Payroll number is required"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "RollNo",
                        PropertyName = nameof(EmployeeViewModel.RollNo),
                        Label = "Roll Number",
                        Type = OSHManagement.Models.ViewModels.FieldType.Text,
                        Placeholder = "Enter roll number (optional)",
                        MaxLength = 20
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "FirstName",
                        PropertyName = nameof(EmployeeViewModel.FirstName),
                        Label = "First Name",
                        Type = OSHManagement.Models.ViewModels.FieldType.Text,
                        Required = true,
                        Placeholder = "Enter first name",
                        MaxLength = 50,
                        ValidationMessage = "First name is required"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "LastName",
                        PropertyName = nameof(EmployeeViewModel.LastName),
                        Label = "Last Name",
                        Type = OSHManagement.Models.ViewModels.FieldType.Text,
                        Required = true,
                        Placeholder = "Enter last name",
                        MaxLength = 50,
                        ValidationMessage = "Last name is required"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "EmailAddress",
                        PropertyName = nameof(EmployeeViewModel.EmailAddress),
                        Label = "Email Address",
                        Type = OSHManagement.Models.ViewModels.FieldType.Email,
                        Placeholder = "Enter email address",
                        MaxLength = 100,
                        HelpText = "Optional: Used for system notifications"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "PhoneNo",
                        PropertyName = nameof(EmployeeViewModel.PhoneNo),
                        Label = "Phone Number",
                        Type = OSHManagement.Models.ViewModels.FieldType.Tel,
                        Placeholder = "Enter phone number",
                        MaxLength = 20,
                        HelpText = "Optional: Contact number"
                    }
                }
            },

            // ========== STEP 2: Work Assignment ==========
            new OSHManagement.Models.ViewModels.WizardStepConfig
            {
                StepId = "workAssignment",
                Title = "Work Assignment",
                Icon = "ri-building-line",
                Description = "Assign employee to station, department, and specify employment details",
                FieldsPerRow = 2,
                FieldColumnClass = "col-md-6",
                Fields = new List<OSHManagement.Models.ViewModels.FormFieldConfig>
                {
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "OrgCategoryId",
                        PropertyName = "OrgCategoryId",
                        Label = "Organization Category",
                        Type = OSHManagement.Models.ViewModels.FieldType.Select,
                        Options = categoryOptions,
                        HelpText = "Filter stations by category"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "StationId",
                        PropertyName = nameof(EmployeeViewModel.StationId),
                        Label = "Station",
                        Type = OSHManagement.Models.ViewModels.FieldType.Select,
                        Required = true,
                        Options = stationOptions,
                        ValidationMessage = "Station is required"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "DepartmentId",
                        PropertyName = nameof(EmployeeViewModel.DepartmentId),
                        Label = "Department",
                        Type = OSHManagement.Models.ViewModels.FieldType.Select,
                        Options = departmentOptions,
                        HelpText = "Optional: Select department within the station"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "Designation",
                        PropertyName = nameof(EmployeeViewModel.Designation),
                        Label = "Designation / Job Title",
                        Type = OSHManagement.Models.ViewModels.FieldType.Text,
                        Placeholder = "e.g., Safety Officer, Engineer",
                        MaxLength = 50
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "EmployeeType",
                        PropertyName = nameof(EmployeeViewModel.EmployeeType),
                        Label = "Employee Type",
                        Type = OSHManagement.Models.ViewModels.FieldType.Select,
                        Options = new List<OSHManagement.Models.ViewModels.FormSelectOption>
                        {
                            new OSHManagement.Models.ViewModels.FormSelectOption { Text = "-- Select Type --", Value = "" },
                            new OSHManagement.Models.ViewModels.FormSelectOption { Text = "Factory", Value = "Factory" },
                            new OSHManagement.Models.ViewModels.FormSelectOption { Text = "Outsourced", Value = "Outsourced" },
                            new OSHManagement.Models.ViewModels.FormSelectOption { Text = "Casual", Value = "Casual" },
                            new OSHManagement.Models.ViewModels.FormSelectOption { Text = "Contract", Value = "Contract" }
                        }
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "ContractEndDate",
                        PropertyName = nameof(EmployeeViewModel.ContractEndDate),
                        Label = "Contract End Date",
                        Type = OSHManagement.Models.ViewModels.FieldType.Date,
                        HelpText = "Required only for Contract employees"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "EmploymentStatus",
                        PropertyName = nameof(EmployeeViewModel.EmploymentStatus),
                        Label = "Employment Status",
                        Type = OSHManagement.Models.ViewModels.FieldType.Select,
                        Options = new List<OSHManagement.Models.ViewModels.FormSelectOption>
                        {
                            new OSHManagement.Models.ViewModels.FormSelectOption { Text = "Active", Value = "Active", Selected = true },
                            new OSHManagement.Models.ViewModels.FormSelectOption { Text = "Inactive", Value = "Inactive" }
                        }
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "Username",
                        PropertyName = nameof(EmployeeViewModel.Username),
                        Label = "System Username",
                        Type = OSHManagement.Models.ViewModels.FieldType.Text,
                        Placeholder = "Enter username for system access",
                        MaxLength = 50,
                        HelpText = "Optional: Required only if employee needs system access"
                    }
                }
            },

            // ========== STEP 3: Reporting Structure & Roles ==========
            new OSHManagement.Models.ViewModels.WizardStepConfig
            {
                StepId = "reportingStructure",
                Title = "Reporting & Roles",
                Icon = "ri-team-line",
                Description = "Define reporting hierarchy and assign system access roles",
                FieldsPerRow = 1,
                FieldColumnClass = "col-12",
                Fields = new List<OSHManagement.Models.ViewModels.FormFieldConfig>
                {
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "HodPayroll",
                        PropertyName = nameof(EmployeeViewModel.HodPayroll),
                        Label = "Head of Department (HOD)",
                        Type = OSHManagement.Models.ViewModels.FieldType.Select,
                        Options = employeeOptions,
                        HelpText = "Select the department head this employee reports to",
                        CustomCssClass = "col-md-6 d-inline-block pe-2"
                    },
                    new OSHManagement.Models.ViewModels.FormFieldConfig
                    {
                        Name = "SupervisorPayroll",
                        PropertyName = nameof(EmployeeViewModel.SupervisorPayroll),
                        Label = "Direct Supervisor",
                        Type = OSHManagement.Models.ViewModels.FieldType.Select,
                        Options = employeeOptions,
                        HelpText = "Select the direct supervisor for this employee",
                        CustomCssClass = "col-md-6 d-inline-block ps-2"
                    }
                }
            }
        }
    };

    var wizard = wizardConfig.BuildWizard();
}

<!-- Render Wizard -->
<div class="row">
    <div class="col-xl-12">
        <partial name="~/Views/Shared/Components/Wizards/HorizontalFormWizard.cshtml" model="wizard" />
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function() {
            var allStations = @Html.Raw(Json.Serialize(ViewBag.Stations));
            var allDepartments = @Html.Raw(Json.Serialize(ViewBag.Departments));
            var allEmployees = @Html.Raw(Json.Serialize(ViewBag.Employees));
            var allRoles = @Html.Raw(Json.Serialize(ViewBag.Roles));

            var categorySelect = $('#createEmployeeWizard_workAssignment_OrgCategoryId');
            var stationSelect = $('#createEmployeeWizard_workAssignment_StationId');
            var departmentSelect = $('#createEmployeeWizard_workAssignment_DepartmentId');
            var employeeTypeSelect = $('#createEmployeeWizard_workAssignment_EmployeeType');
            var contractEndDateField = $('#createEmployeeWizard_workAssignment_ContractEndDate').closest('.mb-3');
            var hodSelect = $('#createEmployeeWizard_reportingStructure_HodPayroll');
            var supervisorSelect = $('#createEmployeeWizard_reportingStructure_SupervisorPayroll');

            // ============================================
            // Inject Role Selection into Step 3
            // ============================================
            function injectRoleSelection() {
                var step3 = $('#createEmployeeWizard').find('.wizard-step[data-step="3"]');

                // Check if roles already injected
                if (step3.find('#rolesSelectionContainer').length > 0) return;

                var rolesHtml = `
                    <div id="rolesSelectionContainer" class="mt-4">
                        <div class="row">
                            <div class="col-12">
                                <h6 class="mb-3">System Access Roles</h6>
                                <p class="text-muted mb-3">Select one or more roles to grant system access. If no roles are selected, the employee will be assigned the default "Employee" role.</p>
                                <div class="row">`;

                if (allRoles && allRoles.length > 0) {
                    allRoles.forEach(function(role) {
                        rolesHtml += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="form-check card card-body p-3 border">
                                    <input class="form-check-input" type="checkbox" name="SelectedRoles" value="${role.roleId}" id="role_${role.roleId}">
                                    <label class="form-check-label" for="role_${role.roleId}">
                                        <strong>${role.roleName}</strong>
                                        ${role.description ? `<br><small class="text-muted">${role.description}</small>` : ''}
                                    </label>
                                </div>
                            </div>`;
                    });
                } else {
                    rolesHtml += `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="ri-information-line me-2"></i>
                                No roles available. The employee will be assigned the default "Employee" role.
                            </div>
                        </div>`;
                }

                rolesHtml += `
                                </div>
                            </div>
                        </div>
                    </div>`;

                step3.append(rolesHtml);
            }

            // Inject roles when page loads
            injectRoleSelection();

            // ============================================
            // Category → Station Filtering
            // ============================================
            function filterStations() {
                var selectedCategoryId = categorySelect.val();
                var currentSelection = stationSelect.val();

                stationSelect.find('option:not(:first)').remove();

                if (!selectedCategoryId) {
                    // Show all stations
                    allStations.forEach(function(station) {
                        stationSelect.append(
                            $('<option></option>')
                                .val(station.stationId)
                                .text(station.stationName)
                        );
                    });
                } else {
                    // Filter by category
                    var filteredStations = allStations.filter(function(station) {
                        return station.orgCategoryId == selectedCategoryId;
                    });

                    if (filteredStations.length === 0) {
                        stationSelect.append(
                            $('<option></option>')
                                .val('')
                                .text('-- No stations in this category --')
                                .prop('disabled', true)
                        );
                    } else {
                        filteredStations.forEach(function(station) {
                            var option = $('<option></option>')
                                .val(station.stationId)
                                .text(station.stationName);

                            if (station.stationId == currentSelection) {
                                option.prop('selected', true);
                            }

                            stationSelect.append(option);
                        });
                    }
                }

                // Cascade to departments
                filterDepartments();
            }

            categorySelect.on('change', filterStations);

            // ============================================
            // Station → Department Filtering
            // ============================================
            function filterDepartments() {
                var selectedStationId = stationSelect.val();
                var currentSelection = departmentSelect.val();

                departmentSelect.find('option:not(:first)').remove();

                if (!selectedStationId) {
                    // Show all departments
                    allDepartments.forEach(function(department) {
                        departmentSelect.append(
                            $('<option></option>')
                                .val(department.departmentId)
                                .text(department.departmentName)
                        );
                    });
                } else {
                    // Filter by station
                    var filteredDepartments = allDepartments.filter(function(department) {
                        return department.stationId == selectedStationId;
                    });

                    if (filteredDepartments.length === 0) {
                        departmentSelect.append(
                            $('<option></option>')
                                .val('')
                                .text('-- No departments in this station --')
                                .prop('disabled', true)
                        );
                    } else {
                        filteredDepartments.forEach(function(department) {
                            var option = $('<option></option>')
                                .val(department.departmentId)
                                .text(department.departmentName);

                            if (department.departmentId == currentSelection) {
                                option.prop('selected', true);
                            }

                            departmentSelect.append(option);
                        });
                    }
                }

                // Cascade to HOD/Supervisor
                filterSupervisors();
            }

            stationSelect.on('change', filterDepartments);

            // ============================================
            // Station/Department → HOD/Supervisor Filtering
            // ============================================
            function filterSupervisors() {
                var selectedStationId = stationSelect.val();
                var selectedDepartmentId = departmentSelect.val();

                // Filter employees by station or department
                var filteredEmployees = allEmployees;

                if (selectedDepartmentId) {
                    filteredEmployees = allEmployees.filter(function(emp) {
                        return emp.departmentId == selectedDepartmentId;
                    });
                } else if (selectedStationId) {
                    filteredEmployees = allEmployees.filter(function(emp) {
                        return emp.stationId == selectedStationId;
                    });
                }

                // Update HOD dropdown
                var currentHod = hodSelect.val();
                hodSelect.find('option:not(:first)').remove();

                filteredEmployees.forEach(function(emp) {
                    var option = $('<option></option>')
                        .val(emp.payrollNo)
                        .text(emp.fullName + ' (' + emp.payrollNo + ')');

                    if (emp.payrollNo == currentHod) {
                        option.prop('selected', true);
                    }

                    hodSelect.append(option);
                });

                // Update Supervisor dropdown
                var currentSupervisor = supervisorSelect.val();
                supervisorSelect.find('option:not(:first)').remove();

                filteredEmployees.forEach(function(emp) {
                    var option = $('<option></option>')
                        .val(emp.payrollNo)
                        .text(emp.fullName + ' (' + emp.payrollNo + ')');

                    if (emp.payrollNo == currentSupervisor) {
                        option.prop('selected', true);
                    }

                    supervisorSelect.append(option);
                });
            }

            departmentSelect.on('change', filterSupervisors);

            // ============================================
            // EmployeeType → ContractEndDate Visibility
            // ============================================
            function toggleContractEndDate() {
                var employeeType = employeeTypeSelect.val();

                if (employeeType === 'Contract') {
                    contractEndDateField.show();
                } else {
                    contractEndDateField.hide();
                    $('#createEmployeeWizard_workAssignment_ContractEndDate').val('');
                }
            }

            employeeTypeSelect.on('change', toggleContractEndDate);

            // ============================================
            // Role Checkboxes (Add to Step 3 dynamically)
            // ============================================
            function addRoleCheckboxes() {
                var rolesContainer = $('#createEmployeeWizard_reportingStructure .wizard-step-fields');

                if (allRoles && allRoles.length > 0 && rolesContainer.find('.roles-section').length === 0) {
                    var rolesHtml = '<div class="col-12 roles-section">' +
                        '<div class="mb-3">' +
                        '<label class="form-label fw-semibold">Assign Roles</label>' +
                        '<div class="form-text mb-2">Select one or more roles for this employee</div>' +
                        '<div class="row">';

                    allRoles.forEach(function(role) {
                        rolesHtml += '<div class="col-md-6 mb-2">' +
                            '<div class="form-check">' +
                            '<input class="form-check-input employee-role-checkbox" type="checkbox" ' +
                            'name="SelectedRoles" value="' + role.roleId + '" id="role_' + role.roleId + '">' +
                            '<label class="form-check-label" for="role_' + role.roleId + '">' +
                            role.roleName +
                            '</label>' +
                            '</div>' +
                            '</div>';
                    });

                    rolesHtml += '</div></div></div>';

                    rolesContainer.append(rolesHtml);
                }
            }

            // Add roles on step change (listen to wizard step changes)
            $(document).on('click', '.wizard-navigation button', function() {
                setTimeout(function() {
                    var activeStep = $('.wizard-step-container.active');
                    if (activeStep.attr('id') === 'createEmployeeWizard_reportingStructure') {
                        addRoleCheckboxes();
                    }
                }, 100);
            });

            // Also add on initial load if we're on step 3
            setTimeout(function() {
                var activeStep = $('.wizard-step-container.active');
                if (activeStep.attr('id') === 'createEmployeeWizard_reportingStructure') {
                    addRoleCheckboxes();
                }
            }, 500);

            // ============================================
            // AJAX Validation on Blur (Check for Duplicates)
            // ============================================
            var employeeId = 0; // For create, always 0

            // Payroll Number
            $('#createEmployeeWizard_personalInfo_PayrollNo').on('blur', function() {
                var field = $(this);
                var value = field.val();

                if (!value) return;

                $.get('/Employee/CheckPayrollNoUnique', { payrollNo: value, employeeId: employeeId }, function(response) {
                    if (!response.isUnique) {
                        field.addClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                        field.after('<div class="invalid-feedback d-block">Payroll number already exists</div>');
                    } else {
                        field.removeClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                    }
                });
            });

            // Roll Number
            $('#createEmployeeWizard_personalInfo_RollNo').on('blur', function() {
                var field = $(this);
                var value = field.val();

                if (!value) {
                    field.removeClass('is-invalid');
                    field.next('.invalid-feedback').remove();
                    return;
                }

                $.get('/Employee/CheckRollNoUnique', { rollNo: value, employeeId: employeeId }, function(response) {
                    if (!response.isUnique) {
                        field.addClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                        field.after('<div class="invalid-feedback d-block">Roll number already exists</div>');
                    } else {
                        field.removeClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                    }
                });
            });

            // Email Address
            $('#createEmployeeWizard_personalInfo_EmailAddress').on('blur', function() {
                var field = $(this);
                var value = field.val();

                if (!value) {
                    field.removeClass('is-invalid');
                    field.next('.invalid-feedback').remove();
                    return;
                }

                $.get('/Employee/CheckEmailUnique', { emailAddress: value, employeeId: employeeId }, function(response) {
                    if (!response.isUnique) {
                        field.addClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                        field.after('<div class="invalid-feedback d-block">Email address already exists</div>');
                    } else {
                        field.removeClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                    }
                });
            });

            // Phone Number
            $('#createEmployeeWizard_personalInfo_PhoneNo').on('blur', function() {
                var field = $(this);
                var value = field.val();

                if (!value) {
                    field.removeClass('is-invalid');
                    field.next('.invalid-feedback').remove();
                    return;
                }

                $.get('/Employee/CheckPhoneUnique', { phoneNo: value, employeeId: employeeId }, function(response) {
                    if (!response.isUnique) {
                        field.addClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                        field.after('<div class="invalid-feedback d-block">Phone number already exists</div>');
                    } else {
                        field.removeClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                    }
                });
            });

            // ============================================
            // Initial Load
            // ============================================
            filterStations();
            toggleContractEndDate();
            contractEndDateField.hide(); // Hide by default
        });
    </script>
}
