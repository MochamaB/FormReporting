@model FormReporting.Models.ViewModels.Components.DataTableViewModel
@using FormReporting.Models.ViewModels.Components

@*
    DataTable Component - Main Table View

    Features:
    - Search box in header
    - Filter dropdowns (simple)
    - Advanced filter selects (collapsible)
    - Sortable columns
    - Pagination (server-side or AJAX)
    - Bulk actions (optional)
    - Create button
    - AJAX loading with skeleton
    - Responsive design
*@

@{
    var jsonOptions = new System.Text.Json.JsonSerializerOptions 
    { 
        PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase 
    };
    var ajaxColumnsJson = Model.AjaxColumns != null ? System.Text.Json.JsonSerializer.Serialize(Model.AjaxColumns, jsonOptions) : "[]";
    var ajaxParamsJson = Model.AjaxQueryParams != null ? System.Text.Json.JsonSerializer.Serialize(Model.AjaxQueryParams, jsonOptions) : "{}";
}

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap w-100 gap-2">

            @* Left Side: Search & Filters *@
            <div class="d-flex gap-2 flex-wrap align-items-center">

                @* Search Box Component *@
                @if (Model.SearchBox != null)
                {
                    <partial name="~/Views/Shared/Components/DataTable/_SearchBox.cshtml" model="Model.SearchBox" />
                }

                @* Filter Dropdown Components (Simple Filters) *@
                @if (Model.FilterDropdowns != null && Model.FilterDropdowns.Any())
                {
                    foreach (var filterDropdown in Model.FilterDropdowns)
                    {
                        <partial name="~/Views/Shared/Components/DataTable/_FilterDropdown.cshtml" model="filterDropdown" />
                    }
                }

                @* Advanced Filters Toggle Button (Collapsible) *@
                @if (Model.FilterSelects != null && Model.FilterSelects.Any())
                {
                    <button class="btn btn-outline-warning" type="button" data-bs-toggle="collapse"
                            data-bs-target="#advancedFilters_@Model.TableId" aria-expanded="false"
                            aria-controls="advancedFilters_@Model.TableId">
                        <i class="ri-filter-2-line me-1"></i>Advanced Filters
                    </button>
                }
            </div>

            @* Right Side: Action Buttons *@
            <div class="d-flex gap-2 align-items-center">
                @* Bulk Actions (if enabled) - Shows when rows selected *@
                @if (Model.EnableBulkActions && Model.BulkActions != null && Model.BulkActions.Any())
                {
                    <div class="dropdown bulk-actions-dropdown" data-table-id="@Model.TableId" style="display: none;">
                        <button class="btn btn-soft-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="ri-checkbox-multiple-line me-1"></i>Bulk Actions (<span class="selected-count">0</span>)
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            @foreach (var action in Model.BulkActions)
                            {
                                <li>
                                    <a class="dropdown-item bulk-action-btn @(action.ColorClass == "danger" ? "text-danger" : "")" href="#"
                                       data-url="@action.ActionUrl"
                                       data-confirm="@action.RequiresConfirmation.ToString().ToLower()"
                                       data-message="@action.ConfirmationMessage">
                                        @if (!string.IsNullOrEmpty(action.IconClass))
                                        {
                                            <i class="@action.IconClass me-1"></i>
                                        }
                                        @action.Text
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>
                }
                @* View Toggle Buttons *@
                @if (Model.EnableViewToggle)
                {
                    <div class="btn-group" role="group" aria-label="View toggle">
                        <button type="button" class="btn btn-soft-secondary btn-sm view-toggle-btn @(Model.DefaultView == "table" ? "active" : "")" 
                                data-view="table" data-table-id="@Model.TableId" title="Table View">
                            <i class="ri-list-check"></i>
                        </button>
                        <button type="button" class="btn btn-soft-secondary btn-sm view-toggle-btn @(Model.DefaultView == "card" ? "active" : "")" 
                                data-view="card" data-table-id="@Model.TableId" title="Card View">
                            <i class="ri-grid-fill"></i>
                        </button>
                    </div>
                }
                
                @* Custom Header Actions *@
                @if (Model.HeaderActions != null && Model.HeaderActions.Any())
                {
                    foreach (var action in Model.HeaderActions)
                    {
                        <a href="@action.Url" class="btn btn-@action.ColorClass">
                            @if (!string.IsNullOrEmpty(action.IconClass))
                            {
                                <i class="@action.IconClass me-1"></i>
                            }
                            @action.Text
                        </a>
                    }
                }

                @* Create Button *@
                @if (!string.IsNullOrEmpty(Model.CreateButtonText) && !string.IsNullOrEmpty(Model.CreateButtonUrl))
                {
                    <a href="@Model.CreateButtonUrl" class="btn btn-primary">
                        <i class="ri-add-line me-1"></i>@Model.CreateButtonText
                    </a>
                }
            </div>
        </div>

        @* Collapsible Advanced Filters Area *@
        @if (Model.FilterSelects != null && Model.FilterSelects.Any())
        {
            <div class="collapse mt-3 w-100" id="advancedFilters_@Model.TableId">
                <div class="card card-body bg-light" style="border-left: 5px solid var(--bs-primary);">
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var filterSelect in Model.FilterSelects)
                        {
                            <partial name="~/Views/Shared/Components/DataTable/_FilterSelect.cshtml" model="filterSelect" />
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    @* Table View *@
    <div class="card-body p-0" id="@(Model.TableId)_tableView" style="@(Model.EnableViewToggle && Model.DefaultView == "card" ? "display: none;" : "")">
        <div class="table-responsive">
            <table class="@Model.TableClasses" id="@Model.TableId" style="width: 100%;"
                   data-datatable="true"
                   data-bulk-actions="@Model.EnableBulkActions.ToString().ToLower()"
                   data-view-toggle="@Model.EnableViewToggle.ToString().ToLower()"
                   data-ajax-enabled="@Model.EnableAjaxLoading.ToString().ToLower()"
                   data-ajax-url="@Model.AjaxUrl"
                   data-ajax-params="@ajaxParamsJson"
                   data-ajax-columns="@ajaxColumnsJson"
                   data-page-size="@Model.PageSize"
                   data-skeleton-rows="@Model.SkeletonRowCount">
                <thead class="bg-light">
                    <tr>
                        @* Bulk selection checkbox column *@
                        @if (Model.EnableBulkActions)
                        {
                            <th scope="col" style="width: 40px;">
                                <input type="checkbox" class="form-check-input select-all-checkbox" />
                            </th>
                        }

                        @for (int i = 0; i < Model.Columns.Count; i++)
                        {
                            var column = Model.Columns[i];
                            var isNonSortable = Model.NonSortableColumns != null && Model.NonSortableColumns.Contains(i);

                            if (isNonSortable || !Model.EnableSorting)
                            {
                                <th scope="col" style="min-width: 50px; padding: 12px; white-space: nowrap;">@column</th>
                            }
                            else
                            {
                                <th scope="col" class="sortable" style="cursor: pointer; min-width: 50px; padding: 12px; white-space: nowrap;">
                                    @column <i class="ri-arrow-up-down-line ms-1 text-muted fs-14"></i>
                                </th>
                            }
                        }
                    </tr>
                </thead>
                <tbody id="@(Model.TableId)_tbody">
                    @if (Model.EnableAjaxLoading)
                    {
                        @* Skeleton loader for AJAX mode - will be replaced by JS *@
                        @for (int row = 0; row < Model.SkeletonRowCount; row++)
                        {
                            <tr class="skeleton-row">
                                @if (Model.EnableBulkActions)
                                {
                                    <td><div class="skeleton" style="width:16px;height:16px;border-radius:3px;"></div></td>
                                }
                                @if (Model.AjaxColumns != null)
                                {
                                    foreach (var col in Model.AjaxColumns)
                                    {
                                        if (col.DisplayType == "avatar")
                                        {
                                            <td>
                                                <div class="d-flex align-items-center gap-2">
                                                    <div class="skeleton" style="width:32px;height:32px;border-radius:50%;"></div>
                                                    <div class="flex-grow-1">
                                                        <div class="skeleton" style="height:14px;width:70%;margin-bottom:4px;border-radius:4px;"></div>
                                                        <div class="skeleton" style="height:10px;width:50%;border-radius:4px;"></div>
                                                    </div>
                                                </div>
                                            </td>
                                        }
                                        else if (col.DisplayType == "badge")
                                        {
                                            <td><div class="skeleton" style="height:20px;width:70px;border-radius:10px;"></div></td>
                                        }
                                        else if (col.DisplayType == "actions")
                                        {
                                            <td><div class="skeleton" style="height:28px;width:28px;border-radius:4px;"></div></td>
                                        }
                                        else if (col.DisplayType == "checkbox")
                                        {
                                            <td><div class="skeleton" style="width:16px;height:16px;border-radius:3px;"></div></td>
                                        }
                                        else
                                        {
                                            <td><div class="skeleton" style="height:14px;width:80%;border-radius:4px;"></div></td>
                                        }
                                    }
                                }
                            </tr>
                        }
                    }
                    else
                    {
                        @* Server-side rendered content *@
                        @Model.TableContent(null)
                    }
                </tbody>
            </table>
        </div>
    </div>
    
    @* Card View *@
    @if (Model.EnableViewToggle && Model.CardContent != null)
    {
        <div class="card-body" id="@(Model.TableId)_cardView" style="@(Model.DefaultView == "table" ? "display: none;" : "")">
            @Model.CardContent(null)
        </div>
    }

    @* Pagination Footer *@
    @if (Model.ShowPagination)
    {
        <div class="card-footer" id="@(Model.TableId)_pagination">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <span class="text-muted" id="@(Model.TableId)_paginationInfo">
                        @if (Model.EnableAjaxLoading)
                        {
                            <text>Showing page <span class="ajax-current-page">1</span> of <span class="ajax-total-pages">1</span>
                            (<span class="ajax-total-records">0</span> total items)</text>
                        }
                        else
                        {
                            <text>Showing page @Model.CurrentPage of @Model.TotalPages
                            (@Model.TotalRecords total items)</text>
                        }
                    </span>
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination mb-0" id="@(Model.TableId)_paginationControls">
                        @if (!Model.EnableAjaxLoading)
                        {
                            @* Server-side pagination *@
                            var baseUrl = Context.Request.Path.ToString();
                            var queryParams = Context.Request.Query.ToDictionary(x => x.Key, x => x.Value.ToString());
                            queryParams.Remove("page");

                            string BuildPageUrl(int pageNumber)
                            {
                                queryParams["page"] = pageNumber.ToString();
                                var queryString = string.Join("&", queryParams.Select(kvp => $"{kvp.Key}={kvp.Value}"));
                                return $"{baseUrl}?{queryString}";
                            }

                            @* Previous Button *@
                            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="@(Model.CurrentPage > 1 ? BuildPageUrl(Model.CurrentPage - 1) : "#")" aria-label="Previous">
                                    <i class="ri-arrow-left-s-line"></i>
                                </a>
                            </li>

                            @* Page Numbers *@
                            var startPage = Math.Max(1, Model.CurrentPage - 2);
                            var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);

                            if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@BuildPageUrl(1)">1</a>
                                </li>
                                if (startPage > 2)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                            }

                            for (int i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="@BuildPageUrl(i)">@i</a>
                                </li>
                            }

                            if (endPage < Model.TotalPages)
                            {
                                if (endPage < Model.TotalPages - 1)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                                <li class="page-item">
                                    <a class="page-link" href="@BuildPageUrl(Model.TotalPages)">@Model.TotalPages</a>
                                </li>
                            }

                            @* Next Button *@
                            <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                                <a class="page-link" href="@(Model.CurrentPage < Model.TotalPages ? BuildPageUrl(Model.CurrentPage + 1) : "#")" aria-label="Next">
                                    <i class="ri-arrow-right-s-line"></i>
                                </a>
                            </li>
                        }
                        @* AJAX pagination is populated by JavaScript *@
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>
