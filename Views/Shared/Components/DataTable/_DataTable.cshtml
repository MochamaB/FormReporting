@model FormReporting.Models.ViewModels.Components.DataTableViewModel

@*
    DataTable Component - Main Table View

    Features:
    - Search box in header
    - Filter dropdowns (simple)
    - Advanced filter selects (collapsible)
    - Sortable columns
    - Pagination
    - Bulk actions (optional)
    - Create button
    - Responsive design
*@

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap w-100 gap-2">

            @* Left Side: Search & Filters *@
            <div class="d-flex gap-2 flex-wrap align-items-center">

                @* Search Box Component *@
                @if (Model.SearchBox != null)
                {
                    <partial name="~/Views/Shared/Components/DataTable/_SearchBox.cshtml" model="Model.SearchBox" />
                }

                @* Filter Dropdown Components (Simple Filters) *@
                @if (Model.FilterDropdowns != null && Model.FilterDropdowns.Any())
                {
                    @foreach (var filterDropdown in Model.FilterDropdowns)
                    {
                        <partial name="~/Views/Shared/Components/DataTable/_FilterDropdown.cshtml" model="filterDropdown" />
                    }
                }

                @* Advanced Filters Toggle Button (Collapsible) *@
                @if (Model.FilterSelects != null && Model.FilterSelects.Any())
                {
                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#advancedFilters_@Model.TableId" aria-expanded="false"
                            aria-controls="advancedFilters_@Model.TableId">
                        <i class="ri-filter-2-line me-1"></i>Advanced Filters
                    </button>
                }

                @* Bulk Actions (if enabled) *@
                @if (Model.EnableBulkActions && Model.BulkActions != null && Model.BulkActions.Any())
                {
                    <div class="dropdown bulk-actions-dropdown" style="display: none;">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="ri-checkbox-multiple-line me-1"></i>Bulk Actions (<span class="selected-count">0</span>)
                        </button>
                        <ul class="dropdown-menu">
                            @foreach (var action in Model.BulkActions)
                            {
                                <li>
                                    <a class="dropdown-item bulk-action-btn" href="#"
                                       data-url="@action.ActionUrl"
                                       data-confirm="@action.RequiresConfirmation.ToString().ToLower()"
                                       data-message="@action.ConfirmationMessage">
                                        @if (!string.IsNullOrEmpty(action.IconClass))
                                        {
                                            <i class="@action.IconClass me-1"></i>
                                        }
                                        @action.Text
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>

            @* Right Side: Action Buttons *@
            <div class="d-flex gap-2">
                @* Custom Header Actions *@
                @if (Model.HeaderActions != null && Model.HeaderActions.Any())
                {
                    @foreach (var action in Model.HeaderActions)
                    {
                        <a href="@action.Url" class="btn btn-@action.ColorClass">
                            @if (!string.IsNullOrEmpty(action.IconClass))
                            {
                                <i class="@action.IconClass me-1"></i>
                            }
                            @action.Text
                        </a>
                    }
                }

                @* Create Button *@
                @if (!string.IsNullOrEmpty(Model.CreateButtonText) && !string.IsNullOrEmpty(Model.CreateButtonUrl))
                {
                    <a href="@Model.CreateButtonUrl" class="btn btn-primary">
                        <i class="ri-add-line me-1"></i>@Model.CreateButtonText
                    </a>
                }
            </div>
        </div>

        @* Collapsible Advanced Filters Area *@
        @if (Model.FilterSelects != null && Model.FilterSelects.Any())
        {
            <div class="collapse mt-3 w-100" id="advancedFilters_@Model.TableId">
                <div class="card card-body bg-light" style="border-left: 5px solid var(--bs-primary);">
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var filterSelect in Model.FilterSelects)
                        {
                            <partial name="~/Views/Shared/Components/DataTable/_FilterSelect.cshtml" model="filterSelect" />
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="@Model.TableClasses" id="@Model.TableId" style="width: 100%;">
                <thead class="bg-light">
                    <tr>
                        @* Bulk selection checkbox column *@
                        @if (Model.EnableBulkActions)
                        {
                            <th scope="col" style="width: 40px;">
                                <input type="checkbox" class="form-check-input select-all-checkbox" />
                            </th>
                        }

                        @for (int i = 0; i < Model.Columns.Count; i++)
                        {
                            var column = Model.Columns[i];
                            var isNonSortable = Model.NonSortableColumns != null && Model.NonSortableColumns.Contains(i);

                            @if (isNonSortable || !Model.EnableSorting)
                            {
                                <th scope="col" style="min-width: 50px; padding: 12px; white-space: nowrap;">@column</th>
                            }
                            else
                            {
                                <th scope="col" class="sortable" style="cursor: pointer; min-width: 50px; padding: 12px; white-space: nowrap;">
                                    @column <i class="ri-arrow-up-down-line ms-1 text-muted fs-14"></i>
                                </th>
                            }
                        }
                    </tr>
                </thead>
                <tbody>
                    @Model.TableContent(null)
                </tbody>
            </table>
        </div>
    </div>

    @* Pagination Footer *@
    @if (Model.ShowPagination)
    {
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <span class="text-muted">
                        Showing page @Model.CurrentPage of @Model.TotalPages
                        (@Model.TotalRecords total items)
                    </span>
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination mb-0">
                        @{
                            var baseUrl = Context.Request.Path.ToString();
                            var queryParams = Context.Request.Query.ToDictionary(x => x.Key, x => x.Value.ToString());

                            // Remove existing page parameter
                            queryParams.Remove("page");

                            string BuildPageUrl(int pageNumber)
                            {
                                queryParams["page"] = pageNumber.ToString();
                                var queryString = string.Join("&", queryParams.Select(kvp => $"{kvp.Key}={kvp.Value}"));
                                return $"{baseUrl}?{queryString}";
                            }
                        }

                        @* Previous Button *@
                        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="@(Model.CurrentPage > 1 ? BuildPageUrl(Model.CurrentPage - 1) : "#")" aria-label="Previous">
                                <i class="ri-arrow-left-s-line"></i>
                            </a>
                        </li>

                        @* Page Numbers *@
                        @{
                            int startPage = Math.Max(1, Model.CurrentPage - 2);
                            int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);

                            // Show first page
                            if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@BuildPageUrl(1)">1</a>
                                </li>
                                if (startPage > 2)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                            }

                            // Show page numbers
                            for (int i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="@BuildPageUrl(i)">@i</a>
                                </li>
                            }

                            // Show last page
                            if (endPage < Model.TotalPages)
                            {
                                if (endPage < Model.TotalPages - 1)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                                <li class="page-item">
                                    <a class="page-link" href="@BuildPageUrl(Model.TotalPages)">@Model.TotalPages</a>
                                </li>
                            }
                        }

                        @* Next Button *@
                        <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="@(Model.CurrentPage < Model.TotalPages ? BuildPageUrl(Model.CurrentPage + 1) : "#")" aria-label="Next">
                                <i class="ri-arrow-right-s-line"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            var tableId = '@Model.TableId';
            var table = $('#' + tableId);
            var tbody = table.find('tbody');
            var headers = table.find('thead th.sortable');

            // ========== SORTING ==========
            headers.on('click', function() {
                var th = $(this);
                var columnIndex = th.index();

                @if (Model.EnableBulkActions)
                {
                    @:columnIndex = columnIndex - 1; // Adjust for checkbox column
                }

                var rows = tbody.find('tr').toArray();
                var isAscending = th.hasClass('sort-asc');

                // Remove sorting classes and reset icons for all headers
                headers.removeClass('sort-asc sort-desc');
                headers.find('i').attr('class', 'ri-arrow-up-down-line ms-1 text-muted fs-14');

                // Sort rows
                rows.sort(function(a, b) {
                    var aValue = $(a).find('td').eq(columnIndex).text().trim();
                    var bValue = $(b).find('td').eq(columnIndex).text().trim();

                    // Remove common formatting
                    aValue = aValue.replace(/[$,]/g, '');
                    bValue = bValue.replace(/[$,]/g, '');

                    // Try numbers
                    var aNum = parseFloat(aValue);
                    var bNum = parseFloat(bValue);

                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return isAscending ? (bNum - aNum) : (aNum - bNum);
                    }

                    // Try dates
                    var aDate = new Date(aValue);
                    var bDate = new Date(bValue);

                    if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime())) {
                        return isAscending ? (bDate - aDate) : (aDate - bDate);
                    }

                    // String comparison
                    return isAscending
                        ? bValue.localeCompare(aValue, undefined, { numeric: true, sensitivity: 'base' })
                        : aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' });
                });

                // Update table
                tbody.empty().append(rows);

                // Update icon
                if (isAscending) {
                    th.addClass('sort-desc');
                    th.find('i').attr('class', 'ri-arrow-down-line ms-1 text-primary fs-14');
                } else {
                    th.addClass('sort-asc');
                    th.find('i').attr('class', 'ri-arrow-up-line ms-1 text-primary fs-14');
                }
            });

            @if (Model.EnableBulkActions)
            {
                @:// ========== BULK ACTIONS ==========
                @:var selectAllCheckbox = table.find('.select-all-checkbox');
                @:var rowCheckboxes = tbody.find('.row-select-checkbox');
                @:var bulkActionsDropdown = $('.bulk-actions-dropdown');
                @:var selectedCountSpan = bulkActionsDropdown.find('.selected-count');
                @:
                @:function updateBulkActionsVisibility() {
                    @:var checkedCount = rowCheckboxes.filter(':checked').length;
                    @:selectedCountSpan.text(checkedCount);
                    @:if (checkedCount > 0) {
                        @:bulkActionsDropdown.show();
                    @:} else {
                        @:bulkActionsDropdown.hide();
                    @:}
                @:}
                @:
                @:// Select all
                @:selectAllCheckbox.on('change', function() {
                    @:rowCheckboxes.prop('checked', $(this).is(':checked'));
                    @:updateBulkActionsVisibility();
                @:});
                @:
                @:// Individual row selection
                @:tbody.on('change', '.row-select-checkbox', function() {
                    @:var allChecked = rowCheckboxes.length === rowCheckboxes.filter(':checked').length;
                    @:selectAllCheckbox.prop('checked', allChecked);
                    @:updateBulkActionsVisibility();
                @:});
                @:
                @:// Bulk action click
                @:$('.bulk-action-btn').on('click', function(e) {
                    @:e.preventDefault();
                    @:var btn = $(this);
                    @:var url = btn.data('url');
                    @:var needsConfirm = btn.data('confirm');
                    @:var message = btn.data('message');
                    @:
                    @:var selectedIds = rowCheckboxes.filter(':checked').map(function() {
                        @:return $(this).val();
                    @:}).get();
                    @:
                    @:if (needsConfirm && !confirm(message)) {
                        @:return;
                    @:}
                    @:
                    @:// Submit bulk action
                    @:$.post(url, { ids: selectedIds }, function(response) {
                        @:location.reload();
                    @:});
                @:});
            }
        });
    </script>
}
