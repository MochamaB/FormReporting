@using FormReporting.Models.ViewModels.Components

@{
    // Support both direct model and ViewData passing
    // This allows parent views to maintain their own model type while passing tabs via ViewData
    var tabsModel = Model as TabsViewModel ?? ViewData["TabsViewModel"] as TabsViewModel;

    if (tabsModel == null)
    {
        throw new InvalidOperationException("TabsViewModel must be provided either as Model or via ViewData['TabsViewModel']");
    }
}

<style>
    /* ============================================
       VERTICAL TABS - GLOBAL STYLING
       ============================================ */
    
    /* Left column border separator */
    .vertical-tabs-nav {
        border-right: 2px solid #e9ecef;
        padding-right: 1rem;
    }
    
    /* Search box styling */
    .vertical-tabs-search {
        margin-bottom: 1rem;
    }
    
    .vertical-tabs-search .form-control {
        border-radius: 6px;
        border: 1px solid #e9ecef;
        padding: 0.5rem 0.75rem 0.5rem 2.25rem;
        font-size: 0.875rem;
    }
    
    .vertical-tabs-search .form-control:focus {
        border-color: var(--vz-primary);
        box-shadow: 0 0 0 0.15rem rgba(var(--vz-primary-rgb), 0.1);
    }
    
    .vertical-tabs-search .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #878a99;
        font-size: 14px;
    }
    
    /* Tab link base styling */
    .nav-pills.vertical-nav .nav-link {
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        border-radius: 0 6px 6px 0;
        padding: 0.65rem 0.75rem;
        text-align: left;
        background-color: rgba(var(--vz-secondary-rgb), 0.08);
        margin-bottom: 0.35rem;
    }
    
    /* Inactive tab hover */
    .nav-pills.vertical-nav .nav-link:hover:not(.active) {
        background-color: rgba(var(--vz-secondary-rgb), 0.15);
        border-left-color: rgba(var(--vz-primary-rgb), 0.3);
    }
    
    /* Active tab styling */
    .nav-pills.vertical-nav .nav-link.active {
        background-color: rgba(var(--vz-primary-rgb), 0.15) !important;
        color: var(--vz-primary) !important;
        border-left: 3px solid var(--vz-primary);
    }
    
    /* Tab content layout */
    .nav-pills.vertical-nav .nav-link .tab-content-wrapper {
        display: flex;
        align-items: flex-start;
        width: 100%;
    }
    
    .nav-pills.vertical-nav .nav-link .tab-icon {
        flex-shrink: 0;
        margin-right: 0.5rem;
        font-size: 16px;
        margin-top: 2px;
    }
    
    .nav-pills.vertical-nav .nav-link .tab-text {
        flex-grow: 1;
        text-align: left;
        min-width: 0;
    }
    
    .nav-pills.vertical-nav .nav-link .tab-title {
        font-weight: 500;
        font-size: 0.875rem;
        color: inherit;
        display: block;
    }
    
    .nav-pills.vertical-nav .nav-link .tab-description {
        font-size: 0.75rem;
        color: #878a99;
        display: block;
        margin-top: 2px;
        line-height: 1.3;
    }
    
    .nav-pills.vertical-nav .nav-link.active .tab-description {
        color: rgba(var(--vz-primary-rgb), 0.7);
    }
    
    /* Badge styling - always visible */
    .nav-pills.vertical-nav .nav-link .tab-badge {
        flex-shrink: 0;
        margin-left: 0.5rem;
        font-size: 0.7rem;
        padding: 0.25em 0.5em;
        border-radius: 4px;
        font-weight: 600;
        min-width: 1.5rem;
        text-align: center;
    }
    
    /* Badge colors */
    .nav-pills.vertical-nav .nav-link .tab-badge.badge-light {
        background-color: rgba(var(--vz-secondary-rgb), 0.2);
        color: #495057;
    }
    
    .nav-pills.vertical-nav .nav-link.active .tab-badge.badge-light {
        background-color: rgba(var(--vz-primary-rgb), 0.2);
        color: var(--vz-primary);
    }
    
    .nav-pills.vertical-nav .nav-link .tab-badge.badge-primary {
        background-color: rgba(var(--vz-primary-rgb), 0.15);
        color: var(--vz-primary);
    }
    
    /* No results message */
    .vertical-tabs-no-results {
        padding: 1rem;
        text-align: center;
        color: #878a99;
        font-size: 0.875rem;
    }
    
    /* Scrollable tabs container */
    .vertical-tabs-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .vertical-tabs-list::-webkit-scrollbar {
        width: 4px;
    }
    
    .vertical-tabs-list::-webkit-scrollbar-thumb {
        background-color: #d4d4d4;
        border-radius: 4px;
    }
</style>

@*
    Vertical Tabs Partial View

    Layout: Tabs on left/right, content on right/left
    Style: Vertical Nav Pills
    Best for: Settings pages, User profiles, Configuration panels

    Features:
    - Vertical tab navigation with icons
    - Optional badges/counts
    - Optional descriptions
    - Pills or tabs style
    - Disabled state support

    NOTE: This partial contains ZERO logic - all values pre-computed in TabsExtensions

    Usage:
    1. Direct model: <partial name="_VerticalTabs.cshtml" model="tabs" />
    2. ViewData: ViewData["TabsViewModel"] = tabs; <partial name="_VerticalTabs.cshtml" />
       (Use option 2 when parent view needs to maintain its own model type)
*@

@if (tabsModel.WrapInCard)
{
    <div class="card @tabsModel.ContainerCssClass">
        @if (!string.IsNullOrEmpty(tabsModel.CardTitle))
        {
            <div class="card-header">
                <h5 class="card-title mb-0">@tabsModel.CardTitle</h5>
                @if (!string.IsNullOrEmpty(tabsModel.CardSubtitle))
                {
                    <p class="text-muted mb-0">@tabsModel.CardSubtitle</p>
                }
            </div>
        }
        <div class="card-body">
            <div class="row">
                @* Left Column: Vertical Tabs *@
                <div class="col-md-3 vertical-tabs-nav">
                    @* Search Box *@
                    <div class="vertical-tabs-search position-relative">
                        <i class="ri-search-line search-icon"></i>
                        <input type="text" 
                               class="form-control" 
                               id="@(tabsModel.TabsId)Search" 
                               placeholder="Search categories..."
                               autocomplete="off">
                    </div>
                    
                    @* Tabs List *@
                    <div class="nav-pills vertical-nav vertical-tabs-list" id="@tabsModel.TabsId" role="tablist" aria-orientation="vertical">
                        @foreach (var tab in tabsModel.Tabs)
                        {
                            var badgeColorClass = tab.BadgeClasses.Contains("light") ? "badge-light" : "badge-primary";
                            
                            @if (tabsModel.NavigationMode == TabsNavigationMode.ServerSide)
                            {
                                @* Server-side navigation: Use regular href links *@
                                <a class="nav-link @(tab.IsActive ? "active" : "") @(tab.IsDisabled ? "disabled" : "")"
                                   href="@tab.Url"
                                   data-tab-title="@tab.Title.ToLower()"
                                   @(tab.IsDisabled ? "tabindex=\"-1\"" : "")>
                                    <div class="tab-content-wrapper">
                                        @if (!string.IsNullOrEmpty(tab.Icon))
                                        {
                                            <i class="@tab.Icon tab-icon"></i>
                                        }
                                        <span class="tab-text">
                                            <span class="tab-title">@tab.Title</span>
                                            @if (!string.IsNullOrEmpty(tab.Description))
                                            {
                                                <span class="tab-description">@tab.Description</span>
                                            }
                                        </span>
                                        @if (!string.IsNullOrEmpty(tab.Badge))
                                        {
                                            <span class="tab-badge @badgeColorClass">@tab.Badge</span>
                                        }
                                    </div>
                                </a>
                            }
                            else
                            {
                                @* Client-side navigation: Use Bootstrap data-bs-toggle *@
                                <a class="nav-link @(tab.IsActive ? "active" : "") @(tab.IsDisabled ? "disabled" : "")"
                                   id="@(tab.TabId)-tab"
                                   data-bs-toggle="pill"
                                   href="@tab.Href"
                                   role="tab"
                                   aria-controls="@tab.TabId"
                                   aria-selected="@tab.AriaSelected"
                                   data-tab-title="@tab.Title.ToLower()"
                                   @(tab.IsDisabled ? "tabindex=\"-1\"" : "")>
                                    <div class="tab-content-wrapper">
                                        @if (!string.IsNullOrEmpty(tab.Icon))
                                        {
                                            <i class="@tab.Icon tab-icon"></i>
                                        }
                                        <span class="tab-text">
                                            <span class="tab-title">@tab.Title</span>
                                            @if (!string.IsNullOrEmpty(tab.Description))
                                            {
                                                <span class="tab-description">@tab.Description</span>
                                            }
                                        </span>
                                        @if (!string.IsNullOrEmpty(tab.Badge))
                                        {
                                            <span class="tab-badge @badgeColorClass">@tab.Badge</span>
                                        }
                                    </div>
                                </a>
                            }
                        }
                    </div>
                    
                    @* No results message (hidden by default) *@
                    <div class="vertical-tabs-no-results" id="@(tabsModel.TabsId)NoResults" style="display: none;">
                        <i class="ri-search-line fs-24 text-muted d-block mb-2"></i>
                        No categories found
                    </div>
                </div>

                @* Right Column: Tab Content (only for ClientSide mode) *@
                @if (tabsModel.NavigationMode == TabsNavigationMode.ClientSide)
                {
                    <div class="col-md-9">
                        <div class="@tabsModel.TabContentClasses mt-4 mt-md-0" id="@(tabsModel.TabsId)Content">
                            @foreach (var tab in tabsModel.Tabs)
                            {
                                <div class="@tab.TabPaneClasses"
                                     id="@tab.TabId"
                                     role="tabpanel"
                                     aria-labelledby="@(tab.TabId)-tab">
                                    @if (!string.IsNullOrEmpty(tab.ContentPartialPath))
                                    {
                                        @* Pass the parent view's model to the partial *@
                                        var parentModel = ViewData["ParentModel"];
                                        <partial name="@tab.ContentPartialPath" model="parentModel" />
                                    }
                                    else if (!string.IsNullOrEmpty(tab.ContentHtml))
                                    {
                                        @Html.Raw(tab.ContentHtml)
                                    }
                                    else
                                    {
                                        <p class="text-muted">No content provided for this tab.</p>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    @* Server-side mode: Content is provided by the page *@
                    <div class="col-md-9">
                        @if (ViewData["ServerSideContentPartial"] != null)
                        {
                            @* Render a partial view with the parent model *@
                            var contentPartialPath = ViewData["ServerSideContentPartial"]?.ToString();
                            var parentModel = ViewData["ParentModel"];
                            @await Html.PartialAsync(contentPartialPath, parentModel)
                        }
                        else if (ViewData["TabContent"] != null)
                        {
                            @Html.Raw(ViewData["TabContent"])
                        }
                        else
                        {
                            <p class="text-muted">No content provided for server-side navigation.</p>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="@tabsModel.ContainerCssClass">
        <div class="row">
            @* Left Column: Vertical Tabs *@
            <div class="col-md-3 vertical-tabs-nav">
                @* Search Box *@
                <div class="vertical-tabs-search position-relative">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" 
                           class="form-control" 
                           id="@(tabsModel.TabsId)Search" 
                           placeholder="Search categories..."
                           autocomplete="off">
                </div>
                
                @* Tabs List *@
                <div class="nav-pills vertical-nav vertical-tabs-list" id="@tabsModel.TabsId" role="tablist" aria-orientation="vertical">
                    @foreach (var tab in tabsModel.Tabs)
                    {
                        var badgeColorClass = tab.BadgeClasses.Contains("light") ? "badge-light" : "badge-primary";
                        
                        @if (tabsModel.NavigationMode == TabsNavigationMode.ServerSide)
                        {
                            @* Server-side navigation: Use regular href links *@
                            <a class="nav-link @(tab.IsActive ? "active" : "") @(tab.IsDisabled ? "disabled" : "")"
                               href="@tab.Url"
                               data-tab-title="@tab.Title.ToLower()"
                               @(tab.IsDisabled ? "tabindex=\"-1\"" : "")>
                                <div class="tab-content-wrapper">
                                    @if (!string.IsNullOrEmpty(tab.Icon))
                                    {
                                        <i class="@tab.Icon tab-icon"></i>
                                    }
                                    <span class="tab-text">
                                        <span class="tab-title">@tab.Title</span>
                                        @if (!string.IsNullOrEmpty(tab.Description))
                                        {
                                            <span class="tab-description">@tab.Description</span>
                                        }
                                    </span>
                                    @if (!string.IsNullOrEmpty(tab.Badge))
                                    {
                                        <span class="tab-badge @badgeColorClass">@tab.Badge</span>
                                    }
                                </div>
                            </a>
                        }
                        else
                        {
                            @* Client-side navigation: Use Bootstrap data-bs-toggle *@
                            <a class="nav-link @(tab.IsActive ? "active" : "") @(tab.IsDisabled ? "disabled" : "")"
                               id="@(tab.TabId)-tab"
                               data-bs-toggle="pill"
                               href="@tab.Href"
                               role="tab"
                               aria-controls="@tab.TabId"
                               aria-selected="@tab.AriaSelected"
                               data-tab-title="@tab.Title.ToLower()"
                               @(tab.IsDisabled ? "tabindex=\"-1\"" : "")>
                                <div class="tab-content-wrapper">
                                    @if (!string.IsNullOrEmpty(tab.Icon))
                                    {
                                        <i class="@tab.Icon tab-icon"></i>
                                    }
                                    <span class="tab-text">
                                        <span class="tab-title">@tab.Title</span>
                                        @if (!string.IsNullOrEmpty(tab.Description))
                                        {
                                            <span class="tab-description">@tab.Description</span>
                                        }
                                    </span>
                                    @if (!string.IsNullOrEmpty(tab.Badge))
                                    {
                                        <span class="tab-badge @badgeColorClass">@tab.Badge</span>
                                    }
                                </div>
                            </a>
                        }
                    }
                </div>
                
                @* No results message (hidden by default) *@
                <div class="vertical-tabs-no-results" id="@(tabsModel.TabsId)NoResults" style="display: none;">
                    <i class="ri-search-line fs-24 text-muted d-block mb-2"></i>
                    No categories found
                </div>
            </div>

            @* Right Column: Tab Content (only for ClientSide mode) *@
            @if (tabsModel.NavigationMode == TabsNavigationMode.ClientSide)
            {
                <div class="col-md-9">
                    <div class="@tabsModel.TabContentClasses mt-4 mt-md-0" id="@(tabsModel.TabsId)Content">
                        @foreach (var tab in tabsModel.Tabs)
                        {
                            <div class="@tab.TabPaneClasses"
                                 id="@tab.TabId"
                                 role="tabpanel"
                                 aria-labelledby="@(tab.TabId)-tab">
                                @if (!string.IsNullOrEmpty(tab.ContentPartialPath))
                                {
                                    @* Pass the parent view's model to the partial *@
                                    var parentModel = ViewData["ParentModel"];
                                    <partial name="@tab.ContentPartialPath" model="parentModel" />
                                }
                                else if (!string.IsNullOrEmpty(tab.ContentHtml))
                                {
                                    @Html.Raw(tab.ContentHtml)
                                }
                                else
                                {
                                    <p class="text-muted">No content provided for this tab.</p>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                @* Server-side mode: Content is provided by the page *@
                <div class="col-md-9">
                    @if (ViewData["ServerSideContentPartial"] != null)
                    {
                        @* Render a partial view with the parent model *@
                        var contentPartialPath = ViewData["ServerSideContentPartial"]?.ToString();
                        var parentModel = ViewData["ParentModel"];
                        @await Html.PartialAsync(contentPartialPath, parentModel)
                    }
                    else if (ViewData["TabContent"] != null)
                    {
                        @Html.Raw(ViewData["TabContent"])
                    }
                    else
                    {
                        <p class="text-muted">No content provided for server-side navigation.</p>
                    }
                </div>
            }
        </div>
    </div>
}

@* ============================================
   SEARCH FUNCTIONALITY SCRIPT
   ============================================ *@
<script>
    (function() {
        // Initialize search for all vertical tabs on the page
        document.querySelectorAll('.vertical-tabs-search input').forEach(function(searchInput) {
            var tabsId = searchInput.id.replace('Search', '');
            var tabsList = document.getElementById(tabsId);
            var noResultsEl = document.getElementById(tabsId + 'NoResults');
            
            if (!tabsList) return;
            
            searchInput.addEventListener('input', function() {
                var searchTerm = this.value.toLowerCase().trim();
                var tabs = tabsList.querySelectorAll('.nav-link');
                var visibleCount = 0;
                
                tabs.forEach(function(tab) {
                    var title = tab.getAttribute('data-tab-title') || '';
                    var description = tab.querySelector('.tab-description');
                    var descText = description ? description.textContent.toLowerCase() : '';
                    
                    if (title.includes(searchTerm) || descText.includes(searchTerm)) {
                        tab.style.display = '';
                        visibleCount++;
                    } else {
                        tab.style.display = 'none';
                    }
                });
                
                // Show/hide no results message
                if (noResultsEl) {
                    noResultsEl.style.display = visibleCount === 0 ? 'block' : 'none';
                }
            });
            
            // Clear search on escape key
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    this.dispatchEvent(new Event('input'));
                }
            });
        });
    })();
</script>
