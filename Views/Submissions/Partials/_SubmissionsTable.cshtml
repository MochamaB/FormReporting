@using FormReporting.Models.ViewModels.Forms
@model TemplateSubmissionsViewModel

<style>
    /* Submissions Table - Inline styles to override Bootstrap */
    .submissions-table {
        table-layout: fixed !important;
        width: 100% !important;
    }
    
    .submissions-table th,
    .submissions-table td {
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
    }
    
    /* Fixed columns */
    .submissions-table .col-checkbox {
        width: 30px !important;
        min-width: 30px !important;
        max-width: 30px !important;
        text-align: center;
    }
    
    .submissions-table .col-rownum {
        width: 35px !important;
        min-width: 35px !important;
        max-width: 35px !important;
    }
    
    .submissions-table .col-date {
        width: 90px !important;
        min-width: 90px !important;
        max-width: 90px !important;
    }
    
    .submissions-table .col-submitter {
        width: 200px !important;
        min-width: 200px !important;
        max-width: 200px !important;
        white-space: normal !important;
        word-wrap: break-word;
    }
    
    .submissions-table .col-location {
        width: 150px !important;
        min-width: 150px !important;
        max-width: 150px !important;
        white-space: normal !important;
        word-wrap: break-word;
    }
    
    .submissions-table .col-status {
        width: 120px !important;
        min-width: 120px !important;
        max-width: 120px !important;
        border-right: 2px solid #dee2e6;
    }
    
    /* Response columns - flexible width, allow wrap */
    .submissions-table .col-response {
        width: 250px !important;
        min-width: 250px !important;
        max-width: 250px !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        vertical-align: top;
        padding-top: 1rem;
    }
    
    .submissions-table .col-actions {
        width: 100px !important;
        min-width: 100px !important;
        max-width: 100px !important;
        text-align: center;
    }
    
    /* Header styling - with proper wrapping and bottom alignment */
    .submissions-table thead th {
        font-weight: 500;
        font-size: 0.8rem;
        color: #495057;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        vertical-align: bottom !important;
        text-overflow: clip !important;
        overflow: visible !important;
        line-height: 1.3;
        padding-bottom: 0.75rem;
        hyphens: auto;
    }
    
    /* Response column headers - ensure full text shows */
    .submissions-table thead th.col-response {
        vertical-align: bottom !important;
        text-overflow: clip !important;
        overflow: visible !important;
        white-space: normal !important;
        word-break: break-word !important;
        line-height: 1.4;
    }
    
    /* Body cells - with proper wrapping */
    .submissions-table tbody td {
        vertical-align: middle;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        text-overflow: clip !important;
        overflow: visible !important;
        line-height: 1.4;
    }
    
    /* Response columns in body - top aligned with wrapping */
    .submissions-table tbody td.col-response {
        vertical-align: top;
        padding-top: 1rem;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
        text-overflow: clip !important;
        overflow: visible !important;
    }
    
    /* Location column wrapping */
    .submissions-table tbody td.col-location {
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
    }
    
    /* Submitter column wrapping */
    .submissions-table tbody td.col-submitter {
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
    }
    
    .submissions-table tbody td.col-submitter .submitter-info {
        min-width: 0;
        overflow: hidden;
    }
    
    .submissions-table tbody td.col-submitter .submitter-info .fw-medium,
    .submissions-table tbody td.col-submitter .submitter-info small {
        display: block;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
    }
    
    /* Status column wrapping */
    .submissions-table tbody td.col-status {
        white-space: normal !important;
    }
    
    /* Compact badge */
    .submissions-table .badge {
        font-size: 0.7rem;
        padding: 0.2em 0.5em;
        white-space: normal !important;
    }
    
    /* Progress bar */
    .submissions-table .progress {
        height: 4px;
    }
    
    /* Section first column - left border indicator */
    .submissions-table .section-start {
        border-left: 2px solid #e9ebec !important;
    }
    
    /* Section header cells (row 1) */
    .submissions-table thead th.col-section-header {
        text-align: center;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        font-weight: 600;
        background-color: #f8f9fa;
        vertical-align: middle !important;
    }
    
    /* Scrollbar - hidden until hover */
    .table-responsive {
        scrollbar-width: thin;
        scrollbar-color: transparent transparent;
    }
    
    .table-responsive:hover {
        scrollbar-color: var(--vz-secondary) transparent;
    }
    
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background-color: transparent;
        border-radius: 4px;
    }
    
    .table-responsive:hover::-webkit-scrollbar-thumb {
        background-color: var(--vz-secondary);
    }
</style>

@{
    // Build filter URLs
    string BuildFilterUrl(string? status = null, int? tenantId = null, string? period = null, string? search = null)
    {
        var routeValues = new Dictionary<string, object?> { { "templateId", Model.TemplateId } };
        if (!string.IsNullOrEmpty(status)) routeValues["status"] = status;
        if (tenantId.HasValue) routeValues["tenantId"] = tenantId;
        if (!string.IsNullOrEmpty(period)) routeValues["period"] = period;
        if (!string.IsNullOrEmpty(search)) routeValues["search"] = search;
        return Url.Action("TemplateSubmissions", "Submissions", routeValues) ?? "#";
    }
    
    // Preserve current filters when changing one
    string BuildStatusUrl(string? statusValue) => BuildFilterUrl(statusValue, Model.Filters.TenantId, Model.Filters.Period, Model.Filters.Search);
    string BuildLocationUrl(int? tenantIdValue) => BuildFilterUrl(Model.Filters.Status, tenantIdValue, Model.Filters.Period, Model.Filters.Search);
    string BuildPeriodUrl(string? periodValue) => BuildFilterUrl(Model.Filters.Status, Model.Filters.TenantId, periodValue, Model.Filters.Search);
    
    var hasActiveFilters = !string.IsNullOrEmpty(Model.Filters.Status) || Model.Filters.TenantId.HasValue || !string.IsNullOrEmpty(Model.Filters.Period) || !string.IsNullOrEmpty(Model.Filters.Search);
    var hasAdvancedFilters = Model.Filters.DateFrom.HasValue || Model.Filters.DateTo.HasValue || Model.Filters.SubmitterId.HasValue;
}

<!-- Anti-forgery token for AJAX requests -->
@Html.AntiForgeryToken()

<!-- Table Header with Filters -->
<div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
    <!-- Left side: Search and Filters -->
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <!-- Search -->
        <div class="search-box">
            <form method="get" action="@Url.Action("TemplateSubmissions", "Submissions")" id="filterForm">
                <input type="hidden" name="templateId" value="@Model.TemplateId" />
                @if (!string.IsNullOrEmpty(Model.Filters.Status)) { <input type="hidden" name="status" value="@Model.Filters.Status" /> }
                @if (Model.Filters.TenantId.HasValue) { <input type="hidden" name="tenantId" value="@Model.Filters.TenantId" /> }
                @if (!string.IsNullOrEmpty(Model.Filters.Period)) { <input type="hidden" name="period" value="@Model.Filters.Period" /> }
                <input type="text" name="search" class="form-control search" 
                       placeholder="Search..." 
                       value="@Model.Filters.Search" />
                <i class="ri-search-line search-icon"></i>
            </form>
        </div>
        
        <!-- Status Filter Dropdown -->
        <div class="dropdown">
            <button class="btn @(!string.IsNullOrEmpty(Model.Filters.Status) ? "btn-primary" : "btn-outline-secondary") dropdown-toggle" 
                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="ri-filter-line me-1"></i>@(string.IsNullOrEmpty(Model.Filters.Status) ? "Status" : Model.Filters.Status)
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item @(string.IsNullOrEmpty(Model.Filters.Status) ? "active" : "")" href="@BuildStatusUrl(null)">
                    @if (string.IsNullOrEmpty(Model.Filters.Status)) { <i class="ri-check-line me-1"></i> }All Status
                </a></li>
                <li><a class="dropdown-item @(Model.Filters.Status == "Draft" ? "active" : "")" href="@BuildStatusUrl("Draft")">
                    @if (Model.Filters.Status == "Draft") { <i class="ri-check-line me-1"></i> }Draft
                </a></li>
                <li><a class="dropdown-item @(Model.Filters.Status == "Submitted" ? "active" : "")" href="@BuildStatusUrl("Submitted")">
                    @if (Model.Filters.Status == "Submitted") { <i class="ri-check-line me-1"></i> }Submitted
                </a></li>
                <li><a class="dropdown-item @(Model.Filters.Status == "InApproval" ? "active" : "")" href="@BuildStatusUrl("InApproval")">
                    @if (Model.Filters.Status == "InApproval") { <i class="ri-check-line me-1"></i> }In Approval
                </a></li>
                <li><a class="dropdown-item @(Model.Filters.Status == "Approved" ? "active" : "")" href="@BuildStatusUrl("Approved")">
                    @if (Model.Filters.Status == "Approved") { <i class="ri-check-line me-1"></i> }Approved
                </a></li>
                <li><a class="dropdown-item @(Model.Filters.Status == "Rejected" ? "active" : "")" href="@BuildStatusUrl("Rejected")">
                    @if (Model.Filters.Status == "Rejected") { <i class="ri-check-line me-1"></i> }Rejected
                </a></li>
            </ul>
        </div>
        
        <!-- Location Filter Dropdown -->
        @if (Model.AvailableTenants.Any())
        {
            var currentTenantName = Model.Filters.TenantId.HasValue 
                ? Model.AvailableTenants.FirstOrDefault(t => t.TenantId == Model.Filters.TenantId)?.TenantName ?? "Location"
                : "Location";
            <div class="dropdown">
                <button class="btn @(Model.Filters.TenantId.HasValue ? "btn-primary" : "btn-outline-secondary") dropdown-toggle" 
                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="ri-map-pin-line me-1"></i>@currentTenantName
                </button>
                <ul class="dropdown-menu" style="max-height: 250px; overflow-y: auto;">
                    <li><a class="dropdown-item @(!Model.Filters.TenantId.HasValue ? "active" : "")" href="@BuildLocationUrl(null)">
                        @if (!Model.Filters.TenantId.HasValue) { <i class="ri-check-line me-1"></i> }All Locations
                    </a></li>
                    @foreach (var tenant in Model.AvailableTenants)
                    {
                        <li><a class="dropdown-item @(Model.Filters.TenantId == tenant.TenantId ? "active" : "")" href="@BuildLocationUrl(tenant.TenantId)">
                            @if (Model.Filters.TenantId == tenant.TenantId) { <i class="ri-check-line me-1"></i> }@tenant.TenantName
                        </a></li>
                    }
                </ul>
            </div>
        }
        
        <!-- Period Filter Dropdown -->
        <div class="dropdown">
            @{
                var periodLabels = new Dictionary<string, string> {
                    { "", "All Time" }, { "thisMonth", "This Month" }, { "lastMonth", "Last Month" },
                    { "thisQuarter", "This Quarter" }, { "thisYear", "This Year" }
                };
                var currentPeriodLabel = periodLabels.GetValueOrDefault(Model.Filters.Period ?? "", "Period");
            }
            <button class="btn @(!string.IsNullOrEmpty(Model.Filters.Period) ? "btn-primary" : "btn-outline-secondary") dropdown-toggle" 
                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="ri-calendar-line me-1"></i>@currentPeriodLabel
            </button>
            <ul class="dropdown-menu">
                @foreach (var (value, label) in periodLabels)
                {
                    var isActive = (Model.Filters.Period ?? "") == value;
                    <li><a class="dropdown-item @(isActive ? "active" : "")" href="@BuildPeriodUrl(string.IsNullOrEmpty(value) ? null : value)">
                        @if (isActive) { <i class="ri-check-line me-1"></i> }@label
                    </a></li>
                }
            </ul>
        </div>
        
        <!-- Clear Filters -->
        @if (hasActiveFilters || hasAdvancedFilters)
        {
            <a href="@Url.Action("TemplateSubmissions", "Submissions", new { templateId = Model.TemplateId })" 
               class="btn btn-soft-danger" title="Clear all filters">
                <i class="ri-close-line"></i> Clear
            </a>
        }
        
        <!-- Advanced Filters Toggle -->
        <button class="btn @(hasAdvancedFilters ? "btn-warning" : "btn-outline-secondary")" type="button" 
                data-bs-toggle="collapse" data-bs-target="#advancedFilters" 
                aria-expanded="@(hasAdvancedFilters ? "true" : "false")" aria-controls="advancedFilters">
            <i class="ri-filter-2-line me-1"></i>Advanced
            @if (hasAdvancedFilters)
            {
                <span class="badge bg-light text-dark ms-1">@((Model.Filters.DateFrom.HasValue ? 1 : 0) + (Model.Filters.DateTo.HasValue ? 1 : 0) + (Model.Filters.SubmitterId.HasValue ? 1 : 0))</span>
            }
        </button>
    </div>
    
    <!-- Right side: Bulk Actions & Export -->
    <div class="d-flex align-items-center gap-2">
        <!-- Bulk Actions (hidden until rows selected) -->
        <div class="dropdown bulk-actions-dropdown" style="display: none;">
            <button class="btn btn-soft-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="ri-checkbox-multiple-line me-1"></i>Actions (<span class="selected-count">0</span>)
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item bulk-action-btn" href="#" data-action="export">
                    <i class="ri-download-line me-2"></i>Export Selected
                </a></li>
                <li><a class="dropdown-item bulk-action-btn" href="#" data-action="approve">
                    <i class="ri-check-line me-2"></i>Approve Selected
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item bulk-action-btn text-danger" href="#" data-action="delete">
                    <i class="ri-delete-bin-line me-2"></i>Delete Selected
                </a></li>
            </ul>
        </div>
        
        <!-- Export Dropdown -->
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" 
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="ri-download-2-line me-1"></i> Export
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="@Url.Action("ExportSubmissions", "Submissions", new { templateId = Model.TemplateId, format = "csv", status = Model.Filters.Status, tenantId = Model.Filters.TenantId, period = Model.Filters.Period, search = Model.Filters.Search })">
                    <i class="ri-file-text-line me-2"></i>Export CSV
                </a></li>
                <li><a class="dropdown-item" href="@Url.Action("ExportSubmissions", "Submissions", new { templateId = Model.TemplateId, format = "excel", status = Model.Filters.Status, tenantId = Model.Filters.TenantId, period = Model.Filters.Period, search = Model.Filters.Search })">
                    <i class="ri-file-excel-2-line me-2"></i>Export Excel
                </a></li>
                <li><a class="dropdown-item" href="@Url.Action("ExportSubmissions", "Submissions", new { templateId = Model.TemplateId, format = "pdf", status = Model.Filters.Status, tenantId = Model.Filters.TenantId, period = Model.Filters.Period, search = Model.Filters.Search })">
                    <i class="ri-file-pdf-line me-2"></i>Export PDF
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Advanced Filters Collapsible Section -->
<div class="collapse @(hasAdvancedFilters ? "show" : "")" id="advancedFilters">
    <div class="card card-body bg-light mb-3" style="border-left: 4px solid var(--vz-primary);">
        <form method="get" action="@Url.Action("TemplateSubmissions", "Submissions")" class="row g-3 align-items-end">
            <input type="hidden" name="templateId" value="@Model.TemplateId" />
            @if (!string.IsNullOrEmpty(Model.Filters.Status)) { <input type="hidden" name="status" value="@Model.Filters.Status" /> }
            @if (Model.Filters.TenantId.HasValue) { <input type="hidden" name="tenantId" value="@Model.Filters.TenantId" /> }
            @if (!string.IsNullOrEmpty(Model.Filters.Period)) { <input type="hidden" name="period" value="@Model.Filters.Period" /> }
            @if (!string.IsNullOrEmpty(Model.Filters.Search)) { <input type="hidden" name="search" value="@Model.Filters.Search" /> }
            
            <!-- Date From -->
            <div class="col-md-3 col-sm-6">
                <label class="form-label small text-muted mb-1">Date From</label>
                <input type="date" name="dateFrom" class="form-control" 
                       value="@(Model.Filters.DateFrom?.ToString("yyyy-MM-dd"))" />
            </div>
            
            <!-- Date To -->
            <div class="col-md-3 col-sm-6">
                <label class="form-label small text-muted mb-1">Date To</label>
                <input type="date" name="dateTo" class="form-control" 
                       value="@(Model.Filters.DateTo?.ToString("yyyy-MM-dd"))" />
            </div>
            
            <!-- Submitter -->
            @if (Model.AvailableSubmitters.Any())
            {
                <div class="col-md-4 col-sm-6">
                    <label class="form-label small text-muted mb-1">Submitter</label>
                    <select name="submitterId" class="form-select">
                        <option value="">All Submitters</option>
                        @foreach (var submitter in Model.AvailableSubmitters)
                        {
                            if (Model.Filters.SubmitterId == submitter.UserId)
                            {
                                <option value="@submitter.UserId" selected>@submitter.FullName (@submitter.SubmissionCount)</option>
                            }
                            else
                            {
                                <option value="@submitter.UserId">@submitter.FullName (@submitter.SubmissionCount)</option>
                            }
                        }
                    </select>
                </div>
            }
            
            <!-- Apply Button -->
            <div class="col-md-2 col-sm-6">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="ri-filter-line me-1"></i>Apply
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Bulk selection handling
    function updateBulkActionsVisibility() {
        const checkboxes = document.querySelectorAll('.submission-checkbox:checked');
        const bulkDropdown = document.querySelector('.bulk-actions-dropdown');
        const countSpan = document.querySelector('.selected-count');
        
        if (checkboxes.length > 0) {
            bulkDropdown.style.display = 'block';
            countSpan.textContent = checkboxes.length;
        } else {
            bulkDropdown.style.display = 'none';
        }
    }
    
    // Attach listeners to checkboxes
    document.querySelectorAll('.submission-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBulkActionsVisibility);
    });
    
    // Get selected submission IDs
    function getSelectedIds() {
        return Array.from(document.querySelectorAll('.submission-checkbox:checked'))
            .map(cb => cb.value);
    }
    
    // Bulk action handlers
    document.querySelectorAll('.bulk-action-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const action = this.dataset.action;
            const selectedIds = getSelectedIds();
            
            if (selectedIds.length === 0) {
                alert('Please select at least one submission');
                return;
            }
            
            switch(action) {
                case 'export':
                    // Export selected as CSV
                    const exportUrl = '@Url.Action("ExportSubmissions", "Submissions")' + 
                        '?templateId=@Model.TemplateId&format=excel&ids=' + selectedIds.join(',');
                    window.location.href = exportUrl;
                    break;
                case 'approve':
                    if (confirm('Approve ' + selectedIds.length + ' selected submissions?')) {
                        bulkAction('approve', selectedIds);
                    }
                    break;
                case 'delete':
                    if (confirm('Delete ' + selectedIds.length + ' selected submissions? This cannot be undone.')) {
                        bulkAction('delete', selectedIds);
                    }
                    break;
            }
        });
    });
    
    // Perform bulk action via AJAX
    async function bulkAction(action, ids) {
        try {
            const response = await fetch('@Url.Action("BulkAction", "Submissions")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ action: action, submissionIds: ids })
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    // Reload page to show updated data
                    window.location.reload();
                } else {
                    alert(result.message || 'Action failed');
                }
            } else {
                alert('Failed to perform action. Please try again.');
            }
        } catch (error) {
            console.error('Bulk action error:', error);
            alert('An error occurred. Please try again.');
        }
    }
    
    // Single delete confirmation
    function confirmDelete(submissionId) {
        if (confirm('Are you sure you want to delete this submission? This cannot be undone.')) {
            bulkAction('delete', [submissionId]);
        }
    }
    
    // Row click to open offcanvas (exclude checkbox and action columns)
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.submission-row').forEach(row => {
            row.addEventListener('click', function(e) {
                // Don't trigger if clicking on checkbox, button, link, or dropdown
                if (e.target.closest('.form-check') || 
                    e.target.closest('button') || 
                    e.target.closest('a') || 
                    e.target.closest('.dropdown')) {
                    return;
                }
                
                const submissionId = this.dataset.submissionId;
                const submissionNumber = this.dataset.submissionNumber;
                const submissionDate = this.dataset.submissionDate;
                
                // Call the loadSubmissionDetail function from parent view
                if (typeof loadSubmissionDetail === 'function') {
                    loadSubmissionDetail(submissionId, submissionNumber, submissionDate);
                }
            });
        });
    });

</script>

<!-- Submissions Table -->
<div class="table-responsive">
    <table class="table table-hover align-middle mb-0 submissions-table">
        <!-- Define column widths explicitly -->
        <colgroup>
            <col style="width: 30px;">   <!-- Checkbox -->
            <col style="width: 35px;">   <!-- # -->
            <col style="width: 90px;">   <!-- Date -->
            <col style="width: 200px;">  <!-- Submitter -->
            <col style="width: 150px;">  <!-- Location -->
            <col style="width: 120px;">  <!-- Status -->
            @foreach (var field in Model.FieldColumns)
            {
                <col style="width: 250px;"> <!-- Response columns -->
            }
            <col style="width: 100px;">  <!-- Actions -->
        </colgroup>
        <thead class="table-light">
            @{
                // Group fields by section for header row
                var sectionGroups = Model.FieldColumns
                    .GroupBy(f => new { f.SectionId, f.SectionName })
                    .Select(g => new { g.Key.SectionName, Count = g.Count() })
                    .ToList();
            }
            <!-- Row 1: Fixed columns with rowspan + Section headers with colspan -->
            <tr>
                <!-- Fixed columns span 2 rows -->
                <th class="col-checkbox" rowspan="2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkAll" />
                    </div>
                </th>
                <th class="col-rownum" rowspan="2">#</th>
                <th class="col-date" rowspan="2">Date</th>
                <th class="col-submitter" rowspan="2">Submitter</th>
                <th class="col-location" rowspan="2">Location</th>
                <th class="col-status" rowspan="2">Status</th>
                <!-- Section headers span their field columns -->
                @foreach (var sectionGroup in sectionGroups)
                {
                    <th class="col-section-header section-start" colspan="@sectionGroup.Count">@sectionGroup.SectionName</th>
                }
                <!-- Actions spans 2 rows -->
                <th class="col-actions" rowspan="2">Actions</th>
            </tr>
            <!-- Row 2: Field name headers only -->
            <tr>
                @foreach (var field in Model.FieldColumns)
                {
                    <th class="col-response @(field.IsFirstInSection ? "section-start" : "")" title="@field.FieldName">@field.FieldName</th>
                }
            </tr>
        </thead>
        <tbody>
            @if (Model.Submissions.Any())
            {
                @foreach (var submission in Model.Submissions)
                {
                    <tr class="submission-row" 
                        style="cursor: pointer;" 
                        data-submission-id="@submission.SubmissionId"
                        data-submission-number="@submission.SubmissionNumber"
                        data-submission-date="@submission.FormattedDate">
                        <!-- 1. Checkbox -->
                        <td class="col-checkbox">
                            <div class="form-check">
                                <input class="form-check-input submission-checkbox" 
                                       type="checkbox" 
                                       value="@submission.SubmissionId" />
                            </div>
                        </td>
                        <!-- 2. Row number -->
                        <td class="col-rownum">@submission.SubmissionNumber</td>
                        <!-- 3. Date -->
                        <td class="col-date" title="@submission.SubmissionDate.ToString("MMM dd, yyyy h:mm tt")">
                            @{
                                var isCurrentYear = submission.SubmissionDate.Year == DateTime.Now.Year;
                                var dateFormat = isCurrentYear ? "MMM dd" : "MMM dd, yyyy";
                            }
                            <div>@submission.SubmissionDate.ToString(dateFormat)</div>
                            <small class="text-muted">@submission.SubmissionDate.ToString("h:mm tt")</small>
                        </td>
                        <!-- 4. Submitter -->
                        <td class="col-submitter">
                            <div class="d-flex align-items-center">
                                <div class="avatar-xs me-2 flex-shrink-0">
                                    <div class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                        @(submission.SubmitterName.Length > 0 ? submission.SubmitterName[0].ToString().ToUpper() : "?")
                                    </div>
                                </div>
                                <div class="submitter-info flex-grow-1">
                                    <div class="fw-medium">@submission.SubmitterName</div>
                                    <small class="text-muted">@submission.SubmitterEmail</small>
                                </div>
                            </div>
                        </td>
                        <!-- 5. Location -->
                        <td class="col-location" title="@submission.TenantName">@(submission.TenantName ?? "—")</td>
                        <!-- 6. Status & Progress -->
                        <td class="col-status">
                            <span class="badge @submission.StatusBadgeClass">@submission.Status</span>
                            <div class="d-flex align-items-center gap-1 mt-1">
                                <div class="progress flex-grow-1">
                                    <div class="progress-bar bg-primary" 
                                         role="progressbar" 
                                         style="width: @submission.CompletionPercentage%"></div>
                                </div>
                                <small class="text-muted">@submission.AnsweredCount/@submission.TotalFields</small>
                            </div>
                        </td>
                        <!-- Dynamic response columns -->
                        @for (int i = 0; i < Model.FieldColumns.Count; i++)
                        {
                            var field = Model.FieldColumns[i];
                            var preview = submission.ResponsePreviews.ElementAtOrDefault(i);
                            <td class="col-response @(field.IsFirstInSection ? "section-start" : "")" title="@(preview?.DisplayValue ?? "")">
                                @if (preview != null && preview.HasValue)
                                {
                                    @if (field.DataType.ToLower() == "rating" || field.DataType.ToLower() == "slider")
                                    {
                                        <div class="d-flex align-items-center gap-1">
                                            <span>@preview.DisplayValue</span>
                                            @if (preview.MaxValue.HasValue && preview.NumericValue.HasValue)
                                            {
                                                <div class="progress" style="width: 40px; height: 4px;">
                                                    <div class="progress-bar bg-info" 
                                                         style="width: @((preview.NumericValue / preview.MaxValue * 100))%"></div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        @preview.DisplayValue
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                        }
                        <!-- Actions -->
                        <td class="col-actions">
                            <div class="d-flex gap-1">
                                <!-- Quick View Button -->
                                <button type="button" 
                                        class="btn btn-soft-info btn-sm" 
                                        title="Quick View"
                                        onclick="loadSubmissionDetail(@submission.SubmissionId, '@submission.SubmissionNumber', '@submission.FormattedDate')">
                                    <i class="ri-eye-line"></i>
                                </button>
                                <!-- More Actions Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-soft-secondary btn-sm dropdown-toggle" 
                                            type="button" 
                                            data-bs-toggle="dropdown">
                                        <i class="ri-more-fill"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="@Url.Action("View", "Submissions", new { submissionId = submission.SubmissionId })">
                                                <i class="ri-external-link-line me-2"></i>Full View
                                            </a>
                                        </li>
                                        @if (submission.Status == "Draft")
                                        {
                                            <li>
                                                <a class="dropdown-item" href="@Url.Action("Form", "Submissions", new { templateCode = Model.TemplateCode, submissionId = submission.SubmissionId })">
                                                    <i class="ri-edit-line me-2"></i>Continue Editing
                                                </a>
                                            </li>
                                        }
                                        <li>
                                            <a class="dropdown-item" href="@Url.Action("Print", "Submissions", new { submissionId = submission.SubmissionId })" target="_blank">
                                                <i class="ri-printer-line me-2"></i>Print
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" onclick="confirmDelete(@submission.SubmissionId)">
                                                <i class="ri-delete-bin-line me-2"></i>Delete
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="@(7 + Model.FieldColumns.Count)" class="text-center py-4">
                        <div class="text-muted">No submissions found</div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Pagination -->
@if (Model.TotalPages > 1)
{
    <div class="d-flex justify-content-between align-items-center p-3 border-top">
        <div>
            <span class="text-muted">
                Showing @((Model.CurrentPage - 1) * Model.PageSize + 1) to @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalRecords) of @Model.TotalRecords submissions
            </span>
        </div>
        <nav aria-label="Submissions pagination">
            <ul class="pagination mb-0">
                @{
                    string BuildPageUrl(int pageNumber)
                    {
                        var routeValues = new Dictionary<string, object?> { 
                            { "templateId", Model.TemplateId },
                            { "page", pageNumber }
                        };
                        if (!string.IsNullOrEmpty(Model.Filters.Status)) routeValues["status"] = Model.Filters.Status;
                        if (Model.Filters.TenantId.HasValue) routeValues["tenantId"] = Model.Filters.TenantId;
                        if (!string.IsNullOrEmpty(Model.Filters.Period)) routeValues["period"] = Model.Filters.Period;
                        if (!string.IsNullOrEmpty(Model.Filters.Search)) routeValues["search"] = Model.Filters.Search;
                        return Url.Action("TemplateSubmissions", "Submissions", routeValues) ?? "#";
                    }
                    
                    var startPage = Math.Max(1, Model.CurrentPage - 2);
                    var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                }
                
                <!-- Previous Button -->
                <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@(Model.CurrentPage > 1 ? BuildPageUrl(Model.CurrentPage - 1) : "#")" aria-label="Previous">
                        <i class="ri-arrow-left-s-line"></i>
                    </a>
                </li>
                
                <!-- First page + ellipsis -->
                @if (startPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="@BuildPageUrl(1)">1</a>
                    </li>
                    if (startPage > 2)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                }
                
                <!-- Page Numbers -->
                @for (int i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                        <a class="page-link" href="@BuildPageUrl(i)">@i</a>
                    </li>
                }
                
                <!-- Last page + ellipsis -->
                @if (endPage < Model.TotalPages)
                {
                    if (endPage < Model.TotalPages - 1)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                    <li class="page-item">
                        <a class="page-link" href="@BuildPageUrl(Model.TotalPages)">@Model.TotalPages</a>
                    </li>
                }
                
                <!-- Next Button -->
                <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" href="@(Model.CurrentPage < Model.TotalPages ? BuildPageUrl(Model.CurrentPage + 1) : "#")" aria-label="Next">
                        <i class="ri-arrow-right-s-line"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
}

@* Bulk select script *@
<script>
    document.getElementById('checkAll')?.addEventListener('change', function() {
        document.querySelectorAll('.submission-checkbox').forEach(cb => {
            cb.checked = this.checked;
        });
        // Update bulk actions visibility
        if (typeof updateBulkActionsVisibility === 'function') {
            updateBulkActionsVisibility();
        }
    });
</script>
