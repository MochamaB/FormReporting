@using FormReporting.Models.Entities.Forms
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Extensions
@model List<FormTemplateSubmission>

@{
    // Current filters from ViewBag
    string currentStatus = ViewBag.CurrentStatus ?? "";
    string currentSearch = ViewBag.CurrentSearch ?? "";
    
    // Pagination from ViewBag
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int totalRecords = ViewBag.TotalRecords ?? 0;
    int pageSize = ViewBag.PageSize ?? 10;
    
    // Calculate starting row number for current page
    int startingNumber = ((currentPage - 1) * pageSize) + 1;
    
    // Badge color mapping based on ktda-theme.css
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Draft" => "bg-warning",
            "Submitted" => "bg-primary", 
            "InApproval" => "bg-info",
            "Approved" => "bg-success",
            "Rejected" => "bg-danger",
            "Cancelled" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
    
    // Helper function to build row actions
    RowActionsViewModel BuildRowActions(FormTemplateSubmission submission)
    {
        var actions = new List<RowActionConfig>();

        if (submission.Status == "Draft")
        {
            actions.Add(new RowActionConfig
            {
                Text = "Resume",
                IconClass = "ri-play-line",
                ColorClass = "primary",
                UrlTemplate = Url.Action("Resume", "Submissions", new { submissionId = submission.SubmissionId })
            });
            
            actions.Add(new RowActionConfig
            {
                Text = "Delete Draft",
                IconClass = "ri-delete-bin-line",
                ColorClass = "danger",
                RequiresConfirmation = true,
                ConfirmationMessage = $"Are you sure you want to delete this draft?"
            });
        }
        else
        {
            actions.Add(new RowActionConfig
            {
                Text = "View",
                IconClass = "ri-eye-line",
                ColorClass = "primary",
                UrlTemplate = Url.Action("View", "Submissions", new { submissionId = submission.SubmissionId })
            });
            
            actions.Add(new RowActionConfig
            {
                Text = "Print",
                IconClass = "ri-printer-line",
                ColorClass = "secondary",
                UrlTemplate = Url.Action("Print", "Submissions", new { submissionId = submission.SubmissionId })
            });
        }

        return new RowActionsViewModel
        {
            DisplayStyle = RowActionDisplayStyle.Dropdown,
            DropdownText = "",
            DropdownIconClass = "ri-more-fill",
            ButtonSizeClass = "btn-sm",
            UseSoftButtons = true,
            RowId = submission.SubmissionId.ToString(),
            Actions = actions.Select(a => new RowActionViewModel
            {
                Text = a.Text,
                IconClass = a.IconClass,
                ColorClass = a.ColorClass,
                Url = a.UrlTemplate,
                RequiresConfirmation = a.RequiresConfirmation,
                ConfirmationMessage = a.ConfirmationMessage,
                IsVisible = true
            }).ToList()
        };
    }
    
    // Build DataTable configuration
    var tableConfig = new DataTableConfig
    {
        TableId = "submissionsTable",
        Columns = new List<string> { "#", "Form", "Period", "Status", "Last Updated", "Actions" },
        EnableSearch = true,
        SearchBox = new SearchBoxConfig
        {
            ParameterName = "search",
            PlaceholderText = "Search submissions...",
            CurrentValue = currentSearch,
            ActionUrl = Url.Action("Index", "Submissions") ?? "/Submissions",
            PreserveQueryParams = !string.IsNullOrEmpty(currentStatus)
                ? new Dictionary<string, string> { { "status", currentStatus } }
                : null
        },
        FilterDropdowns = new List<FilterDropdownConfig>
        {
            new FilterDropdownConfig
            {
                Label = string.IsNullOrEmpty(currentStatus) ? "All Status" : currentStatus,
                Options = new List<FilterOption>
                {
                    new FilterOption { Text = "All Status", Value = "", Url = Url.Action("Index", "Submissions", new { search = currentSearch }), IsActive = string.IsNullOrEmpty(currentStatus) },
                    new FilterOption { Text = "Draft", Value = "Draft", Url = Url.Action("Index", "Submissions", new { status = "Draft", search = currentSearch }), IsActive = currentStatus == "Draft" },
                    new FilterOption { Text = "Submitted", Value = "Submitted", Url = Url.Action("Index", "Submissions", new { status = "Submitted", search = currentSearch }), IsActive = currentStatus == "Submitted" },
                    new FilterOption { Text = "In Approval", Value = "InApproval", Url = Url.Action("Index", "Submissions", new { status = "InApproval", search = currentSearch }), IsActive = currentStatus == "InApproval" },
                    new FilterOption { Text = "Approved", Value = "Approved", Url = Url.Action("Index", "Submissions", new { status = "Approved", search = currentSearch }), IsActive = currentStatus == "Approved" },
                    new FilterOption { Text = "Rejected", Value = "Rejected", Url = Url.Action("Index", "Submissions", new { status = "Rejected", search = currentSearch }), IsActive = currentStatus == "Rejected" }
                }
            }
        },
        ShowPagination = totalPages > 1,
        CurrentPage = currentPage,
        TotalPages = totalPages,
        TotalRecords = totalRecords,
        PageSize = pageSize,
        EnableSorting = true,
        NonSortableColumns = new List<int> { 0, 5 }, // # and Actions columns
        EnableHover = true,
        EnableViewToggle = true,
        DefaultView = "table"
    };
    
    // Build the table view model
    var table = tableConfig.BuildDataTable();
}

<!-- Toolbar Row -->
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <!-- Left: Search + Filters -->
    <div class="d-flex gap-2 flex-wrap align-items-center">
        <!-- Search Box Component -->
        @if (table.SearchBox != null)
        {
            <partial name="~/Views/Shared/Components/DataTable/_SearchBox.cshtml" model="table.SearchBox" />
        }
        
        <!-- Status Filter Dropdown Component -->
        @if (table.FilterDropdowns != null && table.FilterDropdowns.Any())
        {
            foreach (var filterDropdown in table.FilterDropdowns)
            {
                <partial name="~/Views/Shared/Components/DataTable/_FilterDropdown.cshtml" model="filterDropdown" />
            }
        }
        
        @if (!string.IsNullOrEmpty(currentStatus) || !string.IsNullOrEmpty(currentSearch))
        {
            <a href="@Url.Action("Index", "Submissions")" class="btn btn-soft-danger btn-sm">
                <i class="ri-close-line me-1"></i>Clear Filters
            </a>
        }
    </div>
    
    <!-- Right: View Toggle -->
    <div class="d-flex gap-2 align-items-center">
        <div class="btn-group" role="group" aria-label="View toggle">
            <button type="button" class="btn btn-soft-secondary btn-sm view-toggle-btn active" data-view="table" title="Table View">
                <i class="ri-list-check"></i>
            </button>
            <button type="button" class="btn btn-soft-secondary btn-sm view-toggle-btn" data-view="card" title="Card View">
                <i class="ri-grid-fill"></i>
            </button>
        </div>
    </div>
</div>

<!-- TABLE VIEW (Default) -->
<div id="tableView">
    <div class="table-responsive">
        <table class="@table.TableClasses" id="@table.TableId" style="width: 100%;">
            <thead class="table-light">
                <tr>
                    <th style="width: 40px;">#</th>
                    <th>Form</th>
                    <th>Period</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model == null || Model.Count == 0)
                {
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center">
                                <img src="~/assets/images/svg/emptyform.svg" alt="No submissions" style="max-width: 200px; height: auto;" class="mb-3" />
                                @if (!string.IsNullOrEmpty(currentStatus) || !string.IsNullOrEmpty(currentSearch))
                                {
                                    <h5 class="text-muted mb-2">No submissions found</h5>
                                    <p class="text-muted mb-0">Try adjusting your filters</p>
                                }
                                else
                                {
                                    <h5 class="text-muted mb-2">No submissions yet</h5>
                                    <p class="text-muted mb-3">Start by filling out a form</p>
                                    <a href="@Url.Action("AvailableForms", "Submissions")" class="btn btn-primary">
                                        <i class="ri-add-line me-1"></i>New Submission
                                    </a>
                                }
                            </div>
                        </td>
                    </tr>
                }
                else
                {
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var item = Model[i];
                        var rowNumber = startingNumber + i;
                        <tr>
                            <td class="text-muted">@rowNumber</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-2">
                                        <div class="avatar-xs">
                                            <div class="avatar-title bg-primary-subtle text-primary rounded">
                                                <i class="ri-file-list-3-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">@(item.Template?.TemplateName ?? "Unknown Form")</h6>
                                        @if (item.Tenant != null)
                                        {
                                            <small class="text-muted">@item.Tenant.TenantName</small>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td>
                                @if (item.ReportingPeriod != default)
                                {
                                    <span>@item.ReportingPeriod.ToString("MMMM yyyy")</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(item.Status)">@item.Status</span>
                            </td>
                            <td>
                                <span class="text-muted">
                                    @if (item.Status == "Draft")
                                    {
                                        @(item.LastSavedDate?.ToString("dd MMM yyyy HH:mm") ?? item.CreatedDate.ToString("dd MMM yyyy HH:mm"))
                                    }
                                    else
                                    {
                                        @(item.SubmittedDate?.ToString("dd MMM yyyy HH:mm") ?? item.LastSavedDate?.ToString("dd MMM yyyy HH:mm") ?? "-")
                                    }
                                </span>
                            </td>
                            <td>
                                @{
                                    var rowActions = BuildRowActions(item);
                                }
                                <partial name="~/Views/Shared/Components/RowActions/_RowActionsDropdown.cshtml" model="rowActions" />
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    @if (table.ShowPagination && totalPages > 1)
    {
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3 pt-3 border-top">
            <div>
                <span class="text-muted">
                    Showing page @currentPage of @totalPages (@totalRecords total)
                </span>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    @{
                        string BuildPageUrl(int pageNumber)
                        {
                            return Url.Action("Index", "Submissions", new
                            {
                                page = pageNumber,
                                search = currentSearch,
                                status = currentStatus
                            }) ?? $"/Submissions?page={pageNumber}";
                        }
                    }
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <a class="page-link" href="@(currentPage > 1 ? BuildPageUrl(currentPage - 1) : "#")">
                            <i class="ri-arrow-left-s-line"></i>
                        </a>
                    </li>
                    @for (int p = Math.Max(1, currentPage - 2); p <= Math.Min(totalPages, currentPage + 2); p++)
                    {
                        <li class="page-item @(p == currentPage ? "active" : "")">
                            <a class="page-link" href="@BuildPageUrl(p)">@p</a>
                        </li>
                    }
                    <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                        <a class="page-link" href="@(currentPage < totalPages ? BuildPageUrl(currentPage + 1) : "#")">
                            <i class="ri-arrow-right-s-line"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

<!-- CARD VIEW (Hidden by default) -->
<div id="cardView" style="display: none;">
    <partial name="~/Views/Submissions/Partials/_SubmissionCardGrid.cshtml" model="Model" />
    
    <!-- Pagination for Card View -->
    @if (table.ShowPagination && totalPages > 1)
    {
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3 pt-3 border-top">
            <div>
                <span class="text-muted">
                    Showing page @currentPage of @totalPages (@totalRecords total)
                </span>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    @{
                        string BuildCardPageUrl(int pageNumber)
                        {
                            return Url.Action("Index", "Submissions", new
                            {
                                page = pageNumber,
                                search = currentSearch,
                                status = currentStatus
                            }) ?? $"/Submissions?page={pageNumber}";
                        }
                    }
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <a class="page-link" href="@(currentPage > 1 ? BuildCardPageUrl(currentPage - 1) : "#")">
                            <i class="ri-arrow-left-s-line"></i>
                        </a>
                    </li>
                    @for (int p = Math.Max(1, currentPage - 2); p <= Math.Min(totalPages, currentPage + 2); p++)
                    {
                        <li class="page-item @(p == currentPage ? "active" : "")">
                            <a class="page-link" href="@BuildCardPageUrl(p)">@p</a>
                        </li>
                    }
                    <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                        <a class="page-link" href="@(currentPage < totalPages ? BuildCardPageUrl(currentPage + 1) : "#")">
                            <i class="ri-arrow-right-s-line"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>
