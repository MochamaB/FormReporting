@model FormReporting.Models.ViewModels.Organizational.TenantCreateViewModel
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Extensions

@{
    ViewData["Title"] = "Create New Tenant";
}



@{
    // ============================================================================
    // WIZARD CONFIGURATION - 4 Steps
    // Implements WF-1.10: Tenant Creation Wizard
    // ============================================================================

    var wizardConfig = new WizardConfig
    {
        FormId = "tenantCreationWizard",
        Layout = WizardLayout.Vertical,
        Steps = new List<WizardStep>
        {
            new WizardStep
            {
                StepId = "step1-basic",
                StepNumber = 1,
                Title = "Basic Details",
                Description = "Tenant information and contact details",
                Instructions = "Enter the essential information for the new tenant including code, name, and type",
                Icon = "ri-information-line",
                State = WizardStepState.Active,
                ContentPartialPath = "~/Views/Organizational/Tenants/Partials/_BasicDetails.cshtml",
                ShowPrevious = false,
                ShowNext = true,
                NextButtonText = "Next: Departments"
            },
            new WizardStep
            {
                StepId = "step2-departments",
                StepNumber = 2,
                Title = "Department Setup",
                Description = "Setup organizational departments",
                Instructions = "Define the organizational structure for this tenant",
                Icon = "ri-building-4-line",
                State = WizardStepState.Pending,
                ContentPartialPath = "~/Views/Organizational/Tenants/Partials/_Departments.cshtml",
                ShowPrevious = true,
                ShowNext = true,
                PreviousButtonText = "Back",
                NextButtonText = "Next: Groups"
            },
            new WizardStep
            {
                StepId = "step3-groups",
                StepNumber = 3,
                Title = "Tenant Groups",
                Description = "Assign to groups (optional)",
                Instructions = "Select which tenant groups this tenant should belong to (optional)",
                Icon = "ri-group-line",
                State = WizardStepState.Pending,
                ContentPartialPath = "~/Views/Organizational/Tenants/Partials/_Groups.cshtml",
                ShowPrevious = true,
                ShowNext = true,
                PreviousButtonText = "Back",
                NextButtonText = "Next: Review"
            },
            new WizardStep
            {
                StepId = "step4-summary",
                StepNumber = 4,
                Title = "Review & Confirm",
                Description = "Verify all information",
                Instructions = "Please review all information before creating the tenant",
                Icon = "ri-check-double-line",
                State = WizardStepState.Pending,
                ContentPartialPath = "~/Views/Organizational/Tenants/Partials/_Step4_Summary.cshtml",
                ShowPrevious = true,
                ShowNext = false,
                PreviousButtonText = "Back",
                CustomButtonHtml = "<button type='submit' class='btn btn-success'><i class='ri-check-line me-1'></i>Create Tenant</button>"
            }
        }
    };

    var wizard = wizardConfig.BuildWizard();

    // Pass wizard through ViewData so step partials can inherit TenantCreateViewModel
    ViewData["WizardViewModel"] = wizard;

    // Store parent model so step partials can access it
    ViewData["ParentModel"] = Model;
}

@* Display validation errors *@
@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <h5 class="alert-heading"><i class="ri-error-warning-line me-2"></i>Validation Errors</h5>
        <ul class="mb-0">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@* Main Form with Wizard *@
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="post" action="@Url.Action("Create", "Tenants")" id="@wizardConfig.FormId">
                    @Html.AntiForgeryToken()

                    @* Hidden fields to preserve data across wizard steps *@
                    @Html.HiddenFor(m => m.CreateDefaultDepartments)

                    @* Render Wizard Component (wizard passed via ViewData) *@
                    <partial name="~/Views/Shared/Components/Wizards/_VerticalWizard.cshtml" />
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const wizardId = '@wizardConfig.FormId';

            // Register validation callback for this wizard instance
            // The global form-wizard.js will call this before navigating to next step
            window.wizardValidationCallbacks[wizardId] = function (currentStepId) {
                let isValid = true;

                // Clear previous errors
                $('.is-invalid').removeClass('is-invalid');
                $('.invalid-feedback').remove();

                // Validate based on current step
                if (currentStepId === 'step1-basic') {
                    // Validate Step 1: Basic Details
                    if ($('#TenantCode').val().trim() === '') {
                        showError('#TenantCode', 'Tenant code is required');
                        isValid = false;
                    }
                    if ($('#TenantName').val().trim() === '') {
                        showError('#TenantName', 'Tenant name is required');
                        isValid = false;
                    }
                    if ($('#TenantType').val() === '') {
                        showError('#TenantType', 'Tenant type is required');
                        isValid = false;
                    }

                    // Check region requirement for factories
                    const tenantType = $('#TenantType').val();
                    const regionId = $('#RegionId').val();

                    if (tenantType === 'Factory' && !regionId) {
                        showError('#RegionId', 'Region is required for Factory type tenants');
                        isValid = false;
                    }

                    if (tenantType === 'HeadOffice' && regionId) {
                        showError('#RegionId', 'Head Office cannot be assigned to a region');
                        isValid = false;
                    }
                }
                else if (currentStepId === 'step2-departments') {
                    // Validate Step 2: Departments (optional - can skip if using defaults)
                }
                // Step 3 and 4 don't require validation

                return isValid;
            };

            // Show error message helper
            function showError(fieldId, message) {
                $(fieldId).addClass('is-invalid');
                $(fieldId).after('<div class="invalid-feedback d-block">' + message + '</div>');
            }

            // Handle tenant type change (business logic specific to tenant creation)
            $('#TenantType').on('change', function () {
                const tenantType = $(this).val();
                const regionGroup = $('#RegionId').closest('.mb-3');

                if (tenantType === 'Factory') {
                    regionGroup.show();
                    $('#RegionId').prop('required', true);
                } else if (tenantType === 'HeadOffice') {
                    regionGroup.hide();
                    $('#RegionId').val('').prop('required', false);
                } else {
                    regionGroup.show();
                    $('#RegionId').prop('required', false);
                }
            });

            // Trigger on page load
            $('#TenantType').trigger('change');

            // ========================================================
            // STEP 4: UPDATE SUMMARY WITH FORM VALUES
            // ========================================================

            // Update summary with current form values
            function updateSummary() {
                // Basic Details
                $('#summary-tenantcode').text($('#TenantCode').val() || '(Not specified)');
                $('#summary-tenantname').text($('#TenantName').val() || '(Not specified)');

                var tenantType = $('#TenantType').val() || '(Not specified)';
                $('#summary-tenanttype').text(tenantType);

                // Update badge color based on type
                var $typeBadge = $('#summary-tenanttype');
                $typeBadge.removeClass('bg-primary bg-success bg-info');
                if (tenantType === 'HeadOffice') {
                    $typeBadge.addClass('bg-primary');
                } else if (tenantType === 'Factory') {
                    $typeBadge.addClass('bg-success');
                } else if (tenantType === 'Subsidiary') {
                    $typeBadge.addClass('bg-info');
                }

                // Region (if visible and has value)
                var regionId = $('#RegionId').val();
                if (regionId) {
                    var regionText = $('#RegionId option:selected').text();
                    $('#summary-region').text(regionText);
                }

                // Location
                var location = $('#Location').val();
                if (location) {
                    $('#summary-location').text(location);
                }

                // Contact Phone
                var phone = $('#ContactPhone').val();
                if (phone) {
                    $('#summary-phone').text(phone);
                }

                // Contact Email
                var email = $('#ContactEmail').val();
                if (email) {
                    $('#summary-email').text(email);
                }
            }

            // Update summary when step 4 becomes active
            // Listen for when the Review tab is shown
            $('[data-bs-target="#step4-summary"]').on('click', function () {
                setTimeout(updateSummary, 100);
            });

            // Also update when Next button brings us to step 4
            $('.nexttab').on('click', function () {
                var nextTabId = $(this).attr('data-nexttab');
                if (nextTabId === 'step4-summary-tab') {
                    setTimeout(updateSummary, 100);
                }
            });

            // Update on page load if we're already on step 4
            if ($('#step4-summary').hasClass('active')) {
                updateSummary();
            }
        });
    </script>
}
