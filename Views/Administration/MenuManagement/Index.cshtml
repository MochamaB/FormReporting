@model FormReporting.Models.ViewModels.Administration.MenuTreeViewModel

@{
    ViewData["Title"] = "Menu Management";
}

@* Anti-forgery token for AJAX requests *@
@Html.AntiForgeryToken()



<!-- Main Content: Split Panel Layout -->
<div class="row">
    <!-- LEFT PANEL: Menu Tree -->
    <div class="col-lg-5">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">Menu Structure</h4>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-primary" id="btnAddNewItem">
                            <i class="ri-add-line"></i> New Item
                        </button>
                        <button type="button" class="btn btn-sm btn-soft-primary" id="btnExpandAll">
                            <i class="ri-arrow-down-s-line"></i> Expand All
                        </button>
                        <button type="button" class="btn btn-sm btn-soft-secondary" id="btnCollapseAll">
                            <i class="ri-arrow-up-s-line"></i> Collapse All
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Menu Tree using Velzon's Nestable Pattern -->
                <div id="menuTreeContainer" class="list-group nested-list nested-sortable">
                    @foreach (var menusection in Model.Sections)
                    {
                        <!-- Section Header -->
                        <div class="list-group-item nested-section bg-light" 
                             data-section-id="@menusection.MenuSectionId"
                             style="border-left: 4px solid var(--vz-@menusection.SectionBadgeColor);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="@menusection.SectionIcon fs-16 align-middle text-@menusection.SectionBadgeColor me-2"></i>
                                    <strong>@menusection.SectionName</strong>
                                    <span class="badge bg-@menusection.SectionBadgeColor-subtle text-@menusection.SectionBadgeColor ms-2">
                                        @menusection.Modules.Count modules
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Modules in this Section -->
                        @foreach (var module in menusection.Modules)
                        {
                            <!-- Module (Level 1) -->
                            <div class="list-group-item nested-1 menu-item-module" 
                                 data-module-id="@module.ModuleId"
                                 data-type="module">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        @if (!string.IsNullOrEmpty(module.Icon))
                                        {
                                            <i class="@module.Icon fs-16 align-middle text-primary me-2"></i>
                                        }
                                        <span class="fw-medium">@module.ModuleName</span>
                                        @Html.Raw(module.StatusBadge)
                                        @if (module.MenuItems.Count > 0)
                                        {
                                            <span class="badge bg-info-subtle text-info ms-2">
                                                @module.MenuItems.Count items
                                            </span>
                                        }
                                    </div>
                                </div>

                                <!-- Menu Items in this Module -->
                                @if (module.MenuItems.Count > 0)
                                {
                                    <div class="list-group nested-list nested-sortable">
                                        @foreach (var menuItem in module.MenuItems)
                                        {
                                            @await Html.PartialAsync("~/Views/Administration/MenuManagement/_MenuTreeNode.cshtml", menuItem)
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>

                @if (!Model.Sections.Any())
                {
                    <div class="text-center py-5">
                        <i class="ri-menu-line text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">No menu items found</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL: Properties Panel (Sticky) -->
    <div class="col-lg-7">
        <div class="card sticky-properties-panel">
            <div class="card-header">
                <h4 class="card-title mb-0">Menu Item Properties</h4>
            </div>
            <div class="card-body properties-panel-body">
                <!-- No Selection Message -->
                <div id="noSelectionMessage" class="alert alert-info">
                    <i class="ri-information-line"></i>
                    <strong>No Item Selected</strong>
                    <p class="mb-0 mt-2">Select a menu item from the tree on the left to view and edit its properties.</p>
                </div>

                <!-- Properties Form (Hidden by default) -->
                <div id="propertiesForm" style="display: none;">
                    <!-- Loading State -->
                    <div id="propertiesLoading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3">Loading menu item properties...</p>
                    </div>

                    <!-- Properties Content -->
                    <div id="propertiesContent">
                        <!-- Header with Title and Actions -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h5 class="mb-1" id="propMenuTitle">Menu Item Title</h5>
                                <small class="text-muted" id="propMenuCode">MENU_CODE</small>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-primary" id="btnSaveProperties">
                                    <i class="ri-save-line"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" id="btnCancelEdit">
                                    <i class="ri-close-line"></i> Cancel
                                </button>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <ul class="nav nav-tabs nav-tabs-custom" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#tabBasicInfo" role="tab">
                                    <i class="ri-information-line"></i> Basic Info
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tabDisplay" role="tab">
                                    <i class="ri-eye-line"></i> Display
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tabNavigation" role="tab">
                                    <i class="ri-links-line"></i> Navigation
                                </a>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content p-3 border border-top-0">
                            <!-- Basic Info Tab -->
                            <div class="tab-pane fade show active" id="tabBasicInfo" role="tabpanel">
                                <input type="hidden" id="inputMenuItemId">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Menu Title <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="inputMenuTitle" required>
                                        <div class="invalid-feedback">Menu title is required</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Menu Code <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="inputMenuCode" required>
                                        <div class="invalid-feedback">Menu code is required</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Module <span class="text-danger">*</span></label>
                                        <select class="form-select" id="selectModuleId" required>
                                            <option value="">Select Module...</option>
                                        </select>
                                        <div class="invalid-feedback">Module is required</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Section</label>
                                        <input type="text" class="form-control" id="inputSectionName" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Parent Menu Item</label>
                                        <select class="form-select" id="selectParentMenuItemId">
                                            <option value="">None (Top Level)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Level</label>
                                        <input type="number" class="form-control" id="inputLevel" min="1" max="4">
                                    </div>
                                </div>
                            </div>

                            <!-- Display Tab -->
                            <div class="tab-pane fade" id="tabDisplay" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Icon</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="inputIcon" placeholder="e.g., ri-dashboard-line">
                                            <button class="btn btn-outline-secondary" type="button" id="btnIconPicker">
                                                <i id="iconPreview" class="ri-menu-line"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">Enter RemixIcon class name</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Display Order</label>
                                        <input type="number" class="form-control" id="inputDisplayOrder" min="0">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Active Status</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="checkIsActive">
                                            <label class="form-check-label" for="checkIsActive">
                                                Is Active
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Visibility</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="checkIsVisible">
                                            <label class="form-check-label" for="checkIsVisible">
                                                Is Visible
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Authentication</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="checkRequiresAuth">
                                            <label class="form-check-label" for="checkRequiresAuth">
                                                Requires Auth
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Navigation Tab -->
                            <div class="tab-pane fade" id="tabNavigation" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Controller</label>
                                        <input type="text" class="form-control" id="inputController" placeholder="e.g., Analytics">
                                        <small class="text-muted">Leave empty for parent items</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Action</label>
                                        <input type="text" class="form-control" id="inputAction" placeholder="e.g., Index">
                                        <small class="text-muted">Leave empty for parent items</small>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Full Path <small class="text-muted">(Auto-generated)</small></label>
                                        <input type="text" class="form-control" id="inputFullPath" readonly>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Created Date</label>
                                        <input type="text" class="form-control" id="inputCreatedDate" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="ri-alert-line text-warning" style="font-size: 3rem;"></i>
                </div>
                <p id="confirmModalMessage" class="text-center mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmModalAction">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Info Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel">Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i id="infoModalIcon" class="ri-information-line text-info" style="font-size: 3rem;"></i>
                </div>
                <p id="infoModalMessage" class="text-center mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* Menu Tree Styling */
        .nested-section {
            font-weight: 600;
            background-color: #f8f9fa !important;
            border-left-width: 4px !important;
            margin-bottom: 0.5rem;
        }

        .menu-item-module {
            background-color: #fafbfc;
            border-left: 3px solid #0d6efd;
        }

        .menu-item {
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
            position: relative;
        }

        .menu-item:hover {
            background-color: #f0f7ff;
            border-left-color: #0d6efd;
            cursor: move;
        }

        .menu-item.selected {
            background-color: #e7f3ff;
            border-left-color: #0d6efd;
            font-weight: 600;
        }

        .nested-1 {
            padding-left: 1.5rem;
        }

        .nested-2 {
            padding-left: 3rem;
        }

        .nested-3 {
            padding-left: 4.5rem;
        }

        .nested-4 {
            padding-left: 6rem;
        }

        /* Drag handle styling */
        .menu-item::before {
            content: "⋮⋮";
            position: absolute;
            left: 0.5rem;
            color: #adb5bd;
            cursor: move;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .menu-item:hover::before {
            opacity: 1;
        }

        /* SortableJS drag states */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e3f2fd;
            border: 2px dashed #2196f3;
        }

        .sortable-chosen {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }

        .sortable-drag {
            opacity: 0.8;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .dragging {
            opacity: 0.5;
        }

        /* Smooth animations */
        .list-group-item {
            transition: all 0.2s ease;
        }

        /* Drop zone indicator */
        .nested-sortable {
            min-height: 20px;
        }

        /* Sticky Properties Panel */
        .sticky-properties-panel {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .properties-panel-body {
            overflow-y: auto;
            flex: 1;
            max-height: calc(100vh - 120px);
        }

        /* Custom scrollbar for properties panel */
        .properties-panel-body::-webkit-scrollbar {
            width: 8px;
        }

        .properties-panel-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .properties-panel-body::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .properties-panel-body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Ensure tabs don't overflow */
        .sticky-properties-panel .tab-content {
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }
    </style>
}

@section Scripts {
    <!-- SortableJS Library (already included in Velzon) -->
    <script src="~/assets/libs/sortablejs/Sortable.min.js"></script>

    <!-- Menu Management Custom Script -->
    <script src="~/assets/js/pages/menu-management.js"></script>
}
