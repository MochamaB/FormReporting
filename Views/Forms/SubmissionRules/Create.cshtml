@model SubmissionRuleCreateDto
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Models.ViewModels.Forms
@using FormReporting.Extensions

@{
    ViewData["Title"] = "Create Submission Rule";
    var templateId = ViewData["TemplateId"] as int? ?? 0;
    var templateName = ViewData["TemplateName"] as string ?? "Unknown Template";
    
    var formConfig = new SimpleFormConfig
    {
        FormId = "createSubmissionRuleForm",
        FormAction = Url.Action("Store", "SubmissionRule"),
        FormMethod = "POST",
        SubmitButtonText = "Create Rule",
        CancelButtonUrl = Url.Action("Details", "FormTemplates", new { id = templateId }),
        CardTitle = "Create Submission Rule",
        CardSubtitle = $"Define submission schedule for {templateName}",
        StyleType = FormStyleType.Standard,
        WrapInCard = true,
        Fields = new List<SimpleFormFieldConfig>
        {
            new SimpleFormFieldConfig
            {
                PropertyName = "TemplateId",
                FieldType = SimpleFieldType.Hidden,
                Value = Model.TemplateId,
                DisplayOrder = 1
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "RuleName",
                Label = "Rule Name",
                FieldType = SimpleFieldType.Text,
                Value = Model.RuleName,
                IsRequired = true,
                ColumnClass = "col-12",
                DisplayOrder = 2,
                PlaceholderText = "e.g., Monthly Sales Report, Weekly Status Update"
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "Description",
                Label = "Description",
                FieldType = SimpleFieldType.TextArea,
                Value = Model.Description,
                Rows = 3,
                ColumnClass = "col-12",
                DisplayOrder = 3,
                PlaceholderText = "Optional description of this submission rule"
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "Frequency",
                Label = "Frequency",
                FieldType = SimpleFieldType.Select,
                Value = Model.Frequency,
                ColumnClass = "col-md-6",
                DisplayOrder = 4,
                Options = new List<SelectOption>
                {
                    new SelectOption { Value = "", Text = "No schedule (access-only)" },
                    new SelectOption { Value = "Daily", Text = "Daily" },
                    new SelectOption { Value = "Weekly", Text = "Weekly" },
                    new SelectOption { Value = "Monthly", Text = "Monthly" },
                    new SelectOption { Value = "Quarterly", Text = "Quarterly" },
                    new SelectOption { Value = "Annually", Text = "Annually" },
                    new SelectOption { Value = "Once", Text = "One-time" }
                }
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "DueTime",
                Label = "Due Time",
                FieldType = SimpleFieldType.Time,
                Value = Model.DueTime?.ToString(@"hh\:mm"),
                ColumnClass = "col-md-6",
                DisplayOrder = 5
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "DueDay",
                Label = "Due Day",
                FieldType = SimpleFieldType.Select,
                Value = Model.DueDay,
                ColumnClass = "col-md-6",
                DisplayOrder = 6,
                Options = new List<SelectOption>()
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "DueMonth",
                Label = "Due Month",
                FieldType = SimpleFieldType.Select,
                Value = Model.DueMonth,
                ColumnClass = "col-md-6",
                DisplayOrder = 7,
                Options = new List<SelectOption>
                {
                    new SelectOption { Value = "1", Text = "January" },
                    new SelectOption { Value = "2", Text = "February" },
                    new SelectOption { Value = "3", Text = "March" },
                    new SelectOption { Value = "4", Text = "April" },
                    new SelectOption { Value = "5", Text = "May" },
                    new SelectOption { Value = "6", Text = "June" },
                    new SelectOption { Value = "7", Text = "July" },
                    new SelectOption { Value = "8", Text = "August" },
                    new SelectOption { Value = "9", Text = "September" },
                    new SelectOption { Value = "10", Text = "October" },
                    new SelectOption { Value = "11", Text = "November" },
                    new SelectOption { Value = "12", Text = "December" }
                }
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "SpecificDueDate",
                Label = "Specific Due Date",
                FieldType = SimpleFieldType.DateTime,
                Value = Model.SpecificDueDate?.ToString("yyyy-MM-ddTHH:mm"),
                ColumnClass = "col-12",
                DisplayOrder = 8,
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "GracePeriodDays",
                Label = "Grace Period (Days)",
                FieldType = SimpleFieldType.Number,
                Value = Model.GracePeriodDays,
                ColumnClass = "col-md-6",
                DisplayOrder = 9,
                PlaceholderText = "0",
                HelpText = "Days after due date to accept submissions without penalty"
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "AllowLateSubmission",
                Label = "Allow Late Submissions",
                FieldType = SimpleFieldType.Checkbox,
                Value = Model.AllowLateSubmission,
                ColumnClass = "col-md-6",
                DisplayOrder = 10,
                HelpText = "Allow submissions after grace period (flagged as late)"
            },
            new SimpleFormFieldConfig
            {
                PropertyName = "ReminderDaysBefore",
                Label = "Reminder Days",
                FieldType = SimpleFieldType.Text,
                Value = Model.ReminderDaysBefore,
                ColumnClass = "col-12",
                DisplayOrder = 11,
                PlaceholderText = "e.g., 7,3,1",
                HelpText = "Comma-separated days before due date to send reminders"
            }
        }
    };

    var form = formConfig.BuildForm();
}



<div class="row">
    <div class="col-12">
        <partial name="~/Views/Shared/Components/SimpleForms/_SimpleForm.cshtml" model="form" />
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate rule name: "{TemplateName} Rule"
    const ruleNameInput = document.getElementById('createSubmissionRuleForm_RuleName');
    const descriptionInput = document.getElementById('createSubmissionRuleForm_Description');
    if (ruleNameInput && ruleNameInput.value === '') {
        ruleNameInput.value = '@templateName Rule';
    }
    
    const frequencySelect = document.getElementById('createSubmissionRuleForm_Frequency');
    const dueTimeField = document.getElementById('createSubmissionRuleForm_DueTime').closest('.col-md-6');
    const dueDayField = document.getElementById('createSubmissionRuleForm_DueDay').closest('.col-md-6');
    const dueMonthField = document.getElementById('createSubmissionRuleForm_DueMonth').closest('.col-md-6');
    const specificDueDateField = document.getElementById('createSubmissionRuleForm_SpecificDueDate').closest('.col-12');
    const dueDaySelect = document.getElementById('createSubmissionRuleForm_DueDay');

    function updateFieldsBasedOnFrequency() {
        const frequency = frequencySelect.value.toLowerCase();
        
        // Hide all conditional fields first
        dueTimeField.style.display = 'none';
        dueDayField.style.display = 'none';
        dueMonthField.style.display = 'none';
        specificDueDateField.style.display = 'none';
        
        // Clear due day options
        dueDaySelect.innerHTML = '<option value="">Select...</option>';
        
        switch(frequency) {
            case 'daily':
                // Daily: Show only due time
                dueTimeField.style.display = 'block';
                updateDescription('daily', 'Submissions are required every day');
                break;
                
            case 'weekly':
                // Weekly: Show due day (days of week) + due time
                dueTimeField.style.display = 'block';
                dueDayField.style.display = 'block';
                dueDaySelect.innerHTML = `
                    <option value="">Select day...</option>
                    <option value="0">Sunday</option>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                `;
                updateDescription('weekly', 'Submissions are required on a specific day each week');
                break;
                
            case 'monthly':
                // Monthly: Show due day (1-31) + due time
                dueTimeField.style.display = 'block';
                dueDayField.style.display = 'block';
                dueDaySelect.innerHTML = '<option value="">Select day...</option>';
                for (let i = 1; i <= 31; i++) {
                    const suffix = getOrdinalSuffix(i);
                    dueDaySelect.innerHTML += `<option value="${i}">${i}${suffix}</option>`;
                }
                dueDaySelect.innerHTML += '<option value="-1">Last day of month</option>';
                updateDescription('monthly', 'Submissions are required on a specific day each month');
                break;
                
            case 'quarterly':
                // Quarterly: Show enhanced quarterly options + due time
                dueTimeField.style.display = 'block';
                dueDayField.style.display = 'block';
                dueDaySelect.innerHTML = `
                    <option value="">Select option...</option>
                    <option value="1">First day of quarter</option>
                    <option value="15">15th of first month</option>
                    <option value="30">30th of first month</option>
                    <option value="-1">Last day of quarter</option>
                    <option value="-7">1 week before quarter end</option>
                    <option value="-15">2 weeks before quarter end</option>
                `;
                updateDescription('quarterly', 'Submissions are required once per quarter (every 3 months)');
                break;
                
            case 'annually':
                // Annually: Show due day + due month + due time
                dueTimeField.style.display = 'block';
                dueDayField.style.display = 'block';
                dueMonthField.style.display = 'block';
                dueDaySelect.innerHTML = '<option value="">Select day...</option>';
                for (let i = 1; i <= 31; i++) {
                    const suffix = getOrdinalSuffix(i);
                    dueDaySelect.innerHTML += `<option value="${i}">${i}${suffix}</option>`;
                }
                dueDaySelect.innerHTML += '<option value="-1">Last day of month</option>';
                updateDescription('annually', 'Submissions are required once per year on a specific date');
                break;
                
            case 'once':
                // Once: Show specific due date/time picker
                specificDueDateField.style.display = 'block';
                updateDescription('once', 'This is a one-time submission with a specific deadline');
                break;
                
            case '':
                // No frequency selected - hide all
                updateDescription('', 'Users can submit this form at any time without a scheduled deadline');
                break;
        }
    }
    
    function updateDescription(frequency, defaultText) {
        if (descriptionInput && descriptionInput.value === '') {
            descriptionInput.value = defaultText;
        }
    }
    
    function getOrdinalSuffix(number) {
        if (number % 100 >= 11 && number % 100 <= 13) return 'th';
        switch (number % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
        }
    }
    
    // Initialize fields based on current frequency
    updateFieldsBasedOnFrequency();
    
    // Update fields when frequency changes
    frequencySelect.addEventListener('change', updateFieldsBasedOnFrequency);
});
</script>
