@model FormReporting.Models.ViewModels.Forms.TemplateDetailsViewModel
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Extensions

@{
    ViewData["Title"] = Model.TemplateName;
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Build tabs configuration using the existing TabsConfig pattern
    var tabsConfig = new TabsConfig
    {
        TabsId = "templateDetailsTabs",
        Layout = TabsLayout.Horizontal,
        Style = TabsStyle.CustomBordered,
        ColorTheme = "primary",
        WrapInCard = false,
        IsJustified = false
    }
    .WithTab("overview", "Overview",
        icon: "ri-dashboard-line",
        isActive: Model.ActiveTab == "overview",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_OverviewPanel.cshtml")
    .WithTab("structure", "Structure",
        icon: "ri-layout-grid-line",
        badge: Model.TotalFields.ToString(),
        badgeColor: "secondary",
        isActive: Model.ActiveTab == "structure",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_StructurePanel.cshtml")
    .WithTab("assignments", "Assignments",
        icon: "ri-user-add-line",
        badge: Model.AssignmentCount > 0 ? Model.AssignmentCount.ToString() : null,
        badgeColor: Model.OverdueAssignmentCount > 0 ? "danger" : "success",
        isActive: Model.ActiveTab == "assignments",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_FormAssignmentPanel.cshtml")
    .WithTab("workflow", "Workflow",
        icon: "ri-flow-chart",
        badge: Model.HasWorkflow ? Model.WorkflowStepCount.ToString() : null,
        badgeColor: "info",
        isActive: Model.ActiveTab == "workflow",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_WorkflowBuilderPanel.cshtml")
    .WithTab("submissionrules", "Submission Rules",
        icon: "ri-time-line",
        badge: Model.SubmissionRuleCount > 0 ? Model.SubmissionRuleCount.ToString() : null,
        badgeColor: "warning",
        isActive: Model.ActiveTab == "submissionrules",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_SubmissionRulesPanel.cshtml")
    .WithTab("metrics", "Metrics",
        icon: "ri-bar-chart-box-line",
        badge: Model.MetricMappingCount > 0 ? Model.MetricMappingCount.ToString() : null,
        badgeColor: "warning",
        isActive: Model.ActiveTab == "metrics",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_MetricMappingPanel.cshtml")
    .WithTab("submissions", "Submissions",
        icon: "ri-file-list-3-line",
        badge: Model.SubmissionCount > 0 ? Model.SubmissionCount.ToString() : null,
        badgeColor: "primary",
        isActive: Model.ActiveTab == "submissions",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_SubmissionsPanel.cshtml")
    .BuildTabs();
}

@section Styles {
    <link rel="stylesheet" href="~/css/template-details.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/workflow-builder.css" asp-append-version="true" />
}

<!-- Hidden fields for JavaScript -->
<input type="hidden" id="templateId" value="@Model.TemplateId" />
@if (Model.WorkflowId.HasValue)
{
    <input type="hidden" id="workflowId" value="@Model.WorkflowId" />
}



<!-- Template Header Card - Full Width with Secondary Background -->
<div class="card bg-secondary-subtle border-0 mb-4" style = "margin-top:-1.5rem;margin-left:-1.5rem;margin-right:-1.5rem">
    <div class="card-body">
        <div class="d-flex align-items-start">

            <!-- Icon -->
            <div class="flex-shrink-0 me-3">
                <div class="avatar-lg">
                    <div class="avatar-title bg-primary-subtle text-primary rounded fs-2">
                        <i class="ri-file-list-3-line"></i>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-grow-1">

                <!-- Top Row: Title/Description (left) + Buttons (right) -->
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">

                    <!-- Title + Description -->
                    <div class="me-3">
                        <h3 class="mb-1 fw-semibold text-dark">
                            @Model.TemplateName
                        </h3>

                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            <p class="text-muted mb-0">
                                @Model.Description
                            </p>
                        }
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex gap-2">

                        @if (Model.IsPublished)
                        {
                            <a href="@Url.Action("StartSubmission", "FormSubmissions", 
                                new { templateId = Model.TemplateId })"
                               class="btn btn-success">
                                <i class="ri-add-line me-1"></i>
                                New Submission
                            </a>
                        }

                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown">
                                Actions
                            </button>

                            <ul class="dropdown-menu dropdown-menu-end">

                                <li>
                                    <a class="dropdown-item"
                                       href="@Url.Action("FormBuilder", "FormTemplates", 
                                       new { id = Model.TemplateId })">
                                        <i class="ri-edit-line me-2"></i>
                                        Edit Template
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="ri-file-copy-line me-2"></i>
                                        Duplicate
                                    </a>
                                </li>

                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="ri-download-line me-2"></i>
                                        Export
                                    </a>
                                </li>

                                <li><hr class="dropdown-divider" /></li>

                                <li>
                                    <a class="dropdown-item text-danger" href="#">
                                        <i class="ri-archive-line me-2"></i>
                                        Archive
                                    </a>
                                </li>

                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Metadata Row (Full width under both sections) -->
                <div class="d-flex flex-wrap align-items-center gap-3 text-muted small mt-3">

                    <span><i class="ri-folder-line me-1"></i>
                        <strong>Category:</strong>
                        @(Model.CategoryName ?? "Uncategorized")
                    </span>

                    <span><i class="ri-code-line me-1"></i>
                        <strong>Code:</strong>
                        @Model.TemplateCode
                    </span>

                    <span><i class="ri-settings-line me-1"></i>
                        <strong>Mode:</strong>
                        @Model.SubmissionMode.ToString()
                    </span>

                    <span>
                        <strong>Status:</strong>
                        <span class="badge @Model.StatusBadgeClass">
                            @Model.PublishStatus
                        </span>
                    </span>

                    <span><i class="ri-calendar-line me-1"></i>
                        <strong>Created:</strong>
                        @Model.CreatedDate.ToString("MMM dd, yyyy")
                    </span>

                    <span><i class="ri-file-line me-1"></i>
                        <strong>Type:</strong>
                        @(Model.TemplateType ?? "Form")
                    </span>

                    <span><i class="ri-git-branch-line me-1"></i>
                        <strong>Version:</strong>
                        @Model.Version
                    </span>

                </div>

            </div>
        </div>
    </div>
</div>



<!-- Tabs Content -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                @{
                    // Store model in ViewData for partials to access
                    ViewData["TemplateDetails"] = Model;
                }
                <partial name="~/Views/Shared/Components/Tabs/_HorizontalTabs.cshtml" model="tabsConfig" />
            </div>
        </div>
    </div>
</div>

<!-- Modal Container (for AJAX-loaded modals) -->
<div id="modalContainer"></div>

@section Scripts {
    <script src="~/js/pages/template-details.js" asp-append-version="true"></script>
}
