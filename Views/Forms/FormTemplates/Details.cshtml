@model FormReporting.Models.ViewModels.Forms.TemplateDetailsViewModel
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Extensions

@{
    ViewData["Title"] = Model.TemplateName;
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Build tabs configuration using the existing TabsConfig pattern
    var tabsConfig = new TabsConfig
    {
        TabsId = "templateDetailsTabs",
        Layout = TabsLayout.Horizontal,
        Style = TabsStyle.CustomBordered,
        ColorTheme = "primary",
        WrapInCard = false,
        IsJustified = false
    }
    .WithTab("overview", "Overview",
        icon: "ri-dashboard-line",
        isActive: Model.ActiveTab == "overview",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_OverviewPanel.cshtml")
    .WithTab("structure", "Structure",
        icon: "ri-layout-grid-line",
        badge: Model.TotalFields.ToString(),
        badgeColor: "secondary",
        isActive: Model.ActiveTab == "structure",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_StructurePanel.cshtml")
    .WithTab("assignments", "Assignments",
        icon: "ri-user-add-line",
        badge: Model.AssignmentCount > 0 ? Model.AssignmentCount.ToString() : null,
        badgeColor: Model.OverdueAssignmentCount > 0 ? "danger" : "success",
        isActive: Model.ActiveTab == "assignments",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_FormAssignmentPanel.cshtml")
    .WithTab("workflow", "Workflow",
        icon: "ri-flow-chart",
        badge: Model.HasWorkflow ? Model.WorkflowStepCount.ToString() : null,
        badgeColor: "info",
        isActive: Model.ActiveTab == "workflow",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_WorkflowBuilderPanel.cshtml")
    .WithTab("metrics", "Metrics",
        icon: "ri-bar-chart-box-line",
        badge: Model.MetricMappingCount > 0 ? Model.MetricMappingCount.ToString() : null,
        badgeColor: "warning",
        isActive: Model.ActiveTab == "metrics",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_MetricMappingPanel.cshtml")
    .WithTab("submissions", "Submissions",
        icon: "ri-file-list-3-line",
        badge: Model.SubmissionCount > 0 ? Model.SubmissionCount.ToString() : null,
        badgeColor: "primary",
        isActive: Model.ActiveTab == "submissions",
        contentPartialPath: "~/Views/Forms/FormTemplates/Panels/_SubmissionsPanel.cshtml")
    .BuildTabs();
}

@section Styles {
    <link rel="stylesheet" href="~/css/template-details.css" asp-append-version="true" />
}

<!-- Hidden fields for JavaScript -->
<input type="hidden" id="templateId" value="@Model.TemplateId" />
@if (Model.WorkflowId.HasValue)
{
    <input type="hidden" id="workflowId" value="@Model.WorkflowId" />
}



<!-- Template Header Card -->
<div class="row">
    <div class="col-12">
        <div class="template-header">
            <div class="d-flex align-items-start gap-3">
                <!-- Template Icon -->
                <div class="template-icon bg-primary-subtle text-primary">
                    <i class="ri-file-list-3-line"></i>
                </div>

                <!-- Template Info -->
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <h4 class="template-title mb-0">@Model.TemplateName</h4>
                        <span class="badge @Model.StatusBadgeClass">@Model.PublishStatus</span>
                        <span class="badge @Model.TypeBadgeClass">@Model.TemplateType</span>
                    </div>
                    <div class="template-code">@Model.TemplateCode</div>
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <p class="text-muted mb-0 mt-2">@Model.Description</p>
                    }

                    <!-- Meta Info -->
                    <div class="template-meta">
                        @if (!string.IsNullOrEmpty(Model.CategoryName))
                        {
                            <span class="template-meta-item">
                                <i class="ri-folder-line"></i> @Model.CategoryName
                            </span>
                        }
                        <span class="template-meta-item">
                            <i class="ri-calendar-line"></i> Created @Model.CreatedDate.ToString("MMM dd, yyyy")
                        </span>
                        @if (Model.PublishedDate.HasValue)
                        {
                            <span class="template-meta-item">
                                <i class="ri-check-double-line"></i> Published @Model.PublishedDate.Value.ToString("MMM dd, yyyy")
                            </span>
                        }
                        @if (!string.IsNullOrEmpty(Model.CreatorName))
                        {
                            <span class="template-meta-item">
                                <i class="ri-user-line"></i> @Model.CreatorName
                            </span>
                        }
                        <span class="template-meta-item">
                            <i class="ri-git-branch-line"></i> Version @Model.Version
                        </span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-flex gap-2">
                    @if (Model.IsPublished)
                    {
                        <a href="@Url.Action("StartSubmission", "FormSubmissions", new { templateId = Model.TemplateId })" 
                           class="btn btn-primary">
                            <i class="ri-add-line me-1"></i> New Submission
                        </a>
                    }
                    <div class="dropdown">
                        <button class="btn btn-soft-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="ri-more-2-fill"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="@Url.Action("FormBuilder", "FormTemplates", new { id = Model.TemplateId })">
                                    <i class="ri-edit-line me-2"></i>Edit Template
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#">
                                    <i class="ri-file-copy-line me-2"></i>Duplicate
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#">
                                    <i class="ri-download-line me-2"></i>Export
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#">
                                    <i class="ri-archive-line me-2"></i>Archive
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs Content -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                @{
                    // Store model in ViewData for partials to access
                    ViewData["TemplateDetails"] = Model;
                }
                <partial name="~/Views/Shared/Components/Tabs/_HorizontalTabs.cshtml" model="tabsConfig" />
            </div>
        </div>
    </div>
</div>

<!-- Modal Container (for AJAX-loaded modals) -->
<div id="modalContainer"></div>

@section Scripts {
    <script src="~/js/pages/template-details.js" asp-append-version="true"></script>
}
