@using FormReporting.Extensions
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Models.ViewModels.Forms
@using Microsoft.AspNetCore.Html
@model List<FormReporting.Models.ViewModels.Forms.FormTemplateViewModel>

@{
    ViewData["Title"] = "Form Templates Management";
    
    // Calculate row number starting point
    int startingNumber = ((ViewBag.CurrentPage - 1) * ViewBag.PageSize) + 1;
    
    // Get categories with counts
    var categoriesWithCounts = ViewBag.CategoriesWithCounts as IEnumerable<dynamic> ?? new List<dynamic>();
    int allTemplatesCount = ViewBag.AllTemplatesCount ?? 0;
    
    // Current tab and category filter
    string currentTab = ViewBag.CurrentTab as string ?? "templates";
    string currentCategory = ViewBag.CurrentCategory ?? "";
    
    // ============================================================================
    // BUILD CATEGORY TABS (Server-Side Navigation)
    // ============================================================================
    var categoryTabs = new TabsConfig
    {
        TabsId = "categoryTabs",
        Layout = TabsLayout.Vertical,
        Style = TabsStyle.Pills,
        WrapInCard = false,
        NavigationMode = TabsNavigationMode.ServerSide
    };
    
    // Add "All Templates" tab FIRST (DisplayOrder = 0)
    categoryTabs.Tabs.Add(new TabConfig
    {
        TabId = "all",
        Title = "All Templates",
        Url = Url.Action("Index", "FormTemplates", new { tab = "templates", search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, type = ViewBag.CurrentType }) ?? "/Forms/FormTemplates?tab=templates",
        Icon = "ri-apps-line",
        Badge = allTemplatesCount.ToString(),
        BadgeColor = "light",
        IsActive = string.IsNullOrEmpty(currentCategory),
        DisplayOrder = 0
    });
    
    // Add category tabs dynamically with descriptions (DisplayOrder starts at 1)
    int displayOrder = 1;
    foreach (var cat in categoriesWithCounts)
    {
        string catName = cat.CategoryName;
        string catDescription = cat.Description ?? "";
        string catIcon = cat.IconClass ?? "ri-folder-3-line";
        int catCount = cat.TemplateCount;
        bool isActive = currentCategory.Equals(catName, StringComparison.OrdinalIgnoreCase);
        
        categoryTabs.Tabs.Add(new TabConfig
        {
            TabId = catName.ToLower().Replace(" ", "-"),
            Title = catName,
            Description = catDescription,
            Url = Url.Action("Index", "FormTemplates", new { tab = "templates", search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, type = ViewBag.CurrentType, category = catName.ToLower() }) ?? $"/Forms/FormTemplates?tab=templates&category={catName.ToLower()}",
            Icon = catIcon,
            Badge = catCount.ToString(),
            BadgeColor = "light",
            IsActive = isActive,
            DisplayOrder = displayOrder++
        });
    }
    
    var categoryTabsViewModel = categoryTabs.BuildTabs();

    // ============================================================================
    // STEP 3: HELPER FUNCTION FOR ROW ACTIONS (CONDITIONAL BASED ON STATUS)
    // ============================================================================
    RowActionsViewModel BuildRowActions(FormTemplateViewModel template)
    {
        var actions = new List<RowActionConfig>();

        // ========================================================================
        // DRAFT STATUS: Resume Editing (Continue where they left off)
        // ========================================================================
        if (template.PublishStatus == "Draft")
        {
            // PRIMARY ACTION: Continue Editing (Resume Draft)
            actions.Add(new RowActionConfig
            {
                Text = "Continue Editing",
                IconClass = "ri-play-line",
                ColorClass = "primary",
                UrlTemplate = Url.Action("Create", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Create?id={template.TemplateId}"
            });

            // View Preview
            actions.Add(new RowActionConfig
            {
                Text = "View Preview",
                IconClass = "ri-eye-line",
                ColorClass = "secondary",
                UrlTemplate = Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Preview/{template.TemplateId}"
            });

            // Delete Draft
            actions.Add(new RowActionConfig
            {
                Text = "Delete Draft",
                IconClass = "ri-delete-bin-line",
                ColorClass = "danger",
                RequiresConfirmation = true,
                ConfirmationMessage = $"Are you sure you want to delete draft '{template.TemplateName}'? This action cannot be undone."
            });
        }
        // ========================================================================
        // PUBLISHED STATUS: Edit (Create New Version)
        // ========================================================================
        else if (template.PublishStatus == "Published")
        {
            // PRIMARY ACTION: Edit (Create New Version)
            actions.Add(new RowActionConfig
            {
                Text = $"Edit (Create v{template.Version + 1})",
                IconClass = "ri-git-branch-line",
                ColorClass = "warning",
                UrlTemplate = Url.Action("Edit", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Edit/{template.TemplateId}"
            });

            // View Preview
            actions.Add(new RowActionConfig
            {
                Text = "View Template",
                IconClass = "ri-eye-line",
                ColorClass = "primary",
                UrlTemplate = Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Preview/{template.TemplateId}"
            });

            // View Assignments
            actions.Add(new RowActionConfig
            {
                Text = "View Assignments",
                IconClass = "ri-user-follow-line",
                ColorClass = "info",
                UrlTemplate = Url.Action("Assignments", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Assignments/{template.TemplateId}"
            });

            // View Submissions
            actions.Add(new RowActionConfig
            {
                Text = "View Submissions",
                IconClass = "ri-file-list-3-line",
                ColorClass = "success",
                UrlTemplate = Url.Action("Submissions", "FormSubmissions", new { templateId = template.TemplateId }) ?? $"/FormSubmissions?templateId={template.TemplateId}"
            });

            // Archive
            actions.Add(new RowActionConfig
            {
                Text = "Archive",
                IconClass = "ri-archive-line",
                ColorClass = "danger",
                RequiresConfirmation = true,
                ConfirmationMessage = $"Are you sure you want to archive '{template.TemplateName}'? Archived templates cannot be assigned to new users."
            });
        }
        // ========================================================================
        // ARCHIVED/DEPRECATED STATUS
        // ========================================================================
        else if (template.PublishStatus == "Archived" || template.PublishStatus == "Deprecated")
        {
            // View Preview
            actions.Add(new RowActionConfig
            {
                Text = "View Template",
                IconClass = "ri-eye-line",
                ColorClass = "secondary",
                UrlTemplate = Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Preview/{template.TemplateId}"
            });

            // Create New Version (from archived)
            actions.Add(new RowActionConfig
            {
                Text = "Create New Version",
                IconClass = "ri-git-branch-line",
                ColorClass = "primary",
                UrlTemplate = Url.Action("Edit", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Edit/{template.TemplateId}"
            });

            // Restore (if archived)
            if (template.PublishStatus == "Archived")
            {
                actions.Add(new RowActionConfig
                {
                    Text = "Restore",
                    IconClass = "ri-restart-line",
                    ColorClass = "success",
                    RequiresConfirmation = true,
                    ConfirmationMessage = $"Restore '{template.TemplateName}' to published status?"
                });
            }
        }

        // Clone - available for all statuses
        actions.Add(new RowActionConfig
        {
            Text = "Clone",
            IconClass = "ri-file-copy-line",
            ColorClass = "info",
            UrlTemplate = Url.Action("Clone", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Clone/{template.TemplateId}"
        });

        var config = new RowActionsConfig
        {
            DisplayStyle = RowActionDisplayStyle.Dropdown,
            DropdownText = "",
            DropdownIconClass = "ri-more-fill",
            ButtonSize = "sm",
            UseSoftButtons = true,
            Actions = actions
        };

        return new RowActionsViewModel
        {
            DisplayStyle = config.DisplayStyle,
            DropdownText = config.DropdownText,
            DropdownIconClass = config.DropdownIconClass,
            ButtonSizeClass = $"btn-{config.ButtonSize}",
            UseSoftButtons = config.UseSoftButtons,
            RowId = template.TemplateId.ToString(),
            Actions = config.Actions.Select(a => new RowActionViewModel
            {
                Text = a.Text,
                IconClass = a.IconClass,
                ColorClass = a.ColorClass,
                Url = a.UrlTemplate,
                RequiresConfirmation = a.RequiresConfirmation,
                ConfirmationMessage = a.ConfirmationMessage,
                IconOnly = a.IconOnly,
                IsVisible = true
            }).ToList()
        };
    }
}

@{
    // Store tabs in ViewData for the component
    ViewData["TabsViewModel"] = categoryTabsViewModel;
    
    // Pass data needed by the content partial
    ViewData["StartingNumber"] = startingNumber;
    ViewData["ParentModel"] = Model;
    
    // Set the content partial path for server-side navigation
    ViewData["ServerSideContentPartial"] = "~/Views/Forms/FormTemplates/Partials/_TemplatesContent.cshtml";
}

<style>
    /* Main tabs styling */
    .main-tabs .nav-link {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        color: #495057;
        border: none;
        border-bottom: 2px solid transparent;
        background: transparent;
    }
    
    .main-tabs .nav-link:hover {
        color: var(--vz-primary);
        border-bottom-color: var(--vz-primary-bg-subtle);
    }
    
    .main-tabs .nav-link.active {
        color: var(--vz-primary);
        border-bottom-color: var(--vz-primary);
        background: transparent;
    }
    
    .main-tabs .nav-link i {
        font-size: 16px;
    }
    
    /* Tab content area */
    .tab-content-area {
        min-height: 400px;
    }
    
    /* ============================================
       CONFIGURATION DISPLAY STYLES
       ============================================ */
    
    /* DataTable Config Cell */
    .config-cell {
        min-width: 140px;
    }
    
    .config-cell .badge-sm {
        font-size: 10px;
        padding: 0.2em 0.4em;
    }
    
    /* Clickable Config Icons (DataTable) */
    .config-icon-link {
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        font-size: 12px;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .config-icon-link.configured {
        background-color: rgba(var(--vz-success-rgb), 0.15);
        color: var(--vz-success);
    }
    
    .config-icon-link.configured:hover {
        background-color: rgba(var(--vz-success-rgb), 0.25);
    }
    
    .config-icon-link.not-configured {
        background-color: rgba(var(--vz-secondary-rgb), 0.1);
        color: var(--vz-secondary);
    }
    
    .config-icon-link.not-configured:hover {
        background-color: rgba(var(--vz-primary-rgb), 0.15);
        color: var(--vz-primary);
    }
    
    /* Template Config Card Styles */
    .template-config-card {
        border: 2px solid #e9ecef !important;
        transition: all 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
    }
    
    .template-config-card:hover {
        border-color: var(--vz-primary) !important;
        box-shadow: 0 5px 15px rgba(var(--vz-primary-rgb), 0.1) !important;
    }
    
    .template-config-card .card-header {
        background: transparent;
    }
    
    .template-config-card .card-body {
        flex: 1;
    }
    
    .template-config-card .card-footer {
        background: transparent;
        border-top: 1px solid #e9ecef;
    }
    
    /* Config Items (Card) */
    .config-items {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .config-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        text-decoration: none;
        transition: all 0.2s ease;
        background-color: #f8f9fa;
    }
    
    .config-item:hover {
        background-color: rgba(var(--vz-primary-rgb), 0.1);
    }
    
    .config-item.configured {
        background-color: rgba(var(--vz-success-rgb), 0.08);
    }
    
    .config-item.configured:hover {
        background-color: rgba(var(--vz-success-rgb), 0.15);
    }
    
    .config-item-icon {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        margin-right: 0.75rem;
        font-size: 14px;
    }
    
    .config-item.configured .config-item-icon {
        background-color: rgba(var(--vz-success-rgb), 0.15);
        color: var(--vz-success);
    }
    
    .config-item.not-configured .config-item-icon {
        background-color: rgba(var(--vz-secondary-rgb), 0.15);
        color: var(--vz-secondary);
    }
    
    .config-item-content {
        flex: 1;
        min-width: 0;
    }
    
    .config-item-title {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #495057;
    }
    
    .config-item-detail {
        display: block;
        font-size: 11px;
        color: #878a99;
    }
    
    .config-item.configured .config-item-detail {
        color: var(--vz-success);
    }
    
    .config-item-status {
        margin-left: 0.5rem;
        font-size: 16px;
    }
    
    /* Dropdown item with status icon */
    .dropdown-item {
        display: flex;
        align-items: center;
    }
    
    .dropdown-item .ms-auto {
        margin-left: auto !important;
    }
</style>

<!-- ============================================================================ -->
<!-- MAIN TABS: Overview | Templates -->
<!-- ============================================================================ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header border-bottom">
                <ul class="nav nav-tabs-custom main-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link @(currentTab == "overview" ? "active" : "")" 
                           data-bs-toggle="tab" 
                           href="#overview-tab" 
                           role="tab"
                           aria-selected="@(currentTab == "overview" ? "true" : "false")">
                            <i class="ri-dashboard-line me-1"></i> Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(currentTab == "templates" ? "active" : "")" 
                           data-bs-toggle="tab" 
                           href="#templates-tab" 
                           role="tab"
                           aria-selected="@(currentTab == "templates" ? "true" : "false")">
                            <i class="ri-file-list-3-line me-1"></i> Templates
                            <span class="badge bg-primary-subtle text-primary ms-1">@allTemplatesCount</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content tab-content-area">
                    
                    <!-- ============================================================ -->
                    <!-- OVERVIEW TAB -->
                    <!-- ============================================================ -->
                    <div class="tab-pane fade @(currentTab == "overview" ? "show active" : "")" 
                         id="overview-tab" 
                         role="tabpanel">
                        @await Html.PartialAsync("~/Views/Forms/FormTemplates/Partials/_TemplatesOverview.cshtml")
                    </div>
                    
                    <!-- ============================================================ -->
                    <!-- TEMPLATES TAB -->
                    <!-- ============================================================ -->
                    <div class="tab-pane fade @(currentTab == "templates" ? "show active" : "")" 
                         id="templates-tab" 
                         role="tabpanel">
                        @await Html.PartialAsync("~/Views/Shared/Components/Tabs/_VerticalTabs.cshtml", categoryTabsViewModel)
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // View toggle functionality
            var storageKey = 'templateViewPreference';
            var savedView = localStorage.getItem(storageKey) || 'table';
            
            // Apply saved preference
            switchView(savedView);
            
            // Toggle click handler
            $('.view-toggle-btn').on('click', function() {
                var view = $(this).data('view');
                switchView(view);
                localStorage.setItem(storageKey, view);
            });
            
            function switchView(view) {
                $('.view-toggle-btn').removeClass('active');
                $('.view-toggle-btn[data-view="' + view + '"]').addClass('active');
                
                if (view === 'table') {
                    $('#tableView').show();
                    $('#cardView').hide();
                } else {
                    $('#tableView').hide();
                    $('#cardView').show();
                }
            }
        });
    </script>
}
