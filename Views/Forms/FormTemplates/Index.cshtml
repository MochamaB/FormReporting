@using FormReporting.Extensions
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Models.ViewModels.Forms
@using Microsoft.AspNetCore.Html
@model List<FormReporting.Models.ViewModels.Forms.FormTemplateViewModel>

@{
    ViewData["Title"] = "Form Templates Management";
    
    // Calculate row number starting point
    int startingNumber = ((ViewBag.CurrentPage - 1) * ViewBag.PageSize) + 1;
    
    // Get categories with counts
    var categoriesWithCounts = ViewBag.CategoriesWithCounts as IEnumerable<dynamic> ?? new List<dynamic>();
    int allTemplatesCount = ViewBag.AllTemplatesCount ?? 0;
    
    // Current category filter
    string currentCategory = ViewBag.CurrentCategory ?? "";
    
    // ============================================================================
    // BUILD CATEGORY TABS (Server-Side Navigation)
    // ============================================================================
    var categoryTabs = new TabsConfig
    {
        TabsId = "categoryTabs",
        Layout = TabsLayout.Vertical,
        Style = TabsStyle.Pills,
        WrapInCard = false,
        NavigationMode = TabsNavigationMode.ServerSide
    };
    
    // Add "All Templates" tab
    categoryTabs.WithNavigationTab(
        tabId: "all",
        title: "All Templates",
        url: Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, type = ViewBag.CurrentType }) ?? "/Forms/FormTemplates",
        icon: "ri-folder-line",
        badge: allTemplatesCount.ToString(),
        badgeColor: "light",
        isActive: string.IsNullOrEmpty(currentCategory)
    );
    
    // Add category tabs dynamically
    foreach (var cat in categoriesWithCounts)
    {
        string catName = cat.CategoryName;
        int catCount = cat.TemplateCount;
        bool isActive = currentCategory.Equals(catName, StringComparison.OrdinalIgnoreCase);
        
        categoryTabs.WithNavigationTab(
            tabId: catName.ToLower().Replace(" ", "-"),
            title: catName,
            url: Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, type = ViewBag.CurrentType, category = catName.ToLower() }) ?? $"/Forms/FormTemplates?category={catName.ToLower()}",
            icon: "ri-folder-3-line",
            badge: catCount.ToString(),
            badgeColor: "light",
            isActive: isActive
        );
    }
    
    var categoryTabsViewModel = categoryTabs.BuildTabs();

    // ============================================================================
    // STEP 3: HELPER FUNCTION FOR ROW ACTIONS (CONDITIONAL BASED ON STATUS)
    // ============================================================================
    RowActionsViewModel BuildRowActions(FormTemplateViewModel template)
    {
        var actions = new List<RowActionConfig>();

        // ========================================================================
        // DRAFT STATUS: Resume Editing (Continue where they left off)
        // ========================================================================
        if (template.PublishStatus == "Draft")
        {
            // PRIMARY ACTION: Continue Editing (Resume Draft)
            actions.Add(new RowActionConfig
            {
                Text = "Continue Editing",
                IconClass = "ri-play-line",
                ColorClass = "primary",
                UrlTemplate = Url.Action("Create", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Create?id={template.TemplateId}"
            });

            // View Preview
            actions.Add(new RowActionConfig
            {
                Text = "View Preview",
                IconClass = "ri-eye-line",
                ColorClass = "secondary",
                UrlTemplate = Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Preview/{template.TemplateId}"
            });

            // Delete Draft
            actions.Add(new RowActionConfig
            {
                Text = "Delete Draft",
                IconClass = "ri-delete-bin-line",
                ColorClass = "danger",
                RequiresConfirmation = true,
                ConfirmationMessage = $"Are you sure you want to delete draft '{template.TemplateName}'? This action cannot be undone."
            });
        }
        // ========================================================================
        // PUBLISHED STATUS: Edit (Create New Version)
        // ========================================================================
        else if (template.PublishStatus == "Published")
        {
            // PRIMARY ACTION: Edit (Create New Version)
            actions.Add(new RowActionConfig
            {
                Text = $"Edit (Create v{template.Version + 1})",
                IconClass = "ri-git-branch-line",
                ColorClass = "warning",
                UrlTemplate = Url.Action("Edit", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Edit/{template.TemplateId}"
            });

            // View Preview
            actions.Add(new RowActionConfig
            {
                Text = "View Template",
                IconClass = "ri-eye-line",
                ColorClass = "primary",
                UrlTemplate = Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Preview/{template.TemplateId}"
            });

            // View Assignments
            actions.Add(new RowActionConfig
            {
                Text = "View Assignments",
                IconClass = "ri-user-follow-line",
                ColorClass = "info",
                UrlTemplate = Url.Action("Assignments", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Assignments/{template.TemplateId}"
            });

            // View Submissions
            actions.Add(new RowActionConfig
            {
                Text = "View Submissions",
                IconClass = "ri-file-list-3-line",
                ColorClass = "success",
                UrlTemplate = Url.Action("Submissions", "FormSubmissions", new { templateId = template.TemplateId }) ?? $"/FormSubmissions?templateId={template.TemplateId}"
            });

            // Archive
            actions.Add(new RowActionConfig
            {
                Text = "Archive",
                IconClass = "ri-archive-line",
                ColorClass = "danger",
                RequiresConfirmation = true,
                ConfirmationMessage = $"Are you sure you want to archive '{template.TemplateName}'? Archived templates cannot be assigned to new users."
            });
        }
        // ========================================================================
        // ARCHIVED/DEPRECATED STATUS
        // ========================================================================
        else if (template.PublishStatus == "Archived" || template.PublishStatus == "Deprecated")
        {
            // View Preview
            actions.Add(new RowActionConfig
            {
                Text = "View Template",
                IconClass = "ri-eye-line",
                ColorClass = "secondary",
                UrlTemplate = Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Preview/{template.TemplateId}"
            });

            // Create New Version (from archived)
            actions.Add(new RowActionConfig
            {
                Text = "Create New Version",
                IconClass = "ri-git-branch-line",
                ColorClass = "primary",
                UrlTemplate = Url.Action("Edit", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Edit/{template.TemplateId}"
            });

            // Restore (if archived)
            if (template.PublishStatus == "Archived")
            {
                actions.Add(new RowActionConfig
                {
                    Text = "Restore",
                    IconClass = "ri-restart-line",
                    ColorClass = "success",
                    RequiresConfirmation = true,
                    ConfirmationMessage = $"Restore '{template.TemplateName}' to published status?"
                });
            }
        }

        // Clone - available for all statuses
        actions.Add(new RowActionConfig
        {
            Text = "Clone",
            IconClass = "ri-file-copy-line",
            ColorClass = "info",
            UrlTemplate = Url.Action("Clone", "FormTemplates", new { id = template.TemplateId }) ?? $"/FormTemplates/Clone/{template.TemplateId}"
        });

        var config = new RowActionsConfig
        {
            DisplayStyle = RowActionDisplayStyle.Dropdown,
            DropdownText = "",
            DropdownIconClass = "ri-more-fill",
            ButtonSize = "sm",
            UseSoftButtons = true,
            Actions = actions
        };

        return new RowActionsViewModel
        {
            DisplayStyle = config.DisplayStyle,
            DropdownText = config.DropdownText,
            DropdownIconClass = config.DropdownIconClass,
            ButtonSizeClass = $"btn-{config.ButtonSize}",
            UseSoftButtons = config.UseSoftButtons,
            RowId = template.TemplateId.ToString(),
            Actions = config.Actions.Select(a => new RowActionViewModel
            {
                Text = a.Text,
                IconClass = a.IconClass,
                ColorClass = a.ColorClass,
                Url = a.UrlTemplate,
                RequiresConfirmation = a.RequiresConfirmation,
                ConfirmationMessage = a.ConfirmationMessage,
                IconOnly = a.IconOnly,
                IsVisible = true
            }).ToList()
        };
    }
}

@{
    // Store tabs in ViewData for the component
    ViewData["TabsViewModel"] = categoryTabsViewModel;
    
    // Pass data needed by the content partial
    ViewData["StartingNumber"] = startingNumber;
    ViewData["ParentModel"] = Model;
    
    // Set the content partial path for server-side navigation
    ViewData["ServerSideContentPartial"] = "~/Views/Forms/FormTemplates/Partials/_TemplatesContent.cshtml";
}

<!-- ============================================================================ -->
<!-- MAIN LAYOUT: Using Vertical Tabs Component -->
<!-- ============================================================================ -->
@await Html.PartialAsync("~/Views/Shared/Components/Tabs/_VerticalTabs.cshtml", categoryTabsViewModel)

<style>
    /* Configuration status icons */
    .config-status-icon {
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        font-size: 12px;
    }
    .config-status-icon.configured {
        background-color: rgba(var(--vz-success-rgb), 0.15);
        color: var(--vz-success);
    }
    .config-status-icon.not-configured {
        background-color: rgba(var(--vz-secondary-rgb), 0.1);
        color: var(--vz-secondary);
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // View toggle functionality
            var storageKey = 'templateViewPreference';
            var savedView = localStorage.getItem(storageKey) || 'table';
            
            // Apply saved preference
            switchView(savedView);
            
            // Toggle click handler
            $('.view-toggle-btn').on('click', function() {
                var view = $(this).data('view');
                switchView(view);
                localStorage.setItem(storageKey, view);
            });
            
            function switchView(view) {
                $('.view-toggle-btn').removeClass('active');
                $('.view-toggle-btn[data-view="' + view + '"]').addClass('active');
                
                if (view === 'table') {
                    $('#tableView').show();
                    $('#cardView').hide();
                } else {
                    $('#tableView').hide();
                    $('#cardView').show();
                }
            }
        });
    </script>
}
