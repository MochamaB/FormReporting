@model FormReporting.Models.ViewModels.Metrics.FieldMappingWizardViewModel

@{
    var parentModel = ViewData["ParentModel"] as FormReporting.Models.ViewModels.Metrics.FieldMappingWizardViewModel ?? Model;
    var existingMapping = parentModel?.ExistingMappings?.FirstOrDefault();
    var recommendedType = parentModel?.RecommendedMappingType ?? "Direct";
    
    // Default mapping name suggestion
    var defaultMappingName = existingMapping?.MappingName ?? $"{parentModel?.FieldName} Mapping";
    var selectedMappingType = existingMapping?.MappingType ?? recommendedType;
    var selectedOutputType = existingMapping?.OutputType ?? "Raw";
}

<!-- Step 1: Configure Mapping -->
<div class="configure-step">
    
    <!-- Recommendation Alert -->
    @if (parentModel?.ValidMappingTypes?.Any(t => t.IsRecommended) == true)
    {
        var recommended = parentModel.ValidMappingTypes.First(t => t.IsRecommended);
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
            <div class="d-flex align-items-start">
                <i class="ri-lightbulb-line fs-4 me-3"></i>
                <div>
                    <h6 class="alert-heading mb-1">Recommendation</h6>
                    <p class="mb-0">
                        Based on the field type <strong>@parentModel.DataType</strong>, 
                        we recommend using <strong>@recommended.Text</strong> mapping.
                    </p>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

   

    <!-- Mapping Type -->
    <div class="mb-4">
        <label for="MappingType" class="form-label">
            Mapping Type <span class="text-danger">*</span>
        </label>
        <select class="form-select" id="MappingType" name="MappingType" required>
            <option value="">Select mapping type...</option>
            @if (parentModel?.ValidMappingTypes != null)
            {
                @foreach (var mappingType in parentModel.ValidMappingTypes)
                {
                    var isSelected = mappingType.Value == selectedMappingType;
                    <option value="@mappingType.Value" 
                            data-description="@mappingType.Description"
                            selected="@isSelected">
                        @mappingType.Text
                        @if (mappingType.IsRecommended)
                        {
                            @: (Recommended)
                        }
                    </option>
                }
            }
        </select>
        <div class="form-text" id="mappingTypeDescription">
            @{
                var selectedTypeInfo = parentModel?.ValidMappingTypes?.FirstOrDefault(t => t.Value == selectedMappingType);
                @(selectedTypeInfo?.Description ?? "Select a mapping type to see its description.")
            }
        </div>
    </div>

    <!-- Output Type -->
    <div class="mb-4">
        <label for="OutputType" class="form-label">
            Output Type <span class="text-danger">*</span>
        </label>
        <select class="form-select" id="OutputType" name="OutputType" required>
            <option value="">Select output type...</option>
            <option value="Raw" selected="@(selectedOutputType == "Raw")">Raw - Use original field value</option>
            <option value="Percentage" selected="@(selectedOutputType == "Percentage")">Percentage - Convert to percentage format</option>
            <option value="Normalized" selected="@(selectedOutputType == "Normalized")">Normalized - Scale to 0-100 range</option>
        </select>
        <div class="form-text">How the field value should be processed for reporting.</div>
    </div>

    <!-- Expected Value Section (for Expected mapping type) -->
    <div class="mb-4" id="expectedValueSection" style="display: @(selectedMappingType == "Expected" ? "block" : "none");">
        <div class="card border-info">
            <div class="card-header bg-info-subtle">
                <h6 class="mb-0"><i class="ri-checkbox-circle-line me-2"></i>Expected Value Configuration</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="ComparisonOperator" class="form-label">
                            Comparison <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="ComparisonOperator" name="ComparisonOperator">
                            <option value="=" selected="@(existingMapping?.ComparisonOperator == "=")">= (Equals)</option>
                            <option value="!=" selected="@(existingMapping?.ComparisonOperator == "!=")">!= (Not Equals)</option>
                            <option value=">" selected="@(existingMapping?.ComparisonOperator == ">")"> &gt; (Greater Than)</option>
                            <option value=">=" selected="@(existingMapping?.ComparisonOperator == ">=")"> &gt;= (Greater or Equal)</option>
                            <option value="<" selected="@(existingMapping?.ComparisonOperator == "<")"> &lt; (Less Than)</option>
                            <option value="<=" selected="@(existingMapping?.ComparisonOperator == "<=")"> &lt;= (Less or Equal)</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label for="ExpectedValue" class="form-label">
                            Expected Value <span class="text-danger">*</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="ExpectedValue"
                               name="ExpectedValue"
                               value="@existingMapping?.ExpectedValue"
                               placeholder="e.g., Yes, Compliant, True, 100" />
                    </div>
                </div>
                <div class="form-text mt-2">
                    <i class="ri-information-line me-1"></i>
                    Define the expected value and comparison type. Field responses matching this criteria will be marked as compliant/successful.
                </div>
            </div>
        </div>
    </div>
     <!-- Mapping Name -->
    <div class="mb-4">
        <label for="MappingName" class="form-label">
            Mapping Name <span class="text-danger">*</span>
        </label>
        <input type="text" 
               class="form-control" 
               id="MappingName" 
               name="MappingName" 
               value="@defaultMappingName"
               placeholder="Enter a descriptive name for this mapping"
               required />
        <div class="form-text">A descriptive name to identify this mapping in reports.</div>
    </div>

    <!-- Configuration Summary -->
    <div class="card bg-light border-0 mt-4">
        <div class="card-body">
            <h6 class="card-title">
                <i class="ri-file-list-3-line me-2"></i>Configuration Summary
            </h6>
            <div class="row">
                <div class="col-md-4">
                    <small class="text-muted">Mapping Name</small>
                    <div id="summaryMappingName" class="fw-medium">@defaultMappingName</div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Mapping Type</small>
                    <div id="summaryMappingType" class="fw-medium">@(selectedTypeInfo?.Text ?? "-")</div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Output Type</small>
                    <div id="summaryOutputType" class="fw-medium">@selectedOutputType</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update mapping type description on change
    const mappingTypeSelect = document.getElementById('MappingType');
    const descriptionDiv = document.getElementById('mappingTypeDescription');
    const expectedValueSection = document.getElementById('expectedValueSection');
    
    if (mappingTypeSelect) {
        mappingTypeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const description = selectedOption.getAttribute('data-description') || 'Select a mapping type to see its description.';
            descriptionDiv.textContent = description;

            // Show/hide expected value section for "Expected" mapping type
            if (this.value === 'Expected') {
                expectedValueSection.style.display = 'block';
            } else {
                expectedValueSection.style.display = 'none';
            }

            // Update summary
            document.getElementById('summaryMappingType').textContent = selectedOption.text || '-';
        });
    }
    
    // Auto-generate mapping name based on selections
    function generateMappingName() {
        const mappingTypeSelect = document.getElementById('MappingType');
        const outputTypeSelect = document.getElementById('OutputType');
        const mappingNameInput = document.getElementById('MappingName');
        
        if (!mappingTypeSelect || !outputTypeSelect || !mappingNameInput) return;
        
        const mappingType = mappingTypeSelect.value;
        const outputType = outputTypeSelect.value;
        const fieldDataType = '@(parentModel?.DataType ?? "Value")';
        
        if (mappingType && outputType) {
            // Format: [Value] - [MappingType] ([OutputType])
            // Example: "Text - Direct (Raw)" or "Number - Expected (Percentage)"
            const generatedName = `${fieldDataType} - ${mappingType} (${outputType})`;
            mappingNameInput.value = generatedName;
            
            // Update summary
            document.getElementById('summaryMappingName').textContent = generatedName;
        }
    }
    
    // Attach listeners to regenerate name when selections change
    if (mappingTypeSelect) {
        mappingTypeSelect.addEventListener('change', generateMappingName);
    }
    
    const outputTypeSelect = document.getElementById('OutputType');
    if (outputTypeSelect) {
        outputTypeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            document.getElementById('summaryOutputType').textContent = selectedOption.text.split(' - ')[0] || '-';
            
            // Regenerate mapping name
            generateMappingName();
        });
    }
    
    // Update summary on manual input changes
    const mappingNameInput = document.getElementById('MappingName');
    if (mappingNameInput) {
        mappingNameInput.addEventListener('input', function() {
            document.getElementById('summaryMappingName').textContent = this.value || '-';
        });
    }
    
    // Generate initial name on page load if both selections exist
    generateMappingName();
});
</script>
