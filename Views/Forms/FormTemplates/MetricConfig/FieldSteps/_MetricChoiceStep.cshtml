@model FormReporting.Models.ViewModels.Metrics.FieldMappingWizardViewModel

@{
    var parentModel = ViewData["ParentModel"] as FormReporting.Models.ViewModels.Metrics.FieldMappingWizardViewModel ?? Model;
    var existingMapping = parentModel?.ExistingMapping;
    var compatibleMetrics = parentModel?.CompatibleMetrics ?? new List<FormReporting.Models.ViewModels.Metrics.CompatibleMetricViewModel>();
    
    // Determine current metric option
    var currentMetricOption = "standalone";
    if (existingMapping?.MetricId != null)
    {
        currentMetricOption = "link-existing";
    }
}

<!-- Step 2: Choose Metric -->
<div class="metric-choice-step">
    
    <!-- Metric Option Selector -->
    <div class="mb-4">
        <label for="MetricOption" class="form-label">
            Metric Option <span class="text-danger">*</span>
        </label>
        <select class="form-select" id="MetricOption" name="MetricOption" required>
            <option value="standalone" selected="@(currentMetricOption == "standalone")">
                Keep Standalone - Track field values without linking to a metric
            </option>
            <option value="create-new" selected="@(currentMetricOption == "create-new")">
                Create New Metric - Define a new metric for this field
            </option>
            <option value="link-existing" selected="@(currentMetricOption == "link-existing")">
                Link to Existing Metric - Connect to an existing metric definition
            </option>
        </select>
        <div class="form-text">Choose how this field mapping should relate to metrics.</div>
    </div>

    <!-- Option Content Sections -->
    
    <!-- Standalone Content -->
    <div id="standaloneContent" class="metric-option-content @(currentMetricOption != "standalone" ? "d-none" : "")">
        <div class="card border-secondary">
            <div class="card-body">
                <h6 class="card-title text-secondary">
                    <i class="ri-checkbox-circle-line me-2"></i>Standalone Mapping
                </h6>
                <p class="text-muted mb-0">
                    The field values will be tracked independently without linking to a formal metric definition.
                    This is useful for simple data collection where you don't need threshold-based reporting.
                </p>
                <div class="alert alert-light mt-3 mb-0">
                    <i class="ri-information-line me-2"></i>
                    You can always link to a metric later by editing this mapping.
                </div>
            </div>
        </div>
    </div>

    <!-- Create New Metric Content -->
    <div id="createNewContent" class="metric-option-content @(currentMetricOption != "create-new" ? "d-none" : "")">
        <div class="card border-success">
            <div class="card-body">
                <h6 class="card-title text-success">
                    <i class="ri-add-circle-line me-2"></i>Create New Metric Definition
                </h6>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="NewMetricName" class="form-label">Metric Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="NewMetricName" name="NewMetricName" 
                                   value="@(parentModel?.FieldName) Performance Index"
                                   placeholder="e.g., Field Performance Index" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="NewMetricCode" class="form-label">Metric Code</label>
                            <input type="text" class="form-control" id="NewMetricCode" name="NewMetricCode" 
                                   placeholder="Auto-generated" readonly />
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="NewMetricDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="NewMetricDescription" name="NewMetricDescription" rows="2" 
                              placeholder="Describe what this metric measures">Measures the performance and quality of @(parentModel?.FieldName?.ToLower()) based on field responses.</textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="NewMetricCategoryId" class="form-label">Category</label>
                            <select class="form-select" id="NewMetricCategoryId" name="NewMetricCategoryId">
                                <option value="">-- Select Category --</option>
                                @if (ViewBag.MetricCategories != null)
                                {
                                    foreach (var category in ViewBag.MetricCategories)
                                    {
                                        <option value="@category.CategoryId">@category.CategoryName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="NewMetricDataType" class="form-label">Data Type</label>
                            <select class="form-select" id="NewMetricDataType" name="NewMetricDataType">
                                <option value="Decimal">Decimal</option>
                                <option value="Integer">Integer</option>
                                <option value="Percentage">Percentage</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="NewMetricUnitId" class="form-label">Unit</label>
                            <select class="form-select" id="NewMetricUnitId" name="NewMetricUnitId">
                                <option value="">-- Select Unit --</option>
                                @if (ViewBag.MetricUnits != null)
                                {
                                    foreach (var unit in ViewBag.MetricUnits)
                                    {
                                        <option value="@unit.UnitId">@unit.UnitName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                </div>
                
                <hr />
                <h6 class="text-muted mb-3">KPI Settings</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="NewMetricIsKPI" name="NewMetricIsKPI" value="true" />
                                <label class="form-check-label" for="NewMetricIsKPI">
                                    <strong>Track as KPI</strong>
                                </label>
                            </div>
                            <small class="text-muted">Enable to track this metric as a Key Performance Indicator with thresholds.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="NewMetricAggregationType" class="form-label">Aggregation Type</label>
                            <select class="form-select" id="NewMetricAggregationType" name="NewMetricAggregationType">
                                <option value="">Use mapping aggregation type</option>
                                <option value="Sum">Sum</option>
                                <option value="Average">Average</option>
                                <option value="Count">Count</option>
                                <option value="Min">Min</option>
                                <option value="Max">Max</option>
                                <option value="Latest">Latest</option>
                                <option value="Percentage">Percentage</option>
                            </select>
                            <small class="text-muted">How to aggregate values across submissions.</small>
                        </div>
                    </div>
                </div>

                <div id="thresholdSection">
                    <h6 class="text-muted mb-3">Thresholds</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="NewMetricGreen" class="form-label text-success">
                                    <i class="ri-checkbox-circle-fill me-1"></i>Green (Good)
                                </label>
                                <input type="number" class="form-control" id="NewMetricGreen" name="NewMetricGreen" 
                                       value="90" step="0.01" />
                                <small class="text-muted">Values at or above this are good</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="NewMetricYellow" class="form-label text-warning">
                                    <i class="ri-error-warning-fill me-1"></i>Yellow (Warning)
                                </label>
                                <input type="number" class="form-control" id="NewMetricYellow" name="NewMetricYellow" 
                                       value="60" step="0.01" />
                                <small class="text-muted">Values between yellow and green</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="NewMetricRed" class="form-label text-danger">
                                    <i class="ri-close-circle-fill me-1"></i>Red (Critical)
                                </label>
                                <input type="number" class="form-control" id="NewMetricRed" name="NewMetricRed" 
                                       value="30" step="0.01" />
                                <small class="text-muted">Values below this are critical</small>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-light mb-0">
                        <i class="ri-lightbulb-line me-2"></i>
                        <strong>Tip:</strong> For percentage metrics, use values like 90/60/30. For ratings (1-5), use 4/3/2.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Existing Metric Content -->
    <div id="linkExistingContent" class="metric-option-content @(currentMetricOption != "link-existing" ? "d-none" : "")">
        <div class="card border-primary">
            <div class="card-body">
                <h6 class="card-title text-primary">
                    <i class="ri-link me-2"></i>Link to Existing Metric
                </h6>
                
                @if (compatibleMetrics.Any())
                {
                    <div class="mb-3">
                        <label for="MetricId" class="form-label">Select Metric <span class="text-danger">*</span></label>
                        <select class="form-select" id="MetricId" name="MetricId">
                            <option value="">Choose a metric...</option>
                            @foreach (var metric in compatibleMetrics)
                            {
                                var isSelected = existingMapping?.MetricId == metric.MetricId;
                                <option value="@metric.MetricId" 
                                        data-category="@metric.CategoryName"
                                        data-description="@metric.Description"
                                        selected="@isSelected">
                                    @metric.MetricName (@metric.MetricCode)
                                </option>
                            }
                        </select>
                    </div>
                    
                    <div id="selectedMetricDetails" class="alert alert-light d-none">
                        <h6 class="alert-heading">Selected Metric Details</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Category</small>
                                <div id="metricDetailCategory" class="fw-medium">-</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Description</small>
                                <div id="metricDetailDescription" class="fw-medium">-</div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        <h6 class="alert-heading">No Compatible Metrics Found</h6>
                        <p class="mb-0">
                            There are no existing metrics compatible with this field type. 
                            Consider creating a new metric instead.
                        </p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate metric code from name
    const metricNameInput = document.getElementById('NewMetricName');
    const metricCodeInput = document.getElementById('NewMetricCode');
    
    if (metricNameInput && metricCodeInput) {
        function generateCode(name) {
            if (!name) return '';
            return name
                .replace(/[^a-zA-Z0-9\s]/g, '')
                .trim()
                .split(/\s+/)
                .map(word => word.toUpperCase())
                .join('_');
        }
        
        // Initial generation
        metricCodeInput.value = generateCode(metricNameInput.value);
        
        metricNameInput.addEventListener('input', function() {
            metricCodeInput.value = generateCode(this.value);
        });
    }
    
    // Show metric details when selected
    const metricSelect = document.getElementById('MetricId');
    const detailsDiv = document.getElementById('selectedMetricDetails');
    
    if (metricSelect && detailsDiv) {
        metricSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (this.value) {
                document.getElementById('metricDetailCategory').textContent = selectedOption.getAttribute('data-category') || '-';
                document.getElementById('metricDetailDescription').textContent = selectedOption.getAttribute('data-description') || '-';
                detailsDiv.classList.remove('d-none');
            } else {
                detailsDiv.classList.add('d-none');
            }
        });
        
        // Trigger on load if value exists
        if (metricSelect.value) {
            metricSelect.dispatchEvent(new Event('change'));
        }
    }

    // ===================================================================
    // Threshold Auto-Suggestion based on Data Type and Aggregation Type
    // ===================================================================
    const dataTypeSelect = document.getElementById('NewMetricDataType');
    const aggregationTypeSelect = document.getElementById('NewMetricAggregationType');
    const greenInput = document.getElementById('NewMetricGreen');
    const yellowInput = document.getElementById('NewMetricYellow');
    const redInput = document.getElementById('NewMetricRed');
    const isKPICheckbox = document.getElementById('NewMetricIsKPI');
    const thresholdSection = document.getElementById('thresholdSection');

    function suggestThresholds() {
        if (!dataTypeSelect || !greenInput || !yellowInput || !redInput) return;

        const dataType = dataTypeSelect.value;
        const aggregationType = aggregationTypeSelect ? aggregationTypeSelect.value : '';

        // Update default values based on data type and aggregation
        if (dataType === 'Percentage' || aggregationType === 'Percentage') {
            // Percentage-based thresholds (0-100)
            if (!greenInput.dataset.userModified) greenInput.value = '90';
            if (!yellowInput.dataset.userModified) yellowInput.value = '60';
            if (!redInput.dataset.userModified) redInput.value = '30';
        } else if (dataType === 'Integer' && aggregationType === 'Average') {
            // Rating-like scale (1-5)
            if (!greenInput.dataset.userModified) greenInput.value = '4';
            if (!yellowInput.dataset.userModified) yellowInput.value = '3';
            if (!redInput.dataset.userModified) redInput.value = '2';
        }
        // Keep existing values if user has modified them
    }
    
    // Track user modifications to threshold fields
    [greenInput, yellowInput, redInput].forEach(function(input) {
        if (input) {
            input.addEventListener('input', function() {
                this.dataset.userModified = 'true';
            });
        }
    });

    // Toggle threshold section visibility based on IsKPI
    function toggleThresholdSection() {
        if (!thresholdSection || !isKPICheckbox) return;
        
        if (isKPICheckbox.checked) {
            thresholdSection.style.display = 'block';
            suggestThresholds();
        } else {
            thresholdSection.style.display = 'block'; // Keep visible but optional
        }
    }

    // Event listeners
    if (dataTypeSelect) {
        dataTypeSelect.addEventListener('change', suggestThresholds);
    }
    if (aggregationTypeSelect) {
        aggregationTypeSelect.addEventListener('change', suggestThresholds);
    }
    if (isKPICheckbox) {
        isKPICheckbox.addEventListener('change', toggleThresholdSection);
    }

    // Initial call
    suggestThresholds();
    toggleThresholdSection();
});
</script>
