@model FormReporting.Models.ViewModels.Metrics.MetricConfigurationViewModel

<!-- Field-Level Metrics Step -->
<div class="field-level-step">
    

    <!-- Progress Overview -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-0 bg-primary-subtle">
                <div class="card-body text-center py-3">
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: @(Model.FieldProgress)%"></div>
                    </div>
                    <div class="fw-bold text-primary">@Model.ConfiguredFields/@Model.TotalFields</div>
                    <small class="text-muted">Fields Mapped</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-info-subtle">
                <div class="card-body text-center py-3">
                    <div class="fw-bold text-info">@Model.Sections.Sum(s => s.ConfiguredFieldCount)</div>
                    <small class="text-muted">Total Mappings</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-success-subtle">
                <div class="card-body text-center py-3">
                    <div class="fw-bold text-success">@Model.Sections.Count(s => s.ConfiguredFieldCount > 0)</div>
                    <small class="text-muted">Active Sections</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Sections with Fields - Accordion Layout -->
    <div class="accordion accordion-flush" id="fieldSectionsAccordion">
        @{ var sectionIndex = 0; }
        @foreach (var templateSection in Model.Sections.OrderBy(s => s.DisplayOrder))
        {
            var collapseId = $"section-collapse-{templateSection.SectionId}";
            var headerId = $"section-header-{templateSection.SectionId}";
            var isFirstSection = sectionIndex == 0;
            var statusClass = templateSection.ConfiguredFieldCount == templateSection.TotalFieldCount ? "success" : templateSection.ConfiguredFieldCount > 0 ? "warning" : "secondary";
            
            <div class="accordion-item">
                <h2 class="accordion-header" id="@headerId">
                    <button class="accordion-button @(isFirstSection ? "" : "collapsed")" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#@collapseId" 
                            aria-expanded="@(isFirstSection ? "true" : "false")" aria-controls="@collapseId">
                        <div class="d-flex justify-content-between align-items-center w-100 me-3">
                            <div class="d-flex align-items-center">
                                <i class="ri-layout-grid-line me-2 text-primary"></i>
                                <strong>@templateSection.SectionName</strong>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-@statusClass me-2">
                                    @templateSection.ConfiguredFieldCount/@templateSection.TotalFieldCount
                                </span>
                                @if (templateSection.TotalFieldCount > 0)
                                {
                                    <div class="progress me-2" style="width: 60px; height: 6px;">
                                        <div class="progress-bar bg-@statusClass" role="progressbar" 
                                             style="width: @((decimal)templateSection.ConfiguredFieldCount / templateSection.TotalFieldCount * 100)%"></div>
                                    </div>
                                }
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="@collapseId" class="accordion-collapse collapse @(isFirstSection ? "show" : "")" 
                     aria-labelledby="@headerId" data-bs-parent="#fieldSectionsAccordion">
                    <div class="accordion-body">
                        @if (templateSection.Fields.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Field Name</th>
                                            <th>Type</th>
                                            <th>Required</th>
                                            <th>Status</th>
                                            <th>Metric</th>
                                            <th>Mapping Type</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var field in templateSection.Fields)
                                        {
                                            var fieldTypeClass = GetFieldTypeClass(field.DataType);
                                            <tr data-field-id="@field.ItemId" class="@(field.Mapping != null ? "table-success-subtle" : "")">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <i class="ri-input-field me-2 text-muted"></i>
                                                        <div>
                                                            <strong>@field.ItemName</strong>
                                                            @if (!string.IsNullOrEmpty(field.ItemCode))
                                                            {
                                                                <br><small class="text-muted">@field.ItemCode</small>
                                                            }
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge @fieldTypeClass">@field.DataType</span>
                                                </td>
                                                <td>
                                                    @if (field.IsRequired)
                                                    {
                                                        <i class="ri-checkbox-circle-fill text-danger" title="Required"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="ri-checkbox-blank-circle-line text-muted" title="Optional"></i>
                                                    }
                                                </td>
                                                <td>
                                                    @if (field.Mapping != null)
                                                    {
                                                        <span class="badge mapping-status-configured">
                                                            <i class="ri-check-line me-1"></i>Mapped
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge mapping-status-unmapped">
                                                            <i class="ri-time-line me-1"></i>Unmapped
                                                        </span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (field.Mapping?.Metric != null)
                                                    {
                                                        <div>
                                                            <strong>@field.Mapping.Metric.MetricName</strong>
                                                            <br><small class="text-muted">@field.Mapping.Metric.MetricCode</small>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (field.Mapping != null)
                                                    {
                                                        <span class="badge bg-info-subtle text-info">@field.Mapping.MappingType</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        @if (field.Mapping != null)
                                                        {
                                                            <a href="@Url.Action("MapField", "MetricMapping", new { templateId = Model.TemplateId, fieldId = field.ItemId })" 
                                                               class="btn btn-outline-primary"
                                                               title="Edit Mapping">
                                                                <i class="ri-edit-line"></i>
                                                            </a>
                                                            <button type="button" class="btn btn-outline-danger btn-delete-field-mapping" 
                                                                    data-field-id="@field.ItemId" 
                                                                    data-mapping-id="@field.Mapping.MappingId"
                                                                    title="Delete Mapping">
                                                                <i class="ri-delete-bin-line"></i>
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <a href="@Url.Action("MapField", "MetricMapping", new { templateId = Model.TemplateId, fieldId = field.ItemId })" 
                                                               class="btn btn-primary"
                                                               title="Add Mapping">
                                                                <i class="ri-add-line me-1"></i>Map
                                                            </a>
                                                        }
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="ri-inbox-line text-muted" style="font-size: 2rem;"></i>
                                <h6 class="text-muted mt-2">No Fields</h6>
                                <p class="text-muted mb-0 small">This section has no fields to configure.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
            sectionIndex++;
        }
    </div>

    @functions {
        string GetFieldTypeClass(string dataType)
        {
            var lowerType = dataType?.ToLower() ?? "";
            if (lowerType.Contains("radio") || lowerType.Contains("select") || lowerType.Contains("rating") || lowerType.Contains("scale"))
                return "field-type-direct";
            if (lowerType.Contains("checkbox") || lowerType.Contains("boolean"))
                return "field-type-binary";
            return "field-type-calculated";
        }
    }

    @if (!Model.Sections.Any())
    {
        <!-- No Sections -->
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="ri-layout-grid-line text-muted" style="font-size: 3rem;"></i>
                <h6 class="text-muted mt-3">No Sections Available</h6>
                <p class="text-muted mb-3">
                    This template has no sections configured. Please add sections to the template first.
                </p>
                <a href="@Url.Action("Edit", "FormTemplates", new { id = Model.TemplateId })" class="btn btn-outline-primary">
                    <i class="ri-edit-line me-1"></i>Edit Template
                </a>
            </div>
        </div>
    }
</div>

<!-- Modal removed - Field mapping now uses full page wizard at /Metrics/Mapping/Configure/{templateId}/Field/{fieldId} -->
