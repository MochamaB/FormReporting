@*
    Assignment Access Period Step (Step 2)
    
    Fields:
    - EffectiveFrom (required) - When access starts
    - EffectiveUntil (optional) - When access ends (null = indefinite)
*@

<div class="assignment-period-step">
    <!-- Access Period Cards -->
    <div class="row g-4">
        <!-- Effective From -->
        <div class="col-md-6">
            <div class="card border shadow-none mb-0 h-100">
                <div class="card-header bg-success-subtle">
                    <label class="form-label mb-0 text-success">
                        <i class="ri-play-circle-line me-2"></i>Starts From
                        <span class="text-danger">*</span>
                    </label>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">When should users be able to access this form?</p>
                    
                    <div class="row g-2">
                        <div class="col-7">
                            <label class="form-label small text-muted">Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   name="effectiveFromDate" 
                                   id="effectiveFromDate" 
                                   required>
                        </div>
                        <div class="col-5">
                            <label class="form-label small text-muted">Time (Optional)</label>
                            <input type="time" 
                                   class="form-control" 
                                   name="effectiveFromTime" 
                                   id="effectiveFromTime"
                                   value="00:00">
                        </div>
                    </div>
                    
                    <!-- Hidden combined datetime field -->
                    <input type="hidden" name="effectiveFrom" id="effectiveFrom" />
                    
                    <div class="form-text mt-2">
                        <i class="ri-information-line me-1"></i>
                        Assignment will be active from this date/time.
                    </div>
                </div>
            </div>
        </div>

        <!-- Effective Until -->
        <div class="col-md-6">
            <div class="card border shadow-none mb-0 h-100">
                <div class="card-header bg-warning-subtle">
                    <label class="form-label mb-0 text-warning">
                        <i class="ri-stop-circle-line me-2"></i>Expires On
                    </label>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">When should access to this form end?</p>
                    
                    <!-- Expiration Toggle -->
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="hasExpiration">
                        <label class="form-check-label" for="hasExpiration">Set expiration date</label>
                    </div>
                    
                    <!-- Expiration Date Fields (hidden by default) -->
                    <div id="expirationFields" class="d-none">
                        <div class="row g-2">
                            <div class="col-7">
                                <label class="form-label small text-muted">Date</label>
                                <input type="date" 
                                       class="form-control" 
                                       name="effectiveUntilDate" 
                                       id="effectiveUntilDate">
                            </div>
                            <div class="col-5">
                                <label class="form-label small text-muted">Time (Optional)</label>
                                <input type="time" 
                                       class="form-control" 
                                       name="effectiveUntilTime" 
                                       id="effectiveUntilTime"
                                       value="23:59">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden combined datetime field -->
                    <input type="hidden" name="effectiveUntil" id="effectiveUntil" />
                    
                    <!-- No expiration message -->
                    <div id="noExpirationMessage">
                        <div class="alert alert-soft-secondary mb-0 py-2">
                            <i class="ri-infinity-line me-2"></i>
                            <span class="small">No expiration - access will be indefinite</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Access Period Preview -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-primary border shadow-none mb-0">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="avatar-sm me-3">
                            <div class="avatar-title bg-primary text-white rounded-circle">
                                <i class="ri-time-line"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-1">Access Period Summary</h6>
                            <p class="text-muted mb-0" id="period-preview-text">
                                Select dates to see the access period summary
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Presets -->
    <div class="row mt-3">
        <div class="col-12">
            <label class="form-label small text-muted mb-2">Quick Presets</label>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-soft-secondary btn-sm preset-btn" data-preset="today">
                    <i class="ri-calendar-line me-1"></i>Start Today
                </button>
                <button type="button" class="btn btn-soft-secondary btn-sm preset-btn" data-preset="tomorrow">
                    <i class="ri-calendar-2-line me-1"></i>Start Tomorrow
                </button>
                <button type="button" class="btn btn-soft-secondary btn-sm preset-btn" data-preset="nextWeek">
                    <i class="ri-calendar-event-line me-1"></i>Start Next Week
                </button>
                <button type="button" class="btn btn-soft-secondary btn-sm preset-btn" data-preset="nextMonth">
                    <i class="ri-calendar-check-line me-1"></i>Start Next Month
                </button>
                <span class="border-start mx-2"></span>
                <button type="button" class="btn btn-soft-warning btn-sm preset-btn" data-preset="endOfMonth">
                    <i class="ri-calendar-close-line me-1"></i>End of Month
                </button>
                <button type="button" class="btn btn-soft-warning btn-sm preset-btn" data-preset="endOfQuarter">
                    <i class="ri-calendar-todo-line me-1"></i>End of Quarter
                </button>
                <button type="button" class="btn btn-soft-warning btn-sm preset-btn" data-preset="endOfYear">
                    <i class="ri-calendar-2-line me-1"></i>End of Year
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Elements
    const effectiveFromDate = document.getElementById('effectiveFromDate');
    const effectiveFromTime = document.getElementById('effectiveFromTime');
    const effectiveFrom = document.getElementById('effectiveFrom');
    const effectiveUntilDate = document.getElementById('effectiveUntilDate');
    const effectiveUntilTime = document.getElementById('effectiveUntilTime');
    const effectiveUntil = document.getElementById('effectiveUntil');
    const hasExpirationCheckbox = document.getElementById('hasExpiration');
    const expirationFields = document.getElementById('expirationFields');
    const noExpirationMessage = document.getElementById('noExpirationMessage');
    const previewText = document.getElementById('period-preview-text');
    const presetButtons = document.querySelectorAll('.preset-btn');
    
    // Initialize with today's date
    const today = new Date();
    effectiveFromDate.value = formatDate(today);
    updateCombinedDateTime();
    
    // Toggle expiration fields
    hasExpirationCheckbox.addEventListener('change', () => {
        if (hasExpirationCheckbox.checked) {
            expirationFields.classList.remove('d-none');
            noExpirationMessage.classList.add('d-none');
            // Set default to end of current month
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            effectiveUntilDate.value = formatDate(endOfMonth);
        } else {
            expirationFields.classList.add('d-none');
            noExpirationMessage.classList.remove('d-none');
            effectiveUntilDate.value = '';
            effectiveUntil.value = '';
        }
        updateCombinedDateTime();
        updatePreview();
    });
    
    // Update combined datetime on change
    effectiveFromDate.addEventListener('change', () => { updateCombinedDateTime(); updatePreview(); });
    effectiveFromTime.addEventListener('change', () => { updateCombinedDateTime(); updatePreview(); });
    effectiveUntilDate.addEventListener('change', () => { updateCombinedDateTime(); updatePreview(); });
    effectiveUntilTime.addEventListener('change', () => { updateCombinedDateTime(); updatePreview(); });
    
    // Preset buttons
    presetButtons.forEach(btn => {
        btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
    });
    
    function updateCombinedDateTime() {
        // Combine date and time for effectiveFrom
        if (effectiveFromDate.value) {
            const time = effectiveFromTime.value || '00:00';
            effectiveFrom.value = `${effectiveFromDate.value}T${time}:00`;
        } else {
            effectiveFrom.value = '';
        }
        
        // Combine date and time for effectiveUntil
        if (hasExpirationCheckbox.checked && effectiveUntilDate.value) {
            const time = effectiveUntilTime.value || '23:59';
            effectiveUntil.value = `${effectiveUntilDate.value}T${time}:00`;
        } else {
            effectiveUntil.value = '';
        }
    }
    
    function updatePreview() {
        const fromDate = effectiveFromDate.value ? new Date(effectiveFromDate.value + 'T' + (effectiveFromTime.value || '00:00')) : null;
        const untilDate = hasExpirationCheckbox.checked && effectiveUntilDate.value 
            ? new Date(effectiveUntilDate.value + 'T' + (effectiveUntilTime.value || '23:59')) 
            : null;
        
        if (!fromDate) {
            previewText.textContent = 'Select a start date';
            return;
        }
        
        const fromStr = formatDisplayDate(fromDate);
        
        if (untilDate) {
            const untilStr = formatDisplayDate(untilDate);
            const duration = Math.ceil((untilDate - fromDate) / (1000 * 60 * 60 * 24));
            previewText.innerHTML = `<strong>From:</strong> ${fromStr} <span class="mx-2">→</span> <strong>Until:</strong> ${untilStr} <span class="badge bg-secondary ms-2">${duration} days</span>`;
        } else {
            previewText.innerHTML = `<strong>From:</strong> ${fromStr} <span class="mx-2">→</span> <strong>Until:</strong> <span class="text-muted">No expiration (indefinite)</span>`;
        }
    }
    
    function applyPreset(preset) {
        const now = new Date();
        let startDate = null;
        let endDate = null;
        let setExpiration = false;
        
        switch (preset) {
            case 'today':
                startDate = now;
                break;
            case 'tomorrow':
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() + 1);
                break;
            case 'nextWeek':
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() + (7 - startDate.getDay() + 1)); // Next Monday
                break;
            case 'nextMonth':
                startDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                break;
            case 'endOfMonth':
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                setExpiration = true;
                break;
            case 'endOfQuarter':
                const quarter = Math.floor(now.getMonth() / 3);
                endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
                setExpiration = true;
                break;
            case 'endOfYear':
                endDate = new Date(now.getFullYear(), 11, 31);
                setExpiration = true;
                break;
        }
        
        if (startDate) {
            effectiveFromDate.value = formatDate(startDate);
        }
        
        if (setExpiration && endDate) {
            hasExpirationCheckbox.checked = true;
            expirationFields.classList.remove('d-none');
            noExpirationMessage.classList.add('d-none');
            effectiveUntilDate.value = formatDate(endDate);
        }
        
        updateCombinedDateTime();
        updatePreview();
    }
    
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }
    
    function formatDisplayDate(date) {
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleDateString('en-US', options);
    }
    
    // Initialize preview
    updatePreview();
    
    console.log('[AssignmentWizard] Access Period step initialized');
})();
</script>
