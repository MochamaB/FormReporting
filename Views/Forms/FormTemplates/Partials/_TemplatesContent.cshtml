@using FormReporting.Models.ViewModels.Components
@using FormReporting.Models.ViewModels.Forms
@model List<FormTemplateViewModel>

@{
    // Get values from ViewData passed by parent
    int startingNumber = ViewData["StartingNumber"] as int? ?? 1;
    
    // Helper function to build row actions based on template status
    RowActionsViewModel BuildRowActions(FormTemplateViewModel template)
    {
        var actions = new List<RowActionConfig>();

        // Primary Actions based on status
        if (template.PublishStatus == "Draft")
        {
            actions.Add(new RowActionConfig { Text = "Continue Editing", IconClass = "ri-play-line", ColorClass = "primary", 
                UrlTemplate = Url.Action("Create", "FormTemplates", new { id = template.TemplateId }) });
            actions.Add(new RowActionConfig { Text = "View Preview", IconClass = "ri-eye-line", ColorClass = "secondary", 
                UrlTemplate = Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) });
        }
        else if (template.PublishStatus == "Published")
        {
            actions.Add(new RowActionConfig { Text = "View Details", IconClass = "ri-eye-line", ColorClass = "primary", 
                UrlTemplate = Url.Action("Details", "FormTemplates", new { id = template.TemplateId }) });
            actions.Add(new RowActionConfig { Text = $"Edit (Create v{template.Version + 1})", IconClass = "ri-git-branch-line", ColorClass = "warning", 
                UrlTemplate = Url.Action("Edit", "FormTemplates", new { id = template.TemplateId }) });
            actions.Add(new RowActionConfig { Text = "View Submissions", IconClass = "ri-file-list-3-line", ColorClass = "success", 
                UrlTemplate = Url.Action("Index", "Submissions", new { templateId = template.TemplateId }) });
        }
        else if (template.PublishStatus == "Archived" || template.PublishStatus == "Deprecated")
        {
            actions.Add(new RowActionConfig { Text = "View Template", IconClass = "ri-eye-line", ColorClass = "secondary", 
                UrlTemplate = Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) });
            actions.Add(new RowActionConfig { Text = "Create New Version", IconClass = "ri-git-branch-line", ColorClass = "primary", 
                UrlTemplate = Url.Action("Edit", "FormTemplates", new { id = template.TemplateId }) });
        }

        // Configuration Links (with divider)
        actions.Add(new RowActionConfig { Text = "---DIVIDER---", IsDivider = true });
        actions.Add(new RowActionConfig { Text = "Form Builder", IconClass = "ri-layout-3-line", ColorClass = "secondary", 
            UrlTemplate = template.PublishStatus == "Draft" 
                ? Url.Action("Create", "FormTemplates", new { id = template.TemplateId }) 
                : Url.Action("Preview", "FormTemplates", new { id = template.TemplateId }) });
        actions.Add(new RowActionConfig { Text = "Assignments", IconClass = "ri-user-add-line", ColorClass = "secondary", 
            UrlTemplate = Url.Action("Assignments", "FormTemplates", new { id = template.TemplateId }) });
        actions.Add(new RowActionConfig { Text = "Workflow", IconClass = "ri-flow-chart", ColorClass = "secondary", 
            UrlTemplate = Url.Action("Workflow", "FormTemplates", new { id = template.TemplateId }) });
        actions.Add(new RowActionConfig { Text = "Metrics", IconClass = "ri-bar-chart-2-line", ColorClass = "secondary", 
            UrlTemplate = Url.Action("Metrics", "FormTemplates", new { id = template.TemplateId }) });

        // Other Actions (with divider)
        actions.Add(new RowActionConfig { Text = "---DIVIDER---", IsDivider = true });
        actions.Add(new RowActionConfig { Text = "Clone", IconClass = "ri-file-copy-line", ColorClass = "info", 
            UrlTemplate = Url.Action("Clone", "FormTemplates", new { id = template.TemplateId }) });
        
        if (template.PublishStatus == "Draft")
        {
            actions.Add(new RowActionConfig { Text = "Delete Draft", IconClass = "ri-delete-bin-line", ColorClass = "danger", 
                RequiresConfirmation = true, ConfirmationMessage = $"Are you sure you want to delete draft '{template.TemplateName}'?" });
        }
        else if (template.PublishStatus == "Published")
        {
            actions.Add(new RowActionConfig { Text = "Archive", IconClass = "ri-archive-line", ColorClass = "danger", 
                RequiresConfirmation = true, ConfirmationMessage = $"Are you sure you want to archive '{template.TemplateName}'?" });
        }
        else if (template.PublishStatus == "Archived")
        {
            actions.Add(new RowActionConfig { Text = "Restore", IconClass = "ri-restart-line", ColorClass = "success", 
                RequiresConfirmation = true, ConfirmationMessage = $"Restore '{template.TemplateName}' to published status?" });
        }

        return new RowActionsViewModel
        {
            DisplayStyle = RowActionDisplayStyle.Dropdown,
            DropdownText = "",
            DropdownIconClass = "ri-more-fill",
            ButtonSizeClass = "btn-sm",
            UseSoftButtons = true,
            RowId = template.TemplateId.ToString(),
            Actions = actions.Where(a => !a.IsDivider).Select(a => new RowActionViewModel
            {
                Text = a.Text, IconClass = a.IconClass, ColorClass = a.ColorClass, Url = a.UrlTemplate,
                RequiresConfirmation = a.RequiresConfirmation, ConfirmationMessage = a.ConfirmationMessage, IsVisible = true
            }).ToList()
        };
    }
}

<!-- Toolbar Row -->
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3 pb-3 border-bottom">
    <!-- Left: Search + Filters -->
    <div class="d-flex gap-2 flex-wrap align-items-center">
        <!-- Search Box -->
        <div class="search-box">
            <form method="get" asp-action="Index" asp-controller="FormTemplates" class="d-flex">
                <input type="text" class="form-control" name="search" 
                       placeholder="Search templates..." 
                       value="@ViewBag.CurrentSearch" style="min-width: 200px;">
                <i class="ri-search-line search-icon"></i>
                <input type="hidden" name="status" value="@ViewBag.CurrentStatus" />
                <input type="hidden" name="type" value="@ViewBag.CurrentType" />
                <input type="hidden" name="category" value="@ViewBag.CurrentCategory" />
            </form>
        </div>
        
        <!-- Status Filter -->
        <div class="dropdown">
            <button class="btn btn-soft-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="ri-filter-3-line me-1"></i>
                @(string.IsNullOrEmpty(ViewBag.CurrentStatus?.ToString()) ? "Status" : ((string)ViewBag.CurrentStatus).ToUpperInvariant()[0] + ((string)ViewBag.CurrentStatus).Substring(1))
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item @(string.IsNullOrEmpty(ViewBag.CurrentStatus?.ToString()) ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, type = ViewBag.CurrentType, category = ViewBag.CurrentCategory })">All Status</a></li>
                <li><a class="dropdown-item @(ViewBag.CurrentStatus == "draft" ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = "draft", type = ViewBag.CurrentType, category = ViewBag.CurrentCategory })">Draft</a></li>
                <li><a class="dropdown-item @(ViewBag.CurrentStatus == "published" ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = "published", type = ViewBag.CurrentType, category = ViewBag.CurrentCategory })">Published</a></li>
                <li><a class="dropdown-item @(ViewBag.CurrentStatus == "archived" ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = "archived", type = ViewBag.CurrentType, category = ViewBag.CurrentCategory })">Archived</a></li>
            </ul>
        </div>
        
        <!-- Type Filter -->
        <div class="dropdown">
            <button class="btn btn-soft-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="ri-calendar-line me-1"></i>
                @(string.IsNullOrEmpty(ViewBag.CurrentType?.ToString()) ? "Type" : ((string)ViewBag.CurrentType).ToUpperInvariant()[0] + ((string)ViewBag.CurrentType).Substring(1))
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item @(string.IsNullOrEmpty(ViewBag.CurrentType?.ToString()) ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, category = ViewBag.CurrentCategory })">All Types</a></li>
                <li><a class="dropdown-item @(ViewBag.CurrentType == "monthly" ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, type = "monthly", category = ViewBag.CurrentCategory })">Monthly</a></li>
                <li><a class="dropdown-item @(ViewBag.CurrentType == "quarterly" ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, type = "quarterly", category = ViewBag.CurrentCategory })">Quarterly</a></li>
                <li><a class="dropdown-item @(ViewBag.CurrentType == "annual" ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, type = "annual", category = ViewBag.CurrentCategory })">Annual</a></li>
                <li><a class="dropdown-item @(ViewBag.CurrentType == "ondemand" ? "active" : "")" 
                       href="@Url.Action("Index", "FormTemplates", new { search = ViewBag.CurrentSearch, status = ViewBag.CurrentStatus, type = "ondemand", category = ViewBag.CurrentCategory })">On Demand</a></li>
            </ul>
        </div>
    </div>
    
    <!-- Right: View Toggle + Create Button -->
    <div class="d-flex gap-2 align-items-center">
        <!-- View Toggle -->
        <div class="btn-group" role="group" aria-label="View toggle">
            <button type="button" class="btn btn-soft-secondary btn-sm view-toggle-btn active" data-view="table" title="Table View">
                <i class="ri-list-check"></i>
            </button>
            <button type="button" class="btn btn-soft-secondary btn-sm view-toggle-btn" data-view="card" title="Card View">
                <i class="ri-grid-fill"></i>
            </button>
        </div>
        
        <!-- Create Button -->
        <a href="@Url.Action("Create", "FormTemplates")" class="btn btn-primary">
            <i class="ri-add-line me-1"></i>Create Template
        </a>
    </div>
</div>

<!-- TABLE VIEW -->
<div id="tableView">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th style="width: 40px;">#</th>
                    <th>Template</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th class="text-center">Configuration</th>
                    <th>Modified</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model == null || Model.Count == 0)
                {
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <i class="ri-file-list-line" style="font-size: 3rem;"></i>
                                <p class="mt-2 mb-0">No templates found</p>
                                @if (!string.IsNullOrEmpty(ViewBag.CurrentSearch?.ToString()) || 
                                     !string.IsNullOrEmpty(ViewBag.CurrentStatus?.ToString()) || 
                                     !string.IsNullOrEmpty(ViewBag.CurrentType?.ToString()) || 
                                     !string.IsNullOrEmpty(ViewBag.CurrentCategory?.ToString()))
                                {
                                    <small>Try adjusting your filters</small>
                                }
                            </div>
                        </td>
                    </tr>
                }
                else
                {
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var item = Model[i];
                        var rowNumber = startingNumber + i;
                        <tr>
                            <td class="text-muted">@rowNumber</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-2">
                                        <div class="avatar-xs">
                                            <div class="avatar-title bg-primary-subtle text-primary rounded">
                                                <i class="ri-file-list-3-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">@item.TemplateName</h6>
                                        <small class="text-muted">@item.TemplateCode</small>
                                    </div>
                                </div>
                            </td>
                            <td>@Html.Raw(item.TypeBadge)</td>
                            <td>@Html.Raw(item.StatusBadge)</td>
                            <td>
                                <div class="config-cell">
                                    <!-- Progress Bar -->
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <div class="progress flex-grow-1" style="height: 5px; min-width: 60px;">
                                            <div class="progress-bar @item.ConfigurationProgressColor" 
                                                 style="width: @(item.ConfigurationPercentage)%"></div>
                                        </div>
                                        <span class="badge @(item.ConfigurationPercentage == 100 ? "bg-success" : "bg-secondary-subtle text-secondary") badge-sm">
                                            @item.ConfigurationLevel/4
                                        </span>
                                    </div>
                                    <!-- Config Icons (Clickable) -->
                                    <div class="d-flex gap-1">
                                        <a href="@(item.PublishStatus == "Draft" ? Url.Action("Create", "FormTemplates", new { id = item.TemplateId }) : Url.Action("Preview", "FormTemplates", new { id = item.TemplateId }))" 
                                           class="config-icon-link @(item.HasFormBuilder ? "configured" : "not-configured")" 
                                           title="Form Builder: @(item.HasFormBuilder ? $"{item.SectionCount} sections, {item.FieldCount} fields" : "Not configured")">
                                            <i class="ri-layout-3-line"></i>
                                        </a>
                                        <a href="@Url.Action("Assignments", "FormTemplates", new { id = item.TemplateId })" 
                                           class="config-icon-link @(item.HasAssignments ? "configured" : "not-configured")" 
                                           title="Assignments: @(item.HasAssignments ? "Configured" : "Not configured")">
                                            <i class="ri-user-add-line"></i>
                                        </a>
                                        <a href="@Url.Action("Workflow", "FormTemplates", new { id = item.TemplateId })" 
                                           class="config-icon-link @(item.HasWorkflow ? "configured" : "not-configured")" 
                                           title="Workflow: @(item.HasWorkflow ? "Configured" : "Not configured")">
                                            <i class="ri-flow-chart"></i>
                                        </a>
                                        <a href="@Url.Action("Metrics", "FormTemplates", new { id = item.TemplateId })" 
                                           class="config-icon-link @(item.HasMetrics ? "configured" : "not-configured")" 
                                           title="Metrics: @(item.HasMetrics ? "Configured" : "Not configured")">
                                            <i class="ri-bar-chart-2-line"></i>
                                        </a>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="text-muted">@item.ModifiedDateFormatted</span>
                            </td>
                            <td>
                                @{
                                    var rowActions = BuildRowActions(item);
                                }
                                <partial name="~/Views/Shared/Components/RowActions/_RowActionsDropdown.cshtml" model="rowActions" />
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- CARD VIEW (Hidden by default) -->
<div id="cardView" style="display: none;">
    <partial name="~/Views/Forms/FormTemplates/Partials/_TemplateCardGrid.cshtml" model="Model" />
</div>

<!-- Pagination -->
@{
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int totalItems = ViewBag.TotalItems ?? 0;
}
@if (totalPages > 1)
{
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3 pt-3 border-top">
        <div>
            <span class="text-muted">
                Showing page @currentPage of @totalPages (@totalItems total)
            </span>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination mb-0">
                @{
                    string BuildPageUrl(int pageNumber)
                    {
                        return Url.Action("Index", "FormTemplates", new
                        {
                            page = pageNumber,
                            search = ViewBag.CurrentSearch,
                            status = ViewBag.CurrentStatus,
                            type = ViewBag.CurrentType,
                            category = ViewBag.CurrentCategory
                        }) ?? $"/FormTemplates?page={pageNumber}";
                    }
                }
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@(currentPage > 1 ? BuildPageUrl(currentPage - 1) : "#")">
                        <i class="ri-arrow-left-s-line"></i>
                    </a>
                </li>
                @for (int p = Math.Max(1, currentPage - 2); p <= Math.Min(totalPages, currentPage + 2); p++)
                {
                    <li class="page-item @(p == currentPage ? "active" : "")">
                        <a class="page-link" href="@BuildPageUrl(p)">@p</a>
                    </li>
                }
                <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                    <a class="page-link" href="@(currentPage < totalPages ? BuildPageUrl(currentPage + 1) : "#")">
                        <i class="ri-arrow-right-s-line"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
}
