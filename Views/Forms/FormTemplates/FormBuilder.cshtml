@model FormReporting.Models.ViewModels.Forms.FormBuilderViewModel
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Extensions
@{
    Layout = "~/Views/Shared/_BuilderLayout.cshtml";
    ViewData["Title"] = "Form Builder - " + Model.TemplateName;
    
    // Prevent browser caching of this page
    Context.Response.Headers["Cache-Control"] = "no-cache, no-store, must-revalidate";
    Context.Response.Headers["Pragma"] = "no-cache";
    Context.Response.Headers["Expires"] = "0";
    
    var progress = ViewData["Progress"] as FormBuilderProgressViewModel;
    
    // Fallback: Build progress if not provided (prevents disappearing progress bar)
    if (progress == null && Model != null)
    {
        progress = new FormBuilderProgressConfig
        {
            BuilderId = $"template-{Model.TemplateId}",
            TemplateId = Model.TemplateId,
            TemplateName = Model.TemplateName,
            TemplateVersion = $"v{Model.Version}",
            PublishStatus = Model.PublishStatus,
            CurrentStep = FormBuilderStep.FormBuilder,
            ShowSaveDraft = true,
            ExitUrl = Url.Action("Index", "FormTemplates") ?? "/Forms/FormTemplates"
        }
        .AtStep(FormBuilderStep.FormBuilder)
        .BuildProgress();
    }
}

<!-- Form Builder CSS -->
<link href="~/css/form-builder/form-builder.css?v=1.1" rel="stylesheet" />
<link href="~/css/form-builder/canvas-toolbar.css?v=1.0" rel="stylesheet" />

<!-- ============================================================================ -->
<!-- PROGRESS TRACKER - Same component used by all wizard steps -->
<!-- ============================================================================ -->
@if (progress != null)
{
    <partial name="~/Views/Shared/Components/FormBuilder/_FormBuilderProgress.cshtml" model="progress" />
}
else
{
    <!-- Debug: Progress is null even after fallback -->
    <div class="alert alert-danger m-2">Progress tracker failed to load. <a href="javascript:location.reload()">Reload</a></div>
}

<!-- ============================================================================ -->
<!-- TABBED NAVIGATION -->
<!-- ============================================================================ -->


<div class="builder-tabs-container">
    <div class="d-flex justify-content-between w-100">
        <div class="d-flex align-items-end" style="margin-bottom:-0.5rem">
        <!-- Left side: Tabs -->
        <ul class="nav nav-tabs-custom rounded card-header-tabs border-bottom-0 mb-0" role="tablist">
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#builder-summary" role="tab">
                    <i class="ri-list-check-2"></i>
                    Summary
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#builder-design" role="tab">
                    <i class="ri-paint-brush-line"></i>
                    Design
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#builder-preview" role="tab">
                    <i class="ri-eye-line"></i>
                    Preview
                </a>
            </li>
        </ul>
        </div>

        <!-- Right side: Action buttons -->
        <div class="d-flex align-items-center gap-2">
           
            
            <!-- Add Section button -->
            <button type="button"
                    class="btn btn-info "
                    onclick="addSection()">
                <i class="ri-add-line me-1"></i>
                Add Section
            </button>
            <!-- Back to Basic Info -->
            <a href="@Url.Action("TemplateSetup", "FormTemplates", new { id = Model.TemplateId })"
               class="btn btn-soft-secondary">
                <i class="ri-arrow-left-line me-1"></i>
                Back to Basic Info
            </a>

           

            <!-- Save Progress -->
            <button type="button" 
                    class="btn btn-soft-primary" 
                    id="saveProgressBtn"
                    onclick="saveFormBuilderProgress()">
                <i class="ri-save-line me-1"></i>
                Save Progress
            </button>
             @* Exit Builder Button *@
            @if (progress?.ShowExit == true)
            {
                <a href="@progress.ExitUrl" 
                   class="btn btn-danger" 
                   id="exitBtn">
                    <i class="ri-close-line me-1"></i>Exit Builder
                </a>
            }

            <!-- Continue to Review & Publish (Step 3) -->
            <button type="button" 
                    class="btn btn-success" 
                    id="continueToNextBtn"
                    onclick="continueToNextStage()">
                Continue to Review & Publish
                <i class="ri-arrow-right-line ms-1"></i>
            </button>

            <!-- Properties toggle -->
            <div class="properties-toggle-btn ms-2"
                 onclick="toggleProperties()"
                 title="Toggle Properties Panel"
                 style="cursor: pointer;">
                <i class="ri-arrow-left-s-line" id="propertiesToggleIcon"></i>
            </div>
        </div>

    </div>
</div>


<!-- ============================================================================ -->
<!-- TAB CONTENT AREA -->
<!-- ============================================================================ -->
<div class="builder-content-area">
    <div class="tab-content text-muted">
        <!-- TAB 1: Summary -->
        <div class="tab-pane" id="builder-summary" role="tabpanel">
            <partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Summary/_SummaryTab.cshtml" model="Model" />
        </div>
        
        <!-- TAB 2: Design -->
        <div class="tab-pane active" id="builder-design" role="tabpanel">
            <div class="design-grid" id="designGrid">
                <!-- LEFT: Toolbox -->
                <div class="design-toolbox">
                    <partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/_ToolboxPanel.cshtml" model="Model" />
                </div>
                
                <!-- CENTER: Canvas -->
                <div class="design-canvas" id="designCanvas">
                    <partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/_CanvasPanel.cshtml" model="Model" />
                </div>
                
                <!-- FLOATING: Canvas Toolbar -->
                <partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Components/_CanvasToolbar.cshtml" />
                
                <!-- RIGHT: Properties (Collapsible) -->
                <div class="design-properties" id="propertiesPanel">
                    <partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/_PropertiesPanel.cshtml" model="Model" />
                </div>
            </div>
        </div>
        
        <!-- TAB 3: Preview -->
        <div class="tab-pane" id="builder-preview" role="tabpanel">
            <div class="p-4 text-center">
                <i class="ri-eye-line display-4 text-success"></i>
                <h5 class="mt-3">Preview Tab</h5>
                <p class="text-muted">See how your form looks</p>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- MODALS -->
<!-- ============================================================================ -->
<partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Components/_Addsectionmodal.cshtml" />
<partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Components/_DeleteSectionModal.cshtml" />
<partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Components/_DuplicateSectionModal.cshtml" />
<partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Components/_AddFieldModal.cshtml" />
<partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Components/_DeleteFieldModal.cshtml" />
<partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Components/_DeleteOptionModal.cshtml" />
<partial name="~/Views/Forms/FormTemplates/Partials/FormBuilder/Components/_ErrorModal.cshtml" />

<!-- ============================================================================ -->
<!-- ALERT: Template Information -->
<!-- ============================================================================ -->


@section Scripts {
    <!-- SortableJS Library (already included in Velzon) -->
    <script src="~/assets/libs/sortablejs/Sortable.min.js"></script>

    <!-- Form Builder JavaScript Modules -->
    <script src="~/assets/js/pages/form-builder-progress.js"></script>
    <script src="~/assets/js/pages/form-builder-layout.js"></script>
    <script src="~/assets/js/pages/form-builder-sections.js"></script>
    <script src="~/assets/js/pages/form-builder-dragdrop.js"></script>
    <script src="~/assets/js/pages/form-builder-fields.js?v=2.3"></script>
    <script src="~/assets/js/pages/form-builder-properties.js?v=3.4"></script>
    <script src="~/assets/js/pages/form-builder-options.js?v=2.1"></script>
    <script src="~/assets/js/pages/form-builder-summary.js"></script>
    <script src="~/assets/js/pages/form-builder-toolbar.js?v=1.0"></script>
    <script src="~/assets/js/pages/form-builder.js?v=1.2"></script>

    <!-- Initialize with Template ID -->
    <script>
        // Set template ID for FormBuilder modules
        const TEMPLATE_ID = @Model.TemplateId;

        // Auto-select field after add/reload (from URL parameter)
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const fieldToSelect = urlParams.get('selectField');

            if (fieldToSelect) {
                console.log(`[AutoSelect] Attempting to auto-select field ${fieldToSelect} from URL parameter`);

                // Retry logic to ensure field card exists before selecting
                let attempts = 0;
                const maxAttempts = 10;
                const retryInterval = 200; // Check every 200ms

                const trySelectField = function() {
                    attempts++;
                    console.log(`[AutoSelect] Attempt ${attempts}/${maxAttempts}`);

                    // Check if field card exists in DOM
                    const fieldCard = document.getElementById(`field-${fieldToSelect}`);
                    if (fieldCard) {
                        console.log(`[AutoSelect] Field card found, attempting selection`);

                        // Check if selectField function exists
                        if (typeof selectField === 'function') {
                            try {
                                selectField(parseInt(fieldToSelect));

                                // Clean up URL (remove query parameter)
                                const cleanUrl = window.location.pathname;
                                window.history.replaceState({}, '', cleanUrl);
                                console.log(`[AutoSelect] ✅ Field ${fieldToSelect} auto-selected and URL cleaned`);
                            } catch (error) {
                                console.error('[AutoSelect] Error calling selectField:', error);
                            }
                        } else {
                            console.error('[AutoSelect] selectField function not found');
                        }
                    } else if (attempts < maxAttempts) {
                        // Field not found yet, retry
                        console.log(`[AutoSelect] Field card not found yet, retrying...`);
                        setTimeout(trySelectField, retryInterval);
                    } else {
                        console.error(`[AutoSelect] ❌ Failed to find field ${fieldToSelect} after ${maxAttempts} attempts`);
                        // Clean up URL even on failure
                        const cleanUrl = window.location.pathname;
                        window.history.replaceState({}, '', cleanUrl);
                    }
                };

                // Start trying after a small initial delay
                setTimeout(trySelectField, 300);
            }
        });
    </script>
}
