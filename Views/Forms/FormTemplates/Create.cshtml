@model FormReporting.Models.Entities.Forms.FormTemplate
@using FormReporting.Models.ViewModels.Components
@using FormReporting.Extensions
@{
    Layout = "~/Views/Shared/_BuilderLayout.cshtml";
    ViewData["Title"] = Model != null ? "Resume Creation of Form Template" : "Create Form Template";
    var progress = ViewData["Progress"] as FormBuilderProgressViewModel;

    // Build wizard configuration
    var wizardConfig = new WizardConfig
    {
        FormId = "templateConfigForm",
        FormAction = "#", // Handled by AJAX submit event
        FormMethod = "POST",
        Layout = WizardLayout.Vertical,
        Steps = new List<WizardStep>
        {
            new WizardStep
            {
                StepId = "basic-info",
                StepNumber = 1,
                Title = "Basic Information",
                Label = "Template Identity",
                Description = "Name, code, and category",
                Instructions = "Identify your form template with a unique name and code",
                Icon = "ri-information-line",
                State = WizardStepState.Active,
                ContentPartialPath = "~/Views/Forms/FormTemplates/Partials/_BasicInformation.cshtml",
                ShowPrevious = false,
                ShowNext = true
            },
            new WizardStep
            {
                StepId = "settings",
                StepNumber = 2,
                Title = "Settings",
                Label = "Configuration",
                Description = "Schedule and description",
                Instructions = "Define when this template should be used and its purpose",
                Icon = "ri-settings-3-line",
                State = WizardStepState.Pending,
                ContentPartialPath = "~/Views/Forms/FormTemplates/Partials/_Settings.cshtml",
                ShowPrevious = true,
                ShowNext = false,
                CustomButtonHtml = @"<button type=""button"" onclick=""saveDraft(true)"" class=""btn btn-soft-secondary me-2"">
                                        <i class=""ri-save-line label-icon align-middle fs-16 me-2""></i>
                                        Save Draft
                                      </button>
                                      <button type=""submit"" class=""btn btn-primary btn-label"">
                                        <i class=""ri-check-line label-icon align-middle fs-16 me-2""></i>
                                        Save & Continue
                                      </button>"
            }
        }
    };

    // Build wizard view model
    var wizard = wizardConfig.BuildWizard();
    ViewData["WizardViewModel"] = wizard;
}

@* ============================================================================ *@
@* PROGRESS TRACKER AT TOP (Full-width, sticky)                               *@
@* ============================================================================ *@
<partial name="~/Views/Shared/Components/FormBuilder/_FormBuilderProgress.cshtml" model="progress" />

@* ============================================================================ *@
@* MAIN CONTENT AREA - Wizard Form                                            *@
@* ============================================================================ *@
<div class="container-fluid" style="margin-top: 0.5rem; padding-bottom: 2rem;">
    <div class="row">
        <div class="col-12">
            <div class="card">
                
                <div class="card-body">
                    @* Wizard Form *@
                    <form method="@wizard.FormMethod" action="@wizard.FormAction" id="@wizard.FormId">
                        @Html.AntiForgeryToken()

                        @* Render Vertical Wizard *@
                        <partial name="~/Views/Shared/Components/Wizards/_VerticalWizard.cshtml" />
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script>
        $(document).ready(function() {
            // Initialize templateId from Model (for resume) or hidden field
            var templateId = @(Model?.TemplateId ?? 0);
            
            // Track form changes for unsaved changes warning
            var formChanged = false;
            var isSaving = false;

            $('#templateConfigForm').on('change', 'input, select, textarea', function() {
                formChanged = true;
            });

            // Function for progress tracker to check unsaved changes
            window.hasUnsavedChanges = function() {
                return formChanged;
            };

            // ========================================================================
            // VALIDATION HELPER FUNCTIONS
            // ========================================================================

            // Show validation error on input
            function showValidationError($input, message) {
                $input.addClass('is-invalid').removeClass('is-valid');

                // Update or create feedback message
                var $feedback = $input.siblings('.invalid-feedback');
                if ($feedback.length && message) {
                    $feedback.text(message).show();
                }

                $input.focus();
            }

            // Clear validation error from input
            function clearValidationError($input) {
                $input.removeClass('is-invalid');
            }

            // Clear all validation errors
            function clearAllValidationErrors() {
                $('.is-invalid').removeClass('is-invalid');
            }

            // ========================================================================
            // TEMPLATE CODE AUTO-GENERATION WITH UNIQUENESS CHECK
            // ========================================================================

            var isCodeManuallyEdited = false;
            var codeCheckTimeout = null;

            // Auto-generate template code from template name
            $(document).on('blur', '#TemplateName', function() {
                var name = $(this).val().trim();

                // Only auto-generate if code hasn't been manually edited
                if (name && !isCodeManuallyEdited) {
                    generateUniqueTemplateCode(name);
                }
            });

            // Generate unique template code via AJAX
            function generateUniqueTemplateCode(name) {
                $.ajax({
                    url: '@Url.Action("GenerateTemplateCode", "FormTemplates")',
                    type: 'GET',
                    data: { name: name },
                    success: function(response) {
                        if (response.success) {
                            $('#TemplateCode').val(response.code);
                            showCodeFeedback('success', response.message);
                        } else {
                            showCodeFeedback('error', response.message);
                        }
                    },
                    error: function() {
                        showCodeFeedback('error', 'Failed to generate template code');
                    }
                });
            }

            // Edit button - allow manual override
            $('#editCodeBtn').on('click', function() {
                var $codeInput = $('#TemplateCode');
                var $btn = $(this);

                if ($codeInput.prop('readonly')) {
                    // Enable editing
                    $codeInput.prop('readonly', false).focus();
                    $btn.html('<i class="ri-lock-line"></i>');
                    $btn.attr('title', 'Lock template code (auto-generate from name)');
                    $btn.removeClass('btn-outline-secondary').addClass('btn-outline-warning');
                    $('#codeHelpText').text('Manual mode: Enter custom code or click lock to re-enable auto-generation');
                    isCodeManuallyEdited = true;
                } else {
                    // Disable editing and regenerate
                    $codeInput.prop('readonly', true);
                    $btn.html('<i class="ri-edit-line"></i>');
                    $btn.attr('title', 'Edit template code manually');
                    $btn.removeClass('btn-outline-warning').addClass('btn-outline-secondary');
                    $('#codeHelpText').text('Will be auto-generated from template name');
                    isCodeManuallyEdited = false;

                    // Regenerate code if name exists
                    var name = $('#TemplateName').val().trim();
                    if (name) {
                        generateUniqueTemplateCode(name);
                    }
                }
            });

            // Real-time validation when manually editing
            $('#TemplateCode').on('input', function() {
                if (!$(this).prop('readonly')) {
                    clearTimeout(codeCheckTimeout);
                    var code = $(this).val().trim();

                    if (code) {
                        codeCheckTimeout = setTimeout(function() {
                            checkTemplateCodeUniqueness(code);
                        }, 500); // Debounce 500ms
                    }
                }
            });

            // Check template code uniqueness via AJAX
            function checkTemplateCodeUniqueness(code) {
                $.ajax({
                    url: '@Url.Action("CheckTemplateCode", "FormTemplates")',
                    type: 'GET',
                    data: { code: code },
                    success: function(response) {
                        if (!response.valid) {
                            showCodeFeedback('error', response.message);
                        } else if (response.exists) {
                            showCodeFeedback('error', response.message);
                        } else {
                            showCodeFeedback('success', response.message);
                        }
                    },
                    error: function() {
                        showCodeFeedback('error', 'Failed to check template code');
                    }
                });
            }

            // Show feedback message
            function showCodeFeedback(type, message) {
                var $input = $('#TemplateCode');
                var $feedback = $('#codeFeedback');

                $input.removeClass('is-valid is-invalid');

                if (type === 'success') {
                    $input.addClass('is-valid');
                    $feedback.removeClass('invalid-feedback').addClass('valid-feedback');
                } else {
                    $input.addClass('is-invalid');
                    $feedback.removeClass('valid-feedback').addClass('invalid-feedback');
                }

                $feedback.text(message).show();
            }

            // ========================================================================
            // WIZARD STEP VALIDATION CALLBACK
            // ========================================================================
            // Register validation callback for wizard navigation
            window.wizardValidationCallbacks = window.wizardValidationCallbacks || {};
            window.wizardValidationCallbacks['templateConfigForm'] = function(currentStepId) {
                // Clear previous validation errors
                clearAllValidationErrors();

                // Validate Step 1: Basic Information
                if (currentStepId === 'basic-info') {
                    var isValid = true;

                    // Template Name is required
                    if (!$('#TemplateName').val() || !$('#TemplateName').val().trim()) {
                        showValidationError($('#TemplateName'));
                        isValid = false;
                    }

                    // Template Code is required
                    if (!$('#TemplateCode').val() || !$('#TemplateCode').val().trim()) {
                        showValidationError($('#TemplateCode'), 'Please wait for template code to be generated');
                        isValid = false;
                    }

                    // Check if template code has errors
                    if ($('#TemplateCode').hasClass('is-invalid')) {
                        showValidationError($('#TemplateCode'), 'Please fix the template code error before continuing');
                        isValid = false;
                    }

                    // Category is required
                    if (!$('#CategoryId').val()) {
                        showValidationError($('#CategoryId'));
                        isValid = false;
                    }

                    return isValid;
                }

                // Validate Step 2: Settings
                if (currentStepId === 'settings') {
                    var isValid = true;

                    // Template Type is required
                    if (!$('#TemplateType').val()) {
                        showValidationError($('#TemplateType'));
                        isValid = false;
                    }

                    return isValid;
                }

                // Default: allow navigation
                return true;
            };

            // ========================================================================
            // FORM SUBMIT VALIDATION & NAVIGATION
            // ========================================================================
            $('#templateConfigForm').on('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                
                // Clear previous validation errors
                clearAllValidationErrors();

                var isValid = true;
                var firstInvalidField = null;

                // Validate Step 1
                if (!$('#TemplateName').val() || !$('#TemplateName').val().trim()) {
                    showValidationError($('#TemplateName'));
                    if (!firstInvalidField) firstInvalidField = $('#TemplateName');
                    isValid = false;
                }

                if (!$('#TemplateCode').val() || !$('#TemplateCode').val().trim()) {
                    showValidationError($('#TemplateCode'), 'Template code is required');
                    if (!firstInvalidField) firstInvalidField = $('#TemplateCode');
                    isValid = false;
                }

                if ($('#TemplateCode').hasClass('is-invalid')) {
                    showValidationError($('#TemplateCode'), 'Please fix the template code error');
                    if (!firstInvalidField) firstInvalidField = $('#TemplateCode');
                    isValid = false;
                }

                if (!$('#CategoryId').val()) {
                    showValidationError($('#CategoryId'));
                    if (!firstInvalidField) firstInvalidField = $('#CategoryId');
                    isValid = false;
                }

                // Validate Step 2
                if (!$('#TemplateType').val()) {
                    showValidationError($('#TemplateType'));
                    if (!firstInvalidField) firstInvalidField = $('#TemplateType');
                    isValid = false;
                }

                if (!isValid) {
                    // Focus first invalid field if exists
                    if (firstInvalidField) {
                        firstInvalidField.focus();
                    }
                    return false;
                }

                // Save draft and navigate to FormBuilder
                saveDraftAndNavigate();
            });
            
            // Save draft and navigate to next step
            function saveDraftAndNavigate() {
                if (isSaving) return;
                
                isSaving = true;
                showSavingIndicator();
                
                const formData = {
                    TemplateId: templateId,
                    TemplateName: $('#TemplateName').val(),
                    TemplateCode: $('#TemplateCode').val(),
                    Description: $('#Description').val(),
                    CategoryId: parseInt($('#CategoryId').val()) || 0,
                    TemplateType: $('#TemplateType').val()
                };
                
                // Debug: Log form data being sent
                console.log('Saving draft with data:', formData);
                
                $.ajax({
                    url: '@Url.Action("SaveDraft", "FormTemplates")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.success) {
                            formChanged = false;
                            
                            // Navigate to FormBuilder with the template ID
                            const navigateTemplateId = response.templateId || templateId;
                            window.location.href = '@Url.Action("FormBuilder", "FormTemplates")?id=' + navigateTemplateId;
                        } else {
                            showSaveErrorIndicator(response.message);
                            isSaving = false;
                        }
                    },
                    error: function(xhr, status, error) {
                        showSaveErrorIndicator('Failed to save template');
                        isSaving = false;
                        console.error('Save failed:', error);
                    }
                });
            }

            // ========================================================================
            // AUTO-CLEAR VALIDATION ON INPUT CHANGE
            // ========================================================================

            // Clear validation errors when user starts typing or selecting
            $('#templateConfigForm').on('input change', 'input, select, textarea', function() {
                var $field = $(this);
                if ($field.hasClass('is-invalid')) {
                    clearValidationError($field);
                }
            });

            // Warn on navigation if unsaved changes
            window.addEventListener('beforeunload', function (e) {
                if (formChanged) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });

            // ========================================================================
            // AUTOSAVE DRAFT - Save every 30 seconds
            // ========================================================================
            
            let autosaveTimer = null;
            // templateId already declared above - reuse it
            // isSaving already declared above - reuse it
            
            // Auto-save every 30 seconds if form has changes and required fields are valid
            function startAutosave() {
                autosaveTimer = setInterval(function() {
                    var categoryId = parseInt($('#CategoryId').val()) || 0;
                    // Only auto-save if category is selected (prevents saving invalid data)
                    if (formChanged && !isSaving && categoryId > 0) {
                        saveDraft(false); // false = autosave (silent)
                    }
                }, 30000); // 30 seconds
            }
            
            // Save draft (manual or auto)
            function saveDraft(isManual = false) {
                if (isSaving) return;
                
                var categoryId = parseInt($('#CategoryId').val()) || 0;
                
                // Don't auto-save without a valid category (prevents invalid data)
                if (!isManual && categoryId <= 0) {
                    console.log('Auto-save skipped: No category selected');
                    return;
                }
                
                isSaving = true;
                
                if (isManual) {
                    showSavingIndicator();
                }
                
                const formData = {
                    TemplateId: templateId,
                    TemplateName: $('#TemplateName').val(),
                    TemplateCode: $('#TemplateCode').val(),
                    Description: $('#Description').val(),
                    CategoryId: parseInt($('#CategoryId').val()) || 0,
                    TemplateType: $('#TemplateType').val()
                };
                
                $.ajax({
                    url: '@Url.Action("SaveDraft", "FormTemplates")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.success) {
                            // Store templateId for subsequent saves
                            if (response.templateId) {
                                templateId = response.templateId;
                            }
                            
                            formChanged = false;
                            
                            if (isManual) {
                                showSavedIndicator(response.message);
                            } else {
                                console.log('Draft auto-saved successfully');
                            }
                        } else {
                            if (isManual) {
                                showSaveErrorIndicator(response.message);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        if (isManual) {
                            showSaveErrorIndicator('Failed to save draft');
                        }
                        console.error('Draft save failed:', error);
                    },
                    complete: function() {
                        isSaving = false;
                    }
                });
            }
            
            function showSavingIndicator() {
                Swal.fire({
                    title: 'Saving...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            }
            
            function showSavedIndicator(message) {
                Swal.fire({
                    icon: 'success',
                    title: 'Saved!',
                    text: message,
                    timer: 2000,
                    showConfirmButton: false
                });
            }
            
            function showSaveErrorIndicator(message) {
                Swal.fire({
                    icon: 'error',
                    title: 'Save Failed',
                    text: message,
                    confirmButtonText: 'OK'
                });
            }
            
            // Start autosave timer
            startAutosave();
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', function (e) {
                if (autosaveTimer) {
                    clearInterval(autosaveTimer);
                }
                
                // Save before leaving if changes exist
                if (formChanged && !isSaving) {
                    saveDraft(false);
                }
                
                if (formChanged) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });
        });
    </script>
}
