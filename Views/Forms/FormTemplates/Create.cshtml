@using FormReporting.Models.ViewModels.Components
@{
    ViewData["Title"] = "Create Form Template";
    var progress = ViewData["Progress"] as FormBuilderProgressViewModel;
}

@* ============================================================================ *@
@* PROGRESS TRACKER AT TOP (Full-width, sticky)                               *@
@* ============================================================================ *@
<partial name="~/Views/Shared/Components/FormBuilder/_FormBuilderProgress.cshtml" model="progress" />

@* ============================================================================ *@
@* MAIN CONTENT AREA - Template Configuration Form                            *@
@* ============================================================================ *@
<div class="container-fluid" style="margin-top: 1.5rem; padding-bottom: 2rem;">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="ri-file-settings-line me-2"></i>Template Configuration
                            </h5>
                            <p class="text-muted mb-0 mt-1 small">
                                Configure the basic information and settings for your form template
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" action="@Url.Action("SaveTemplateConfiguration", "FormTemplates")" id="templateConfigForm">
                        @Html.AntiForgeryToken()

                        @* Tab 1: Basic Information *@
                        <div class="mb-4 pb-4 border-bottom">
                            <h6 class="text-primary mb-3">
                                <i class="ri-information-line me-1"></i>Basic Information
                            </h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="TemplateName" class="form-label">
                                            Template Name <span class="text-danger">*</span>
                                        </label>
                                        <input type="text"
                                               class="form-control"
                                               id="TemplateName"
                                               name="TemplateName"
                                               placeholder="e.g., Monthly ICT Report"
                                               required>
                                        <div class="form-text">Give your form template a descriptive name</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="TemplateCode" class="form-label">
                                            Template Code <span class="text-danger">*</span>
                                        </label>
                                        <input type="text"
                                               class="form-control"
                                               id="TemplateCode"
                                               name="TemplateCode"
                                               placeholder="Auto-generated"
                                               readonly>
                                        <div class="form-text">Will be auto-generated from template name</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="CategoryId" class="form-label">
                                            Category <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="CategoryId" name="CategoryId" required>
                                            <option value="">Select category...</option>
                                            <option value="1">ICT Operations</option>
                                            <option value="2">Network Management</option>
                                            <option value="3">Hardware Assets</option>
                                            <option value="4">Software Licenses</option>
                                            <option value="5">Support Tickets</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="Version" class="form-label">
                                            Version
                                        </label>
                                        <input type="text"
                                               class="form-control"
                                               id="Version"
                                               name="Version"
                                               value="1.0"
                                               readonly>
                                        <div class="form-text">Version will be managed automatically</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="Description" class="form-label">
                                            Description
                                        </label>
                                        <textarea class="form-control"
                                                  id="Description"
                                                  name="Description"
                                                  rows="3"
                                                  placeholder="Describe the purpose of this form template..."></textarea>
                                        <div class="form-text">Provide a brief description of what this form is used for</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Tab 2: Settings *@
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="ri-settings-3-line me-1"></i>Settings
                            </h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="TemplateType" class="form-label">
                                            Template Type <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="TemplateType" name="TemplateType" required>
                                            <option value="">Select type...</option>
                                            <option value="Monthly">Monthly</option>
                                            <option value="Quarterly">Quarterly</option>
                                            <option value="Annual">Annual</option>
                                            <option value="OnDemand">On Demand</option>
                                        </select>
                                        <div class="form-text">How often should this form be submitted?</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="EstimatedCompletionTime" class="form-label">
                                            Estimated Completion Time (minutes)
                                        </label>
                                        <input type="number"
                                               class="form-control"
                                               id="EstimatedCompletionTime"
                                               name="EstimatedCompletionTime"
                                               placeholder="e.g., 15"
                                               min="1">
                                        <div class="form-text">How long does it typically take to fill this form?</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   id="RequiresApproval"
                                                   name="RequiresApproval">
                                            <label class="form-check-label" for="RequiresApproval">
                                                Requires Approval
                                            </label>
                                        </div>
                                        <div class="form-text">Enable if submissions need to be approved</div>
                                    </div>
                                </div>

                                <div class="col-md-6" id="workflowSection" style="display: none;">
                                    <div class="mb-3">
                                        <label for="WorkflowId" class="form-label">
                                            Workflow
                                        </label>
                                        <select class="form-select" id="WorkflowId" name="WorkflowId">
                                            <option value="">Select workflow...</option>
                                            <option value="1">Standard Approval (2 Levels)</option>
                                            <option value="2">Manager Approval Only</option>
                                            <option value="3">Head Office Approval</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   id="AllowMultipleSubmissions"
                                                   name="AllowMultipleSubmissions"
                                                   checked>
                                            <label class="form-check-label" for="AllowMultipleSubmissions">
                                                Allow Multiple Submissions
                                            </label>
                                        </div>
                                        <div class="form-text">Allow users to submit this form multiple times</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   id="IsActive"
                                                   name="IsActive"
                                                   checked>
                                            <label class="form-check-label" for="IsActive">
                                                Active
                                            </label>
                                        </div>
                                        <div class="form-text">Template will be active and usable</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Form Actions *@
                        <div class="row mt-4 pt-3 border-top">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="@Url.Action("Index", "FormTemplates")" class="btn btn-light">
                                        <i class="ri-close-line me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="ri-arrow-right-line me-1"></i>Save & Continue to Section Builder
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Track form changes for unsaved changes warning
            var formChanged = false;

            $('#templateConfigForm').on('change', 'input, select, textarea', function() {
                formChanged = true;
            });

            // Function for progress tracker to check unsaved changes
            window.hasUnsavedChanges = function() {
                return formChanged;
            };

            // Auto-generate template code from template name
            $('#TemplateName').on('blur', function() {
                var name = $(this).val().trim();
                if (name && !$('#TemplateCode').val()) {
                    var code = 'TPL_' + name
                        .toUpperCase()
                        .replace(/[^A-Z0-9]/g, '_')
                        .substring(0, 20);
                    $('#TemplateCode').val(code);
                }
            });

            // Show/hide workflow dropdown based on RequiresApproval checkbox
            $('#RequiresApproval').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#workflowSection').slideDown();
                    $('#WorkflowId').prop('required', true);
                } else {
                    $('#workflowSection').slideUp();
                    $('#WorkflowId').prop('required', false);
                    $('#WorkflowId').val('');
                }
            });

            // Form validation
            $('#templateConfigForm').on('submit', function(e) {
                // Basic validation
                if (!$('#TemplateName').val().trim()) {
                    e.preventDefault();
                    alert('Please enter a template name');
                    $('#TemplateName').focus();
                    return false;
                }

                if (!$('#CategoryId').val()) {
                    e.preventDefault();
                    alert('Please select a category');
                    $('#CategoryId').focus();
                    return false;
                }

                if (!$('#TemplateType').val()) {
                    e.preventDefault();
                    alert('Please select a template type');
                    $('#TemplateType').focus();
                    return false;
                }

                // If requires approval, workflow must be selected
                if ($('#RequiresApproval').is(':checked') && !$('#WorkflowId').val()) {
                    e.preventDefault();
                    alert('Please select a workflow for approval');
                    $('#WorkflowId').focus();
                    return false;
                }

                // Mark form as saved
                formChanged = false;
                return true;
            });

            // Warn on navigation if unsaved changes
            window.addEventListener('beforeunload', function (e) {
                if (formChanged) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });
        });
    </script>
}
