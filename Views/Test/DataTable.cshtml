@using FormReporting.Extensions
@using FormReporting.Models.ViewModels.Components
@using Microsoft.AspNetCore.Html
@using static FormReporting.Controllers.ComponentTestController
@inject Microsoft.AspNetCore.Mvc.IUrlHelper Url

@{
    ViewData["Title"] = "DataTable Component Test";
    ViewData["Breadcrumbs"] = new List<(string Title, string? Url)>
    {
        ("Components", null),
        ("DataTable Test", null)
    };

    var users = ViewBag.Users as List<SampleUser> ?? new List<SampleUser>();
    var totalRecords = (int)ViewBag.TotalRecords;
    var currentPage = (int)ViewBag.CurrentPage;
    var totalPages = (int)ViewBag.TotalPages;
    var search = ViewBag.Search as string;
    var status = ViewBag.Status as string;
    var role = ViewBag.Role as string;
}

<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">DataTable Component - Full Test</h4>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <h5 class="alert-heading"><i class="ri-information-line"></i> DataTable Features Test</h5>
            <p class="mb-0">This table demonstrates: Search, Status Filter, Role Filter (Advanced), Sorting, Pagination, and Create Button</p>
        </div>
    </div>
</div>

@{
    // Build filter options with current selections
    var statusOptions = new List<FilterOption>
    {
        new FilterOption { Text = "All", Value = "", IsActive = string.IsNullOrEmpty(status), Url = Url.Action("DataTable", new { search, role }) ?? "" },
        new FilterOption { Text = "Active", Value = "Active", IsActive = status == "Active", Url = Url.Action("DataTable", new { search, status = "Active", role }) ?? "" },
        new FilterOption { Text = "Inactive", Value = "Inactive", IsActive = status == "Inactive", Url = Url.Action("DataTable", new { search, status = "Inactive", role }) ?? "" }
    };

    var roleOptions = new List<FilterOption>
    {
        new FilterOption { Text = "HeadOffice Admin", Value = "HeadOffice Admin", IsSelected = role == "HeadOffice Admin" },
        new FilterOption { Text = "Regional Manager", Value = "Regional Manager", IsSelected = role == "Regional Manager" },
        new FilterOption { Text = "Factory User", Value = "Factory User", IsSelected = role == "Factory User" }
    };

    // Configure row actions (View/Edit/Delete)
    var rowActionsConfig = RowActionsExtensions.CreateDefaultRowActions(
        viewUrlTemplate: "#",
        editUrlTemplate: "#",
        deleteUrlTemplate: "#"
    );

    // Configure DataTable
    var config = new DataTableConfig
    {
        TableId = "usersTable",
        Columns = new List<string> { "ID", "Name", "Email", "Role", "Tenant", "Status", "Actions" },

        // Search
        EnableSearch = true,
        SearchBox = new SearchBoxConfig
        {
            PlaceholderText = "Search users...",
            CurrentValue = search,
            ActionUrl = Url.Action("DataTable") ?? ""
        },

        // Simple status filter
        FilterDropdowns = new List<FilterDropdownConfig>
        {
            new FilterDropdownConfig
            {
                Label = "Status",
                Options = statusOptions
            }
        },

        // Advanced role filter
        FilterSelects = new List<FilterSelectConfig>
        {
            new FilterSelectConfig
            {
                ParameterName = "role",
                PlaceholderText = "Filter by Role",
                ActionUrl = Url.Action("DataTable") ?? "",
                Options = roleOptions
            }
        },

        // Create button
        CreateButtonText = "Create User",
        CreateButtonUrl = "#",

        // Pagination
        ShowPagination = true,
        CurrentPage = currentPage,
        TotalPages = totalPages,
        TotalRecords = totalRecords,
        PageSize = 10,

        // Sorting
        EnableSorting = true,

        // Table content renderer
        TableContentRenderer = _ =>
        {
            var sb = new System.Text.StringBuilder();
            foreach (var user in users)
            {
                var statusColor = user.Status == "Active" ? "success" : "danger";
                var actionsHtml = rowActionsConfig.RenderActionsHtml(user.Id);

                sb.Append("<tr>");
                sb.Append($"<td>{user.Id}</td>");
                sb.Append($"<td><strong>{user.Name}</strong></td>");
                sb.Append($"<td>{user.Email}</td>");
                sb.Append($"<td><span class='badge bg-info-subtle text-info'>{user.Role}</span></td>");
                sb.Append($"<td>{user.Tenant}</td>");
                sb.Append($"<td><span class='badge bg-{statusColor}-subtle text-{statusColor}'>{user.Status}</span></td>");
                sb.Append($"<td>{actionsHtml}</td>");
                sb.Append("</tr>");
            }
            return new HtmlString(sb.ToString());
        }
    };

    var tableViewModel = config.BuildDataTable();
}

<div class="row">
    <div class="col-12">
        <partial name="~/Views/Shared/Components/DataTable/_DataTable.cshtml" model="tableViewModel" />
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary-subtle">
                <h5 class="card-title mb-0"><i class="ri-code-line"></i> Usage Example</h5>
            </div>
            <div class="card-body">
                <p><strong>Controller Code:</strong></p>
                <pre class="bg-light p-3 rounded" style="font-size: 0.85rem;"><code>public IActionResult Users(string? search, string? status, int? page)
{
    var query = _context.Users.AsQueryable();

    // Apply filters
    if (!string.IsNullOrEmpty(search))
        query = query.Where(u => u.Name.Contains(search) || u.Email.Contains(search));

    if (!string.IsNullOrEmpty(status))
        query = query.Where(u => u.Status == status);

    // Pagination
    var totalRecords = await query.CountAsync();
    var (currentPage, totalPages, skip, take) = DataTableExtensions.CalculatePagination(page, totalRecords, 10);
    var users = await query.Skip(skip).Take(take).ToListAsync();

    ViewBag.Users = users;
    ViewBag.CurrentPage = currentPage;
    ViewBag.TotalPages = totalPages;
    ViewBag.TotalRecords = totalRecords;

    return View();
}</code></pre>

                <p class="mt-3"><strong>View Code:</strong></p>
                <pre class="bg-light p-3 rounded" style="font-size: 0.85rem;"><code>// Configure row actions (inline style - recommended for 2-4 actions)
var rowActionsConfig = RowActionsExtensions.CreateDefaultRowActions(
    viewUrlTemplate: "/users/@@{id}",
    editUrlTemplate: "/users/@@{id}/edit",
    deleteUrlTemplate: "/users/@@{id}/delete"
);

// Configure DataTable
var config = new DataTableConfig
@@{
    Columns = new List&lt;string&gt; @@{ "ID", "Name", "Email", "Role", "Status", "Actions" @@},
    TableContentRenderer = _ =&gt;
    @@{
        var sb = new StringBuilder();
        foreach (var user in users)
        @@{
            var actionsHtml = rowActionsConfig.RenderActionsHtml(user.Id);
            sb.Append("&lt;tr&gt;");
            sb.Append("&lt;td&gt;" + user.Id + "&lt;/td&gt;");
            sb.Append("&lt;td&gt;" + user.Name + "&lt;/td&gt;");
            sb.Append("&lt;td&gt;" + actionsHtml + "&lt;/td&gt;");
            sb.Append("&lt;/tr&gt;");
        @@}
        return new HtmlString(sb.ToString());
    @@}
@@}
.WithSearch("search", "Search users...")
.WithFilterDropdown("Status", statusOptions)
.WithFilterSelect("role", "Filter by Role", roleOptions)
.WithCreateButton("Create User", "/users/create")
.WithPagination(currentPage, totalPages, totalRecords);

var table = config.BuildDataTable();</code></pre>

                <hr class="my-4">

                <p><strong>Row Actions Component:</strong></p>
                <p>The RowActions component provides reusable action buttons (View/Edit/Delete/etc.) with two display styles:</p>

                <div class="row">
                    <div class="col-md-6">
                        <h6>Inline Style (2-4 actions):</h6>
                        <pre class="bg-light p-3 rounded" style="font-size: 0.85rem;"><code>var rowActions = RowActionsExtensions
    .CreateDefaultRowActions() // View, Edit, Delete
    .WithDuplicateAction(); // Add more actions

// Or build from scratch:
var rowActions = new RowActionsConfig()
    .WithViewAction("/users/@@{id}")
    .WithEditAction("/users/@@{id}/edit")
    .WithDeleteAction("/users/@@{id}/delete")
    .AsInline(); // Default style</code></pre>
                    </div>
                    <div class="col-md-6">
                        <h6>Dropdown Style (4+ actions):</h6>
                        <pre class="bg-light p-3 rounded" style="font-size: 0.85rem;"><code>var rowActions = new RowActionsConfig()
    .WithViewAction()
    .WithEditAction()
    .WithDeleteAction()
    .WithDuplicateAction()
    .WithDownloadAction()
    .WithArchiveAction()
    .AsDropdown("Actions"); // Dropdown style</code></pre>
                    </div>
                </div>

                <p class="mt-3"><strong>Available Helper Methods:</strong></p>
                <ul>
                    <li><code>.WithViewAction(urlTemplate)</code> - View icon (primary)</li>
                    <li><code>.WithEditAction(urlTemplate)</code> - Edit icon (success)</li>
                    <li><code>.WithDeleteAction(urlTemplate, confirmMessage)</code> - Delete icon with confirmation (danger)</li>
                    <li><code>.WithDuplicateAction(urlTemplate)</code> - Duplicate icon (info)</li>
                    <li><code>.WithDownloadAction(urlTemplate)</code> - Download icon (secondary)</li>
                    <li><code>.WithArchiveAction(urlTemplate, confirmMessage)</code> - Archive icon with confirmation (warning)</li>
                    <li><code>.WithAction(text, icon, url, color, requiresConfirm, message)</code> - Custom action</li>
                </ul>

                <div class="mt-3">
                    <h6>Navigation:</h6>
                    <div class="hstack gap-2">
                        <a href="/ComponentTest/DataTableBulk" class="btn btn-primary btn-sm"><i class="ri-checkbox-multiple-line"></i> View Bulk Actions Example</a>
                        <a href="/ComponentTest/StatCards" class="btn btn-secondary btn-sm"><i class="ri-dashboard-line"></i> View Stat Cards</a>
                        <a href="/" class="btn btn-secondary btn-sm"><i class="ri-home-line"></i> Back to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
