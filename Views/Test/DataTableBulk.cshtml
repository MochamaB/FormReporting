@using FormReporting.Extensions
@using FormReporting.Models.ViewModels.Components
@using Microsoft.AspNetCore.Html
@using static FormReporting.Controllers.ComponentTestController

@{
    ViewData["Title"] = "DataTable with Bulk Actions";
    ViewData["Breadcrumbs"] = new List<(string Title, string? Url)>
    {
        ("Components", null),
        ("DataTable Bulk Actions", null)
    };

    var users = ViewBag.Users as List<SampleUser> ?? new List<SampleUser>();
    var totalRecords = (int)ViewBag.TotalRecords;
    var currentPage = (int)ViewBag.CurrentPage;
    var totalPages = (int)ViewBag.TotalPages;
}

<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">DataTable Component - Bulk Actions</h4>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-warning">
            <h5 class="alert-heading"><i class="ri-checkbox-multiple-line"></i> Bulk Actions Test</h5>
            <p class="mb-0"><strong>Try this:</strong> Select multiple rows using checkboxes. A "Bulk Actions" dropdown will appear. This demonstrates bulk delete, bulk export, and bulk activate features.</p>
        </div>
    </div>
</div>

@{
    // Configure row actions with dropdown (demonstrating dropdown style)
    var rowActionsConfig = new RowActionsConfig()
        .WithViewAction("#")
        .WithEditAction("#")
        .WithDeleteAction("#")
        .WithDuplicateAction("#")
        .WithDownloadAction("#")
        .AsDropdown("Actions"); // Use dropdown style for bulk actions demo

    var config = new DataTableConfig
    {
        TableId = "usersBulkTable",
        Columns = new List<string> { "ID", "Name", "Email", "Role", "Tenant", "Status", "Actions" },

        // Enable bulk actions
        EnableBulkActions = true,
        BulkActions = new List<BulkActionConfig>
        {
            new BulkActionConfig
            {
                Text = "Delete Selected",
                ActionUrl = "/users/bulk-delete",
                IconClass = "ri-delete-bin-line",
                ColorClass = "danger",
                RequiresConfirmation = true,
                ConfirmationMessage = "Are you sure you want to delete the selected users?"
            },
            new BulkActionConfig
            {
                Text = "Export Selected",
                ActionUrl = "/users/bulk-export",
                IconClass = "ri-file-excel-line",
                ColorClass = "success",
                RequiresConfirmation = false
            },
            new BulkActionConfig
            {
                Text = "Activate Selected",
                ActionUrl = "/users/bulk-activate",
                IconClass = "ri-checkbox-circle-line",
                ColorClass = "primary",
                RequiresConfirmation = false
            }
        },

        // Create button
        CreateButtonText = "Create User",
        CreateButtonUrl = "#",

        // Pagination
        ShowPagination = true,
        CurrentPage = currentPage,
        TotalPages = totalPages,
        TotalRecords = totalRecords,
        PageSize = 10,

        // Sorting
        EnableSorting = true,

        // Table content with selection checkboxes
        TableContentRenderer = _ =>
        {
            var sb = new System.Text.StringBuilder();
            foreach (var user in users)
            {
                var statusColor = user.Status == "Active" ? "success" : "danger";
                var actionsHtml = rowActionsConfig.RenderActionsHtml(user.Id);

                sb.Append("<tr>");
                sb.Append($"<td><input type='checkbox' class='form-check-input row-select-checkbox' value='{user.Id}' /></td>");
                sb.Append($"<td>{user.Id}</td>");
                sb.Append($"<td><strong>{user.Name}</strong></td>");
                sb.Append($"<td>{user.Email}</td>");
                sb.Append($"<td><span class='badge bg-info-subtle text-info'>{user.Role}</span></td>");
                sb.Append($"<td>{user.Tenant}</td>");
                sb.Append($"<td><span class='badge bg-{statusColor}-subtle text-{statusColor}'>{user.Status}</span></td>");
                sb.Append($"<td>{actionsHtml}</td>");
                sb.Append("</tr>");
            }
            return new HtmlString(sb.ToString());
        }
    };

    var tableViewModel = config.BuildDataTable();
}

<div class="row">
    <div class="col-12">
        <partial name="~/Views/Shared/Components/DataTable/_DataTable.cshtml" model="tableViewModel" />
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success-subtle">
                <h5 class="card-title mb-0"><i class="ri-lightbulb-line"></i> How Bulk Actions Work</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li><strong>Select Rows:</strong> Click checkboxes to select individual rows, or use "Select All" checkbox in header</li>
                    <li><strong>Bulk Actions Appear:</strong> When 1+ rows are selected, a "Bulk Actions" dropdown appears showing selected count</li>
                    <li><strong>Choose Action:</strong> Select an action from the dropdown (Delete, Export, Activate, etc.)</li>
                    <li><strong>Confirmation:</strong> If action requires confirmation, a confirmation dialog appears</li>
                    <li><strong>Submit:</strong> Selected IDs are sent to the action URL via POST request</li>
                </ol>

                <hr>

                <p><strong>Configuration Code:</strong></p>
                <pre class="bg-light p-3 rounded" style="font-size: 0.85rem;"><code>// Configure row actions (using dropdown style for many actions)
var rowActionsConfig = new RowActionsConfig()
    .WithViewAction("#")
    .WithEditAction("#")
    .WithDeleteAction("#")
    .WithDuplicateAction("#")
    .WithDownloadAction("#")
    .AsDropdown("Actions");

// Configure bulk actions
var config = new DataTableConfig
@@{
    EnableBulkActions = true,
    BulkActions = new List&lt;BulkActionConfig&gt;
    @@{
        new BulkActionConfig
        @@{
            Text = "Delete Selected",
            ActionUrl = "/users/bulk-delete",
            IconClass = "ri-delete-bin-line",
            ColorClass = "danger",
            RequiresConfirmation = true,
            ConfirmationMessage = "Are you sure?"
        @@}
    @@},
    TableContentRenderer = _ =&gt;
    @@{
        var sb = new StringBuilder();
        foreach (var user in users)
        @@{
            var actionsHtml = rowActionsConfig.RenderActionsHtml(user.Id);
            sb.Append("&lt;tr&gt;");
            sb.Append("&lt;td&gt;&lt;input type='checkbox' value='" + user.Id + "' /&gt;&lt;/td&gt;");
            sb.Append("&lt;td&gt;" + user.Id + "&lt;/td&gt;");
            sb.Append("&lt;td&gt;" + user.Name + "&lt;/td&gt;");
            sb.Append("&lt;td&gt;" + actionsHtml + "&lt;/td&gt;");
            sb.Append("&lt;/tr&gt;");
        @@}
        return new HtmlString(sb.ToString());
    @@}
@@};</code></pre>

                <p class="mt-3"><strong>Controller Action (for handling bulk operations):</strong></p>
                <pre class="bg-light p-3 rounded" style="font-size: 0.85rem;"><code>[HttpPost]
public async Task&lt;IActionResult&gt; BulkDelete(List&lt;int&gt; ids)
{
    var users = await _context.Users.Where(u => ids.Contains(u.Id)).ToListAsync();
    _context.Users.RemoveRange(users);
    await _context.SaveChangesAsync();
    return RedirectToAction(nameof(Index));
}</code></pre>

                <div class="mt-3">
                    <h6>Navigation:</h6>
                    <div class="hstack gap-2">
                        <a href="/ComponentTest/DataTable" class="btn btn-primary btn-sm"><i class="ri-table-line"></i> View Standard DataTable</a>
                        <a href="/ComponentTest/StatCards" class="btn btn-secondary btn-sm"><i class="ri-dashboard-line"></i> View Stat Cards</a>
                        <a href="/" class="btn btn-secondary btn-sm"><i class="ri-home-line"></i> Back to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
